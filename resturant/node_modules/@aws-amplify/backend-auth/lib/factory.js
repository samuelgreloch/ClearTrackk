import * as path from 'path';
import { UserPoolOperation, } from 'aws-cdk-lib/aws-cognito';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { AmplifyAuth, } from '@aws-amplify/auth-construct';
import { translateToAuthConstructLoginWith, translateToAuthConstructSenders, } from './translate_auth_props.js';
import { authAccessBuilder as _authAccessBuilder } from './access_builder.js';
import { AuthAccessPolicyArbiterFactory } from './auth_access_policy_arbiter.js';
import { UserPoolAccessPolicyFactory } from './userpool_access_policy_factory.js';
import { Stack, Tags } from 'aws-cdk-lib';
/**
 * Singleton factory for AmplifyAuth that can be used in Amplify project files.
 *
 * Exported for testing purpose only & should NOT be exported out of the package.
 */
export class AmplifyAuthFactory {
    props;
    importStack;
    // publicly accessible for testing purpose only.
    static factoryCount = 0;
    provides = 'AuthResources';
    generator;
    /**
     * Set the properties that will be used to initialize AmplifyAuth
     */
    constructor(props, 
    // eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
    importStack = new Error().stack) {
        this.props = props;
        this.importStack = importStack;
        if (AmplifyAuthFactory.factoryCount > 0) {
            throw new AmplifyUserError('MultipleSingletonResourcesError', {
                message: 'Multiple `defineAuth` or `referenceAuth` calls are not allowed within an Amplify backend',
                resolution: 'Remove all but one `defineAuth` or `referenceAuth` call',
            });
        }
        AmplifyAuthFactory.factoryCount++;
    }
    /**
     * Get a singleton instance of AmplifyAuth
     */
    getInstance = (getInstanceProps) => {
        const { constructContainer, importPathVerifier, resourceNameValidator } = getInstanceProps;
        importPathVerifier?.verify(this.importStack, path.join('amplify', 'auth', 'resource'), 'Amplify Auth must be defined in amplify/auth/resource.ts');
        if (this.props.name) {
            resourceNameValidator?.validate(this.props.name);
        }
        if (!this.generator) {
            this.generator = new AmplifyAuthGenerator(this.props, getInstanceProps);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class AmplifyAuthGenerator {
    props;
    getInstanceProps;
    authAccessBuilder;
    authAccessPolicyArbiterFactory;
    resourceGroupName = 'auth';
    name;
    constructor(props, getInstanceProps, authAccessBuilder = _authAccessBuilder, authAccessPolicyArbiterFactory = new AuthAccessPolicyArbiterFactory()) {
        this.props = props;
        this.getInstanceProps = getInstanceProps;
        this.authAccessBuilder = authAccessBuilder;
        this.authAccessPolicyArbiterFactory = authAccessPolicyArbiterFactory;
        this.name = props.name ?? 'amplifyAuth';
    }
    generateContainerEntry = ({ scope, backendSecretResolver, ssmEnvironmentEntriesGenerator, stableBackendIdentifiers, }) => {
        const authProps = {
            ...this.props,
            loginWith: translateToAuthConstructLoginWith(this.props.loginWith, backendSecretResolver),
            senders: translateToAuthConstructSenders(this.props.senders, this.getInstanceProps),
            outputStorageStrategy: this.getInstanceProps.outputStorageStrategy,
        };
        if (authProps.loginWith.externalProviders) {
            authProps.loginWith.externalProviders.domainPrefix =
                stableBackendIdentifiers.getStableBackendHash();
        }
        let authConstruct;
        try {
            authConstruct = new AmplifyAuth(scope, this.name, authProps);
        }
        catch (error) {
            throw new AmplifyUserError('AmplifyAuthConstructInitializationError', {
                message: 'Failed to instantiate auth construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(authConstruct).add(TagName.FRIENDLY_NAME, this.name);
        Object.entries(this.props.triggers || {}).forEach(([triggerEvent, handlerFactory]) => {
            authConstruct.resources.userPool.addTrigger(UserPoolOperation.of(triggerEvent), handlerFactory.getInstance(this.getInstanceProps).resources.lambda);
        });
        const authConstructMixin = {
            ...authConstruct,
            /**
             * Returns a resourceAccessAcceptor for the given role
             * @param roleIdentifier Either the auth or unauth role name or the name of a UserPool group
             */
            getResourceAccessAcceptor: (roleIdentifier) => ({
                identifier: `${roleIdentifier}ResourceAccessAcceptor`,
                acceptResourceAccess: (policy) => {
                    const role = roleNameIsAuthRoleName(roleIdentifier)
                        ? authConstruct.resources[roleIdentifier]
                        : authConstruct.resources.groups?.[roleIdentifier]?.role;
                    if (!role) {
                        throw new AmplifyUserError('InvalidResourceAccessConfigError', {
                            message: `No auth IAM role found for "${roleIdentifier}".`,
                            resolution: `If you are trying to configure UserPool group access, ensure that the group name is specified correctly.`,
                        });
                    }
                    policy.attachToRole(role);
                },
            }),
            stack: Stack.of(authConstruct),
        };
        if (!this.props.access) {
            return authConstructMixin;
        }
        // props.access is the access callback defined by the customer
        // here we inject the authAccessBuilder into the callback and run it
        // this produces the access definition that will be used to create the auth access policies
        const accessDefinition = this.props.access(this.authAccessBuilder);
        const ssmEnvironmentEntries = ssmEnvironmentEntriesGenerator.generateSsmEnvironmentEntries({
            [`${this.name}_USERPOOL_ID`]: authConstructMixin.resources.userPool.userPoolId,
        });
        const authPolicyArbiter = this.authAccessPolicyArbiterFactory.getInstance(accessDefinition, this.getInstanceProps, ssmEnvironmentEntries, new UserPoolAccessPolicyFactory(authConstruct.resources.userPool));
        authPolicyArbiter.arbitratePolicies();
        return authConstructMixin;
    };
}
const roleNameIsAuthRoleName = (roleName) => {
    return (roleName === 'authenticatedUserIamRole' ||
        roleName === 'unauthenticatedUserIamRole');
};
/**
 * Provide the settings that will be used for authentication.
 */
export const defineAuth = (props) => 
// eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
new AmplifyAuthFactory(props, new Error().stack);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBRTdCLE9BQU8sRUFFTCxpQkFBaUIsR0FFbEIsTUFBTSx5QkFBeUIsQ0FBQztBQUNqQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDdkUsT0FBTyxFQUNMLFdBQVcsR0FJWixNQUFNLDZCQUE2QixDQUFDO0FBZXJDLE9BQU8sRUFDTCxpQ0FBaUMsRUFDakMsK0JBQStCLEdBQ2hDLE1BQU0sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUFFLGlCQUFpQixJQUFJLGtCQUFrQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFRakYsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDbEYsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUEyQzFDOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sa0JBQWtCO0lBWVY7SUFFQTtJQWJuQixnREFBZ0Q7SUFDaEQsTUFBTSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUM7SUFFZixRQUFRLEdBQUcsZUFBZSxDQUFDO0lBRTVCLFNBQVMsQ0FBbUM7SUFFcEQ7O09BRUc7SUFDSCxZQUNtQixLQUF1QjtJQUN4Qyx1RUFBdUU7SUFDdEQsY0FBYyxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUs7UUFGL0IsVUFBSyxHQUFMLEtBQUssQ0FBa0I7UUFFdkIsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBRWhELElBQUksa0JBQWtCLENBQUMsWUFBWSxHQUFHLENBQUMsRUFBRTtZQUN2QyxNQUFNLElBQUksZ0JBQWdCLENBQUMsaUNBQWlDLEVBQUU7Z0JBQzVE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OlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFBvbGljeSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHtcbiAgVXNlclBvb2wsXG4gIFVzZXJQb29sT3BlcmF0aW9uLFxuICBVc2VyUG9vbFNFU09wdGlvbnMsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1jb2duaXRvJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IsIFRhZ05hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBBbXBsaWZ5QXV0aCxcbiAgQXV0aFByb3BzLFxuICBUcmlnZ2VyRXZlbnQsXG4gIFVzZXJQb29sU25zT3B0aW9ucyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2F1dGgtY29uc3RydWN0JztcbmltcG9ydCB7XG4gIEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSxcbiAgQXV0aFJlc291cmNlcyxcbiAgQXV0aFJvbGVOYW1lLFxuICBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcixcbiAgQ29uc3RydWN0RmFjdG9yeSxcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIEZ1bmN0aW9uUmVzb3VyY2VzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3IsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5LFxuICBSZXNvdXJjZVByb3ZpZGVyLFxuICBTdGFja1Byb3ZpZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIHRyYW5zbGF0ZVRvQXV0aENvbnN0cnVjdExvZ2luV2l0aCxcbiAgdHJhbnNsYXRlVG9BdXRoQ29uc3RydWN0U2VuZGVycyxcbn0gZnJvbSAnLi90cmFuc2xhdGVfYXV0aF9wcm9wcy5qcyc7XG5pbXBvcnQgeyBhdXRoQWNjZXNzQnVpbGRlciBhcyBfYXV0aEFjY2Vzc0J1aWxkZXIgfSBmcm9tICcuL2FjY2Vzc19idWlsZGVyLmpzJztcbmltcG9ydCB7IEF1dGhBY2Nlc3NQb2xpY3lBcmJpdGVyRmFjdG9yeSB9IGZyb20gJy4vYXV0aF9hY2Nlc3NfcG9saWN5X2FyYml0ZXIuanMnO1xuaW1wb3J0IHtcbiAgQXV0aEFjY2Vzc0dlbmVyYXRvcixcbiAgQXV0aExvZ2luV2l0aEZhY3RvcnlQcm9wcyxcbiAgQ3VzdG9tRW1haWxTZW5kZXIsXG4gIEN1c3RvbVNtc1NlbmRlcixcbiAgRXhwYW5kLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IFVzZXJQb29sQWNjZXNzUG9saWN5RmFjdG9yeSB9IGZyb20gJy4vdXNlcnBvb2xfYWNjZXNzX3BvbGljeV9mYWN0b3J5LmpzJztcbmltcG9ydCB7IFN0YWNrLCBUYWdzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuXG5leHBvcnQgdHlwZSBCYWNrZW5kQXV0aCA9IFJlc291cmNlUHJvdmlkZXI8QXV0aFJlc291cmNlcz4gJlxuICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yRmFjdG9yeTxBdXRoUm9sZU5hbWUgfCBzdHJpbmc+ICZcbiAgU3RhY2tQcm92aWRlcjtcblxuZXhwb3J0IHR5cGUgQW1wbGlmeUF1dGhQcm9wcyA9IEV4cGFuZDxcbiAgT21pdDxBdXRoUHJvcHMsICdvdXRwdXRTdG9yYWdlU3RyYXRlZ3knIHwgJ2xvZ2luV2l0aCcgfCAnc2VuZGVycyc+ICYge1xuICAgIC8qKlxuICAgICAqIFNwZWNpZnkgaG93IHlvdSB3b3VsZCBsaWtlIHVzZXJzIHRvIGxvZyBpbi4gWW91IGNhbiBjaG9vc2UgZnJvbSBlbWFpbCwgcGhvbmUsIGFuZCBldmVuIGV4dGVybmFsIHByb3ZpZGVycyBzdWNoIGFzIExvZ2luV2l0aEFtYXpvbi5cbiAgICAgKi9cbiAgICBsb2dpbldpdGg6IEV4cGFuZDxBdXRoTG9naW5XaXRoRmFjdG9yeVByb3BzPjtcbiAgICAvKipcbiAgICAgKiBDb25maWd1cmUgY3VzdG9tIGF1dGggdHJpZ2dlcnNcbiAgICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvYXV0aC9jdXN0b21pemUtYXV0aC1saWZlY3ljbGUvdHJpZ2dlcnMvXG4gICAgICovXG4gICAgdHJpZ2dlcnM/OiBQYXJ0aWFsPFxuICAgICAgUmVjb3JkPFxuICAgICAgICBUcmlnZ2VyRXZlbnQsXG4gICAgICAgIENvbnN0cnVjdEZhY3Rvcnk8UmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4+XG4gICAgICA+XG4gICAgPjtcbiAgICAvKipcbiAgICAgKiBDb25maWd1cmUgYWNjZXNzIHRvIGF1dGggZm9yIG90aGVyIEFtcGxpZnkgcmVzb3VyY2VzXG4gICAgICogQHNlZSBodHRwczovL2RvY3MuYW1wbGlmeS5hd3MvcmVhY3QvYnVpbGQtYS1iYWNrZW5kL2F1dGgvZ3JhbnQtYWNjZXNzLXRvLWF1dGgtcmVzb3VyY2VzL1xuICAgICAqIEBleGFtcGxlXG4gICAgICogYWNjZXNzOiAoYWxsb3cpID0+IFthbGxvdy5yZXNvdXJjZShwb3N0Q29uZmlybWF0aW9uKS50byhbXCJhZGRVc2VyVG9Hcm91cFwiXSldXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBhY2Nlc3M6IChhbGxvdykgPT4gW2FsbG93LnJlc291cmNlKGdyb3VwTWFuYWdlcikudG8oW1wibWFuYWdlR3JvdXBzXCJdKV1cbiAgICAgKi9cbiAgICBhY2Nlc3M/OiBBdXRoQWNjZXNzR2VuZXJhdG9yO1xuICAgIC8qKlxuICAgICAqIENvbmZpZ3VyZSBlbWFpbCBzZW5kZXIgb3B0aW9uc1xuICAgICAqL1xuICAgIHNlbmRlcnM/OiB7XG4gICAgICBlbWFpbD86XG4gICAgICAgIHwgUGljazxVc2VyUG9vbFNFU09wdGlvbnMsICdmcm9tRW1haWwnIHwgJ2Zyb21OYW1lJyB8ICdyZXBseVRvJz5cbiAgICAgICAgfCBDdXN0b21FbWFpbFNlbmRlcjtcbiAgICAgIHNtcz86IFVzZXJQb29sU25zT3B0aW9ucyB8IEN1c3RvbVNtc1NlbmRlcjtcbiAgICB9O1xuICB9XG4+O1xuXG4vKipcbiAqIFNpbmdsZXRvbiBmYWN0b3J5IGZvciBBbXBsaWZ5QXV0aCB0aGF0IGNhbiBiZSB1c2VkIGluIEFtcGxpZnkgcHJvamVjdCBmaWxlcy5cbiAqXG4gKiBFeHBvcnRlZCBmb3IgdGVzdGluZyBwdXJwb3NlIG9ubHkgJiBzaG91bGQgTk9UIGJlIGV4cG9ydGVkIG91dCBvZiB0aGUgcGFja2FnZS5cbiAqL1xuZXhwb3J0IGNsYXNzIEFtcGxpZnlBdXRoRmFjdG9yeSBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QmFja2VuZEF1dGg+IHtcbiAgLy8gcHVibGljbHkgYWNjZXNzaWJsZSBmb3IgdGVzdGluZyBwdXJwb3NlIG9ubHkuXG4gIHN0YXRpYyBmYWN0b3J5Q291bnQgPSAwO1xuXG4gIHJlYWRvbmx5IHByb3ZpZGVzID0gJ0F1dGhSZXNvdXJjZXMnO1xuXG4gIHByaXZhdGUgZ2VuZXJhdG9yOiBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcjtcblxuICAvKipcbiAgICogU2V0IHRoZSBwcm9wZXJ0aWVzIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGluaXRpYWxpemUgQW1wbGlmeUF1dGhcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEFtcGxpZnlBdXRoUHJvcHMsXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGFtcGxpZnktYmFja2VuZC1ydWxlcy9wcmVmZXItYW1wbGlmeS1lcnJvcnNcbiAgICBwcml2YXRlIHJlYWRvbmx5IGltcG9ydFN0YWNrID0gbmV3IEVycm9yKCkuc3RhY2tcbiAgKSB7XG4gICAgaWYgKEFtcGxpZnlBdXRoRmFjdG9yeS5mYWN0b3J5Q291bnQgPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignTXVsdGlwbGVTaW5nbGV0b25SZXNvdXJjZXNFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAnTXVsdGlwbGUgYGRlZmluZUF1dGhgIG9yIGByZWZlcmVuY2VBdXRoYCBjYWxscyBhcmUgbm90IGFsbG93ZWQgd2l0aGluIGFuIEFtcGxpZnkgYmFja2VuZCcsXG4gICAgICAgIHJlc29sdXRpb246ICdSZW1vdmUgYWxsIGJ1dCBvbmUgYGRlZmluZUF1dGhgIG9yIGByZWZlcmVuY2VBdXRoYCBjYWxsJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBBbXBsaWZ5QXV0aEZhY3RvcnkuZmFjdG9yeUNvdW50Kys7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgc2luZ2xldG9uIGluc3RhbmNlIG9mIEFtcGxpZnlBdXRoXG4gICAqL1xuICBnZXRJbnN0YW5jZSA9IChcbiAgICBnZXRJbnN0YW5jZVByb3BzOiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wc1xuICApOiBCYWNrZW5kQXV0aCA9PiB7XG4gICAgY29uc3QgeyBjb25zdHJ1Y3RDb250YWluZXIsIGltcG9ydFBhdGhWZXJpZmllciwgcmVzb3VyY2VOYW1lVmFsaWRhdG9yIH0gPVxuICAgICAgZ2V0SW5zdGFuY2VQcm9wcztcbiAgICBpbXBvcnRQYXRoVmVyaWZpZXI/LnZlcmlmeShcbiAgICAgIHRoaXMuaW1wb3J0U3RhY2ssXG4gICAgICBwYXRoLmpvaW4oJ2FtcGxpZnknLCAnYXV0aCcsICdyZXNvdXJjZScpLFxuICAgICAgJ0FtcGxpZnkgQXV0aCBtdXN0IGJlIGRlZmluZWQgaW4gYW1wbGlmeS9hdXRoL3Jlc291cmNlLnRzJ1xuICAgICk7XG4gICAgaWYgKHRoaXMucHJvcHMubmFtZSkge1xuICAgICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yPy52YWxpZGF0ZSh0aGlzLnByb3BzLm5hbWUpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuZ2VuZXJhdG9yKSB7XG4gICAgICB0aGlzLmdlbmVyYXRvciA9IG5ldyBBbXBsaWZ5QXV0aEdlbmVyYXRvcih0aGlzLnByb3BzLCBnZXRJbnN0YW5jZVByb3BzKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnN0cnVjdENvbnRhaW5lci5nZXRPckNvbXB1dGUodGhpcy5nZW5lcmF0b3IpIGFzIEJhY2tlbmRBdXRoO1xuICB9O1xufVxuXG5jbGFzcyBBbXBsaWZ5QXV0aEdlbmVyYXRvciBpbXBsZW1lbnRzIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yIHtcbiAgcmVhZG9ubHkgcmVzb3VyY2VHcm91cE5hbWU6IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSA9ICdhdXRoJztcbiAgcHJpdmF0ZSByZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogQW1wbGlmeUF1dGhQcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXV0aEFjY2Vzc0J1aWxkZXIgPSBfYXV0aEFjY2Vzc0J1aWxkZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdXRoQWNjZXNzUG9saWN5QXJiaXRlckZhY3RvcnkgPSBuZXcgQXV0aEFjY2Vzc1BvbGljeUFyYml0ZXJGYWN0b3J5KClcbiAgKSB7XG4gICAgdGhpcy5uYW1lID0gcHJvcHMubmFtZSA/PyAnYW1wbGlmeUF1dGgnO1xuICB9XG5cbiAgZ2VuZXJhdGVDb250YWluZXJFbnRyeSA9ICh7XG4gICAgc2NvcGUsXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIHNzbUVudmlyb25tZW50RW50cmllc0dlbmVyYXRvcixcbiAgICBzdGFibGVCYWNrZW5kSWRlbnRpZmllcnMsXG4gIH06IEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcykgPT4ge1xuICAgIGNvbnN0IGF1dGhQcm9wczogQXV0aFByb3BzID0ge1xuICAgICAgLi4udGhpcy5wcm9wcyxcbiAgICAgIGxvZ2luV2l0aDogdHJhbnNsYXRlVG9BdXRoQ29uc3RydWN0TG9naW5XaXRoKFxuICAgICAgICB0aGlzLnByb3BzLmxvZ2luV2l0aCxcbiAgICAgICAgYmFja2VuZFNlY3JldFJlc29sdmVyXG4gICAgICApLFxuICAgICAgc2VuZGVyczogdHJhbnNsYXRlVG9BdXRoQ29uc3RydWN0U2VuZGVycyhcbiAgICAgICAgdGhpcy5wcm9wcy5zZW5kZXJzLFxuICAgICAgICB0aGlzLmdldEluc3RhbmNlUHJvcHNcbiAgICAgICksXG4gICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IHRoaXMuZ2V0SW5zdGFuY2VQcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gICAgfTtcbiAgICBpZiAoYXV0aFByb3BzLmxvZ2luV2l0aC5leHRlcm5hbFByb3ZpZGVycykge1xuICAgICAgYXV0aFByb3BzLmxvZ2luV2l0aC5leHRlcm5hbFByb3ZpZGVycy5kb21haW5QcmVmaXggPVxuICAgICAgICBzdGFibGVCYWNrZW5kSWRlbnRpZmllcnMuZ2V0U3RhYmxlQmFja2VuZEhhc2goKTtcbiAgICB9XG5cbiAgICBsZXQgYXV0aENvbnN0cnVjdDogQW1wbGlmeUF1dGg7XG4gICAgdHJ5IHtcbiAgICAgIGF1dGhDb25zdHJ1Y3QgPSBuZXcgQW1wbGlmeUF1dGgoc2NvcGUsIHRoaXMubmFtZSwgYXV0aFByb3BzKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdBbXBsaWZ5QXV0aENvbnN0cnVjdEluaXRpYWxpemF0aW9uRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBpbnN0YW50aWF0ZSBhdXRoIGNvbnN0cnVjdCcsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3JcbiAgICAgICk7XG4gICAgfVxuXG4gICAgVGFncy5vZihhdXRoQ29uc3RydWN0KS5hZGQoVGFnTmFtZS5GUklFTkRMWV9OQU1FLCB0aGlzLm5hbWUpO1xuXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy50cmlnZ2VycyB8fCB7fSkuZm9yRWFjaChcbiAgICAgIChbdHJpZ2dlckV2ZW50LCBoYW5kbGVyRmFjdG9yeV0pID0+IHtcbiAgICAgICAgKGF1dGhDb25zdHJ1Y3QucmVzb3VyY2VzLnVzZXJQb29sIGFzIFVzZXJQb29sKS5hZGRUcmlnZ2VyKFxuICAgICAgICAgIFVzZXJQb29sT3BlcmF0aW9uLm9mKHRyaWdnZXJFdmVudCksXG4gICAgICAgICAgaGFuZGxlckZhY3RvcnkuZ2V0SW5zdGFuY2UodGhpcy5nZXRJbnN0YW5jZVByb3BzKS5yZXNvdXJjZXMubGFtYmRhXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgKTtcblxuICAgIGNvbnN0IGF1dGhDb25zdHJ1Y3RNaXhpbjogQmFja2VuZEF1dGggPSB7XG4gICAgICAuLi5hdXRoQ29uc3RydWN0LFxuICAgICAgLyoqXG4gICAgICAgKiBSZXR1cm5zIGEgcmVzb3VyY2VBY2Nlc3NBY2NlcHRvciBmb3IgdGhlIGdpdmVuIHJvbGVcbiAgICAgICAqIEBwYXJhbSByb2xlSWRlbnRpZmllciBFaXRoZXIgdGhlIGF1dGggb3IgdW5hdXRoIHJvbGUgbmFtZSBvciB0aGUgbmFtZSBvZiBhIFVzZXJQb29sIGdyb3VwXG4gICAgICAgKi9cbiAgICAgIGdldFJlc291cmNlQWNjZXNzQWNjZXB0b3I6IChcbiAgICAgICAgcm9sZUlkZW50aWZpZXI6IEF1dGhSb2xlTmFtZSB8IHN0cmluZ1xuICAgICAgKTogUmVzb3VyY2VBY2Nlc3NBY2NlcHRvciA9PiAoe1xuICAgICAgICBpZGVudGlmaWVyOiBgJHtyb2xlSWRlbnRpZmllcn1SZXNvdXJjZUFjY2Vzc0FjY2VwdG9yYCxcbiAgICAgICAgYWNjZXB0UmVzb3VyY2VBY2Nlc3M6IChwb2xpY3k6IFBvbGljeSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJvbGUgPSByb2xlTmFtZUlzQXV0aFJvbGVOYW1lKHJvbGVJZGVudGlmaWVyKVxuICAgICAgICAgICAgPyBhdXRoQ29uc3RydWN0LnJlc291cmNlc1tyb2xlSWRlbnRpZmllcl1cbiAgICAgICAgICAgIDogYXV0aENvbnN0cnVjdC5yZXNvdXJjZXMuZ3JvdXBzPy5bcm9sZUlkZW50aWZpZXJdPy5yb2xlO1xuICAgICAgICAgIGlmICghcm9sZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRSZXNvdXJjZUFjY2Vzc0NvbmZpZ0Vycm9yJywge1xuICAgICAgICAgICAgICBtZXNzYWdlOiBgTm8gYXV0aCBJQU0gcm9sZSBmb3VuZCBmb3IgXCIke3JvbGVJZGVudGlmaWVyfVwiLmAsXG4gICAgICAgICAgICAgIHJlc29sdXRpb246IGBJZiB5b3UgYXJlIHRyeWluZyB0byBjb25maWd1cmUgVXNlclBvb2wgZ3JvdXAgYWNjZXNzLCBlbnN1cmUgdGhhdCB0aGUgZ3JvdXAgbmFtZSBpcyBzcGVjaWZpZWQgY29ycmVjdGx5LmAsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcG9saWN5LmF0dGFjaFRvUm9sZShyb2xlKTtcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAgc3RhY2s6IFN0YWNrLm9mKGF1dGhDb25zdHJ1Y3QpLFxuICAgIH07XG4gICAgaWYgKCF0aGlzLnByb3BzLmFjY2Vzcykge1xuICAgICAgcmV0dXJuIGF1dGhDb25zdHJ1Y3RNaXhpbjtcbiAgICB9XG4gICAgLy8gcHJvcHMuYWNjZXNzIGlzIHRoZSBhY2Nlc3MgY2FsbGJhY2sgZGVmaW5lZCBieSB0aGUgY3VzdG9tZXJcbiAgICAvLyBoZXJlIHdlIGluamVjdCB0aGUgYXV0aEFjY2Vzc0J1aWxkZXIgaW50byB0aGUgY2FsbGJhY2sgYW5kIHJ1biBpdFxuICAgIC8vIHRoaXMgcHJvZHVjZXMgdGhlIGFjY2VzcyBkZWZpbml0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGNyZWF0ZSB0aGUgYXV0aCBhY2Nlc3MgcG9saWNpZXNcbiAgICBjb25zdCBhY2Nlc3NEZWZpbml0aW9uID0gdGhpcy5wcm9wcy5hY2Nlc3ModGhpcy5hdXRoQWNjZXNzQnVpbGRlcik7XG5cbiAgICBjb25zdCBzc21FbnZpcm9ubWVudEVudHJpZXMgPVxuICAgICAgc3NtRW52aXJvbm1lbnRFbnRyaWVzR2VuZXJhdG9yLmdlbmVyYXRlU3NtRW52aXJvbm1lbnRFbnRyaWVzKHtcbiAgICAgICAgW2Ake3RoaXMubmFtZX1fVVNFUlBPT0xfSURgXTpcbiAgICAgICAgICBhdXRoQ29uc3RydWN0TWl4aW4ucmVzb3VyY2VzLnVzZXJQb29sLnVzZXJQb29sSWQsXG4gICAgICB9KTtcblxuICAgIGNvbnN0IGF1dGhQb2xpY3lBcmJpdGVyID0gdGhpcy5hdXRoQWNjZXNzUG9saWN5QXJiaXRlckZhY3RvcnkuZ2V0SW5zdGFuY2UoXG4gICAgICBhY2Nlc3NEZWZpbml0aW9uLFxuICAgICAgdGhpcy5nZXRJbnN0YW5jZVByb3BzLFxuICAgICAgc3NtRW52aXJvbm1lbnRFbnRyaWVzLFxuICAgICAgbmV3IFVzZXJQb29sQWNjZXNzUG9saWN5RmFjdG9yeShhdXRoQ29uc3RydWN0LnJlc291cmNlcy51c2VyUG9vbClcbiAgICApO1xuXG4gICAgYXV0aFBvbGljeUFyYml0ZXIuYXJiaXRyYXRlUG9saWNpZXMoKTtcblxuICAgIHJldHVybiBhdXRoQ29uc3RydWN0TWl4aW47XG4gIH07XG59XG5cbmNvbnN0IHJvbGVOYW1lSXNBdXRoUm9sZU5hbWUgPSAocm9sZU5hbWU6IHN0cmluZyk6IHJvbGVOYW1lIGlzIEF1dGhSb2xlTmFtZSA9PiB7XG4gIHJldHVybiAoXG4gICAgcm9sZU5hbWUgPT09ICdhdXRoZW50aWNhdGVkVXNlcklhbVJvbGUnIHx8XG4gICAgcm9sZU5hbWUgPT09ICd1bmF1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZSdcbiAgKTtcbn07XG5cbi8qKlxuICogUHJvdmlkZSB0aGUgc2V0dGluZ3MgdGhhdCB3aWxsIGJlIHVzZWQgZm9yIGF1dGhlbnRpY2F0aW9uLlxuICovXG5leHBvcnQgY29uc3QgZGVmaW5lQXV0aCA9IChcbiAgcHJvcHM6IEFtcGxpZnlBdXRoUHJvcHNcbik6IENvbnN0cnVjdEZhY3Rvcnk8QmFja2VuZEF1dGg+ID0+XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBhbXBsaWZ5LWJhY2tlbmQtcnVsZXMvcHJlZmVyLWFtcGxpZnktZXJyb3JzXG4gIG5ldyBBbXBsaWZ5QXV0aEZhY3RvcnkocHJvcHMsIG5ldyBFcnJvcigpLnN0YWNrKTtcbiJdfQ==