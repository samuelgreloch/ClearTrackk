import { EmptySchemaError, InvalidSchemaError, TypescriptDataSchemaGenerator, } from '@aws-amplify/graphql-schema-generator';
import fs from 'fs/promises';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Schema generator class.
 */
export class SchemaGenerator {
    generate = async (props) => {
        const dbConfig = parseDatabaseUrl(props.connectionUri.value);
        try {
            const schema = await TypescriptDataSchemaGenerator.generate({
                ...dbConfig,
                connectionUriSecretName: props.connectionUri.secretName,
                ...(props.sslCert &&
                    props.sslCert.secretName && {
                    sslCertificateSecretName: props.sslCert.secretName,
                    sslCertificate: props.sslCert.value,
                }),
            });
            await fs.writeFile(props.out, schema);
        }
        catch (err) {
            if (err instanceof EmptySchemaError ||
                err instanceof InvalidSchemaError) {
                throw new AmplifyUserError('DatabaseSchemaError', {
                    // the message already contains descriptive error.
                    message: err.message,
                    resolution: 'Check the database schema.',
                }, err);
            }
            const databaseError = err;
            if (databaseError.code === 'ETIMEDOUT') {
                throw new AmplifyUserError('DatabaseConnectionError', {
                    message: `Unable to connect to the database at ${dbConfig.host}:${dbConfig.port}. `,
                    resolution: 'Check if the credentials are correct. Also, check if the database is running and accessible from the network.',
                }, databaseError);
            }
            throw err;
        }
    };
}
const DEFAULT_ENGINE = 'mysql';
/**
 * Error for database connection failures.
 * This class is intended to be used for casting database connection errors.
 * Do not create instances of this class directly.
 */
class DatabaseConnectError extends Error {
    code;
    /**
     * Creates database connection error.
     */
    constructor(code) {
        super(`Database connection error: ${code}`);
        this.code = code;
    }
}
/**
 * Parses database URL into a configuration object.
 */
export const parseDatabaseUrl = (databaseUrl) => {
    try {
        const parsedDatabaseUrl = new URL(databaseUrl);
        const { username: encodedUsername, password: encodedPassword, hostname: encodedHost, } = parsedDatabaseUrl;
        const username = decodeURIComponent(encodedUsername);
        const password = decodeURIComponent(encodedPassword);
        const host = decodeURIComponent(encodedHost);
        const database = decodeURIComponent(parsedDatabaseUrl?.pathname?.slice(1));
        // Default engine is MySQL
        const engine = constructDBEngine(parsedDatabaseUrl?.protocol?.slice(0, -1) ?? DEFAULT_ENGINE);
        const port = parsedDatabaseUrl?.port
            ? parseInt(parsedDatabaseUrl?.port, 10)
            : getDefaultPort(engine);
        const config = {
            engine,
            username,
            password,
            database,
            host,
            port,
        };
        const missingParts = Object.keys(config).filter((part) => !config[part]);
        if (missingParts.length > 0) {
            throw new AmplifyUserError('DatabaseUrlParseError', {
                message: `One or more parts of the database URL is missing. Missing [${missingParts.join(', ')}].`,
                resolution: 'Ensure the database URL follows the pattern "[mysql|postgresql]://username:password@hostname:port/database".',
            });
        }
        return config;
    }
    catch (err) {
        const error = err;
        throw new AmplifyUserError('DatabaseUrlParseError', {
            message: `Unable to parse the database URL. ${error.message}`,
            resolution: 'Check if the database URL is correct and accessible.',
        }, error);
    }
};
const constructDBEngine = (engine) => {
    switch (engine) {
        case 'mysql':
            return 'mysql';
        case 'postgresql':
        case 'postgres':
            return 'postgresql';
        default:
            throw new AmplifyUserError('DatabaseUnsupportedEngineError', {
                message: `Unsupported database engine: ${engine}`,
                resolution: 'Ensure that database URL specifies supported engine. Supported engines are "mysql", "postgresql", "postgres".',
            });
    }
};
const getDefaultPort = (engine) => {
    switch (engine) {
        case 'mysql':
            return 3306;
        case 'postgresql':
            return 5432;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfc2NoZW1hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2dlbmVyYXRlX3NjaGVtYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLGtCQUFrQixFQUNsQiw2QkFBNkIsR0FDOUIsTUFBTSx1Q0FBdUMsQ0FBQztBQUMvQyxPQUFPLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDN0IsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFvQjlEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGVBQWU7SUFDMUIsUUFBUSxHQUFHLEtBQUssRUFBRSxLQUE0QixFQUFFLEVBQUU7UUFDaEQsTUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3RCxJQUFJO1lBQ0YsTUFBTSxNQUFNLEdBQUcsTUFBTSw2QkFBNkIsQ0FBQyxRQUFRLENBQUM7Z0JBQzFELEdBQUcsUUFBUTtnQkFDWCx1QkFBdUIsRUFBRSxLQUFLLENBQUMsYUFBYSxDQUFDLFVBQVU7Z0JBQ3ZELEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTztvQkFDZixLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSTtvQkFDMUIsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVO29CQUNsRCxjQUFjLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLO2lCQUNwQyxDQUFDO2FBQ0wsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDdkM7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLElBQ0UsR0FBRyxZQUFZLGdCQUFnQjtnQkFDL0IsR0FBRyxZQUFZLGtCQUFrQixFQUNqQztnQkFDQSxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLHFCQUFxQixFQUNyQjtv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RUFDdkI7WUFDRSxPQUFPLEVBQUUscUNBQXFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDN0QsVUFBVSxFQUFFLHNEQUFzRDtTQUNuRSxFQUNELEtBQUssQ0FDTixDQUFDO0tBQ0g7QUFDSCxDQUFDLENBQUM7QUFFRixNQUFNLGlCQUFpQixHQUFHLENBQUMsTUFBYyxFQUFhLEVBQUU7SUFDdEQsUUFBUSxNQUFNLEVBQUU7UUFDZCxLQUFLLE9BQU87WUFDVixPQUFPLE9BQU8sQ0FBQztRQUNqQixLQUFLLFlBQVksQ0FBQztRQUNsQixLQUFLLFVBQVU7WUFDYixPQUFPLFlBQVksQ0FBQztRQUN0QjtZQUNFLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsZ0NBQWdDLEVBQ2hDO2dCQUNFLE9BQU8sRUFBRSxnQ0FBZ0MsTUFBTSxFQUFFO2dCQUNqRCxVQUFVLEVBQ1IsK0dBQStHO2FBQ2xILENBQ0YsQ0FBQztLQUNMO0FBQ0gsQ0FBQyxDQUFDO0FBRUYsTUFBTSxjQUFjLEdBQUcsQ0FBQyxNQUFpQixFQUFVLEVBQUU7SUFDbkQsUUFBUSxNQUFNLEVBQUU7UUFDZCxLQUFLLE9BQU87WUFDVixPQUFPLElBQUksQ0FBQztRQUNkLEtBQUssWUFBWTtZQUNmLE9BQU8sSUFBSSxDQUFDO0tBQ2Y7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBFbXB0eVNjaGVtYUVycm9yLFxuICBJbnZhbGlkU2NoZW1hRXJyb3IsXG4gIFR5cGVzY3JpcHREYXRhU2NoZW1hR2VuZXJhdG9yLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvZ3JhcGhxbC1zY2hlbWEtZ2VuZXJhdG9yJztcbmltcG9ydCBmcyBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgeyBBbXBsaWZ5VXNlckVycm9yIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuXG5leHBvcnQgdHlwZSBTY2hlbWFHZW5lcmF0b3JDb25maWcgPSB7XG4gIGNvbm5lY3Rpb25Vcmk6IHtcbiAgICBzZWNyZXROYW1lOiBzdHJpbmc7XG4gICAgdmFsdWU6IHN0cmluZztcbiAgfTtcbiAgc3NsQ2VydD86IHtcbiAgICBzZWNyZXROYW1lOiBzdHJpbmc7XG4gICAgdmFsdWU6IHN0cmluZztcbiAgfTtcbiAgb3V0OiBzdHJpbmc7XG59O1xuXG50eXBlIEFtcGxpZnlHZW5lcmF0ZVNjaGVtYUVycm9yID1cbiAgfCAnRGF0YWJhc2VDb25uZWN0aW9uRXJyb3InXG4gIHwgJ0RhdGFiYXNlU2NoZW1hRXJyb3InXG4gIHwgJ0RhdGFiYXNlVW5zdXBwb3J0ZWRFbmdpbmVFcnJvcidcbiAgfCAnRGF0YWJhc2VVcmxQYXJzZUVycm9yJztcblxuLyoqXG4gKiBTY2hlbWEgZ2VuZXJhdG9yIGNsYXNzLlxuICovXG5leHBvcnQgY2xhc3MgU2NoZW1hR2VuZXJhdG9yIHtcbiAgZ2VuZXJhdGUgPSBhc3luYyAocHJvcHM6IFNjaGVtYUdlbmVyYXRvckNvbmZpZykgPT4ge1xuICAgIGNvbnN0IGRiQ29uZmlnID0gcGFyc2VEYXRhYmFzZVVybChwcm9wcy5jb25uZWN0aW9uVXJpLnZhbHVlKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzY2hlbWEgPSBhd2FpdCBUeXBlc2NyaXB0RGF0YVNjaGVtYUdlbmVyYXRvci5nZW5lcmF0ZSh7XG4gICAgICAgIC4uLmRiQ29uZmlnLFxuICAgICAgICBjb25uZWN0aW9uVXJpU2VjcmV0TmFtZTogcHJvcHMuY29ubmVjdGlvblVyaS5zZWNyZXROYW1lLFxuICAgICAgICAuLi4ocHJvcHMuc3NsQ2VydCAmJlxuICAgICAgICAgIHByb3BzLnNzbENlcnQuc2VjcmV0TmFtZSAmJiB7XG4gICAgICAgICAgICBzc2xDZXJ0aWZpY2F0ZVNlY3JldE5hbWU6IHByb3BzLnNzbENlcnQuc2VjcmV0TmFtZSxcbiAgICAgICAgICAgIHNzbENlcnRpZmljYXRlOiBwcm9wcy5zc2xDZXJ0LnZhbHVlLFxuICAgICAgICAgIH0pLFxuICAgICAgfSk7XG4gICAgICBhd2FpdCBmcy53cml0ZUZpbGUocHJvcHMub3V0LCBzY2hlbWEpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKFxuICAgICAgICBlcnIgaW5zdGFuY2VvZiBFbXB0eVNjaGVtYUVycm9yIHx8XG4gICAgICAgIGVyciBpbnN0YW5jZW9mIEludmFsaWRTY2hlbWFFcnJvclxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlHZW5lcmF0ZVNjaGVtYUVycm9yPihcbiAgICAgICAgICAnRGF0YWJhc2VTY2hlbWFFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgLy8gdGhlIG1lc3NhZ2UgYWxyZWFkeSBjb250YWlucyBkZXNjcmlwdGl2ZSBlcnJvci5cbiAgICAgICAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjogJ0NoZWNrIHRoZSBkYXRhYmFzZSBzY2hlbWEuJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVyclxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgY29uc3QgZGF0YWJhc2VFcnJvciA9IGVyciBhcyBEYXRhYmFzZUNvbm5lY3RFcnJvcjtcbiAgICAgIGlmIChkYXRhYmFzZUVycm9yLmNvZGUgPT09ICdFVElNRURPVVQnKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlHZW5lcmF0ZVNjaGVtYUVycm9yPihcbiAgICAgICAgICAnRGF0YWJhc2VDb25uZWN0aW9uRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBVbmFibGUgdG8gY29ubmVjdCB0byB0aGUgZGF0YWJhc2UgYXQgJHtkYkNvbmZpZy5ob3N0fToke2RiQ29uZmlnLnBvcnR9LiBgLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgJ0NoZWNrIGlmIHRoZSBjcmVkZW50aWFscyBhcmUgY29ycmVjdC4gQWxzbywgY2hlY2sgaWYgdGhlIGRhdGFiYXNlIGlzIHJ1bm5pbmcgYW5kIGFjY2Vzc2libGUgZnJvbSB0aGUgbmV0d29yay4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZGF0YWJhc2VFcnJvclxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfTtcbn1cblxuZXhwb3J0IHR5cGUgU1FMRW5naW5lID0gJ215c3FsJyB8ICdwb3N0Z3Jlc3FsJztcbmNvbnN0IERFRkFVTFRfRU5HSU5FID0gJ215c3FsJztcblxuZXhwb3J0IHR5cGUgU1FMRGF0YVNvdXJjZUNvbmZpZyA9IHtcbiAgZW5naW5lOiBTUUxFbmdpbmU7XG4gIHVzZXJuYW1lOiBzdHJpbmc7XG4gIHBhc3N3b3JkOiBzdHJpbmc7XG4gIGhvc3Q6IHN0cmluZztcbiAgZGF0YWJhc2U6IHN0cmluZztcbiAgcG9ydDogbnVtYmVyO1xufTtcblxuLyoqXG4gKiBFcnJvciBmb3IgZGF0YWJhc2UgY29ubmVjdGlvbiBmYWlsdXJlcy5cbiAqIFRoaXMgY2xhc3MgaXMgaW50ZW5kZWQgdG8gYmUgdXNlZCBmb3IgY2FzdGluZyBkYXRhYmFzZSBjb25uZWN0aW9uIGVycm9ycy5cbiAqIERvIG5vdCBjcmVhdGUgaW5zdGFuY2VzIG9mIHRoaXMgY2xhc3MgZGlyZWN0bHkuXG4gKi9cbmFic3RyYWN0IGNsYXNzIERhdGFiYXNlQ29ubmVjdEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICAvKipcbiAgICogQ3JlYXRlcyBkYXRhYmFzZSBjb25uZWN0aW9uIGVycm9yLlxuICAgKi9cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgY29kZT86IHN0cmluZykge1xuICAgIHN1cGVyKGBEYXRhYmFzZSBjb25uZWN0aW9uIGVycm9yOiAke2NvZGV9YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBQYXJzZXMgZGF0YWJhc2UgVVJMIGludG8gYSBjb25maWd1cmF0aW9uIG9iamVjdC5cbiAqL1xuZXhwb3J0IGNvbnN0IHBhcnNlRGF0YWJhc2VVcmwgPSAoZGF0YWJhc2VVcmw6IHN0cmluZyk6IFNRTERhdGFTb3VyY2VDb25maWcgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHBhcnNlZERhdGFiYXNlVXJsID0gbmV3IFVSTChkYXRhYmFzZVVybCk7XG4gICAgY29uc3Qge1xuICAgICAgdXNlcm5hbWU6IGVuY29kZWRVc2VybmFtZSxcbiAgICAgIHBhc3N3b3JkOiBlbmNvZGVkUGFzc3dvcmQsXG4gICAgICBob3N0bmFtZTogZW5jb2RlZEhvc3QsXG4gICAgfSA9IHBhcnNlZERhdGFiYXNlVXJsO1xuICAgIGNvbnN0IHVzZXJuYW1lID0gZGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWRVc2VybmFtZSk7XG4gICAgY29uc3QgcGFzc3dvcmQgPSBkZWNvZGVVUklDb21wb25lbnQoZW5jb2RlZFBhc3N3b3JkKTtcbiAgICBjb25zdCBob3N0ID0gZGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWRIb3N0KTtcbiAgICBjb25zdCBkYXRhYmFzZSA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJzZWREYXRhYmFzZVVybD8ucGF0aG5hbWU/LnNsaWNlKDEpKTtcbiAgICAvLyBEZWZhdWx0IGVuZ2luZSBpcyBNeVNRTFxuICAgIGNvbnN0IGVuZ2luZSA9IGNvbnN0cnVjdERCRW5naW5lKFxuICAgICAgcGFyc2VkRGF0YWJhc2VVcmw/LnByb3RvY29sPy5zbGljZSgwLCAtMSkgPz8gREVGQVVMVF9FTkdJTkVcbiAgICApO1xuICAgIGNvbnN0IHBvcnQgPSBwYXJzZWREYXRhYmFzZVVybD8ucG9ydFxuICAgICAgPyBwYXJzZUludChwYXJzZWREYXRhYmFzZVVybD8ucG9ydCwgMTApXG4gICAgICA6IGdldERlZmF1bHRQb3J0KGVuZ2luZSk7XG5cbiAgICBjb25zdCBjb25maWcgPSB7XG4gICAgICBlbmdpbmUsXG4gICAgICB1c2VybmFtZSxcbiAgICAgIHBhc3N3b3JkLFxuICAgICAgZGF0YWJhc2UsXG4gICAgICBob3N0LFxuICAgICAgcG9ydCxcbiAgICB9IGFzIFNRTERhdGFTb3VyY2VDb25maWc7XG5cbiAgICBjb25zdCBtaXNzaW5nUGFydHMgPSAoXG4gICAgICBPYmplY3Qua2V5cyhjb25maWcpIGFzIEFycmF5PGtleW9mIFNRTERhdGFTb3VyY2VDb25maWc+XG4gICAgKS5maWx0ZXIoKHBhcnQpID0+ICFjb25maWdbcGFydF0pO1xuXG4gICAgaWYgKG1pc3NpbmdQYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxBbXBsaWZ5R2VuZXJhdGVTY2hlbWFFcnJvcj4oXG4gICAgICAgICdEYXRhYmFzZVVybFBhcnNlRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogYE9uZSBvciBtb3JlIHBhcnRzIG9mIHRoZSBkYXRhYmFzZSBVUkwgaXMgbWlzc2luZy4gTWlzc2luZyBbJHttaXNzaW5nUGFydHMuam9pbihcbiAgICAgICAgICAgICcsICdcbiAgICAgICAgICApfV0uYCxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ0Vuc3VyZSB0aGUgZGF0YWJhc2UgVVJMIGZvbGxvd3MgdGhlIHBhdHRlcm4gXCJbbXlzcWx8cG9zdGdyZXNxbF06Ly91c2VybmFtZTpwYXNzd29yZEBob3N0bmFtZTpwb3J0L2RhdGFiYXNlXCIuJyxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29uZmlnO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zdCBlcnJvciA9IGVyciBhcyBFcnJvcjtcbiAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxBbXBsaWZ5R2VuZXJhdGVTY2hlbWFFcnJvcj4oXG4gICAgICAnRGF0YWJhc2VVcmxQYXJzZUVycm9yJyxcbiAgICAgIHtcbiAgICAgICAgbWVzc2FnZTogYFVuYWJsZSB0byBwYXJzZSB0aGUgZGF0YWJhc2UgVVJMLiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgcmVzb2x1dGlvbjogJ0NoZWNrIGlmIHRoZSBkYXRhYmFzZSBVUkwgaXMgY29ycmVjdCBhbmQgYWNjZXNzaWJsZS4nLFxuICAgICAgfSxcbiAgICAgIGVycm9yXG4gICAgKTtcbiAgfVxufTtcblxuY29uc3QgY29uc3RydWN0REJFbmdpbmUgPSAoZW5naW5lOiBzdHJpbmcpOiBTUUxFbmdpbmUgPT4ge1xuICBzd2l0Y2ggKGVuZ2luZSkge1xuICAgIGNhc2UgJ215c3FsJzpcbiAgICAgIHJldHVybiAnbXlzcWwnO1xuICAgIGNhc2UgJ3Bvc3RncmVzcWwnOlxuICAgIGNhc2UgJ3Bvc3RncmVzJzpcbiAgICAgIHJldHVybiAncG9zdGdyZXNxbCc7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlHZW5lcmF0ZVNjaGVtYUVycm9yPihcbiAgICAgICAgJ0RhdGFiYXNlVW5zdXBwb3J0ZWRFbmdpbmVFcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiBgVW5zdXBwb3J0ZWQgZGF0YWJhc2UgZW5naW5lOiAke2VuZ2luZX1gLFxuICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAnRW5zdXJlIHRoYXQgZGF0YWJhc2UgVVJMIHNwZWNpZmllcyBzdXBwb3J0ZWQgZW5naW5lLiBTdXBwb3J0ZWQgZW5naW5lcyBhcmUgXCJteXNxbFwiLCBcInBvc3RncmVzcWxcIiwgXCJwb3N0Z3Jlc1wiLicsXG4gICAgICAgIH1cbiAgICAgICk7XG4gIH1cbn07XG5cbmNvbnN0IGdldERlZmF1bHRQb3J0ID0gKGVuZ2luZTogU1FMRW5naW5lKTogbnVtYmVyID0+IHtcbiAgc3dpdGNoIChlbmdpbmUpIHtcbiAgICBjYXNlICdteXNxbCc6XG4gICAgICByZXR1cm4gMzMwNjtcbiAgICBjYXNlICdwb3N0Z3Jlc3FsJzpcbiAgICAgIHJldHVybiA1NDMyO1xuICB9XG59O1xuIl19