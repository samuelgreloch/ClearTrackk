"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handleConversationTurnEvent = exports.ConversationTurnExecutor = void 0;
const conversation_turn_response_sender_js_1 = require("./conversation_turn_response_sender.js");
const bedrock_converse_adapter_js_1 = require("./bedrock_converse_adapter.js");
const lazy_1 = require("./lazy");
/**
 * This class is responsible for orchestrating conversation turn execution.
 * The conversation turn consist of:
 * 1. Accepting an event that is coming from conversational route resolvers in AppSync.
 * 2. Interacting with AWS Bedrock to produce response.
 * 3. Send response back to AppSync in a form of mutation.
 */
class ConversationTurnExecutor {
    /**
     * Creates conversation turn executor.
     */
    constructor(event, additionalTools, 
    // We're deferring dependency initialization here so that we can capture all validation errors.
    responseSender = new lazy_1.Lazy(() => new conversation_turn_response_sender_js_1.ConversationTurnResponseSender(event)), bedrockConverseAdapter = new lazy_1.Lazy(() => new bedrock_converse_adapter_js_1.BedrockConverseAdapter(event, additionalTools)), logger = console) {
        this.event = event;
        this.responseSender = responseSender;
        this.bedrockConverseAdapter = bedrockConverseAdapter;
        this.logger = logger;
        this.execute = async () => {
            try {
                this.logger.log(`Handling conversation turn event, currentMessageId=${this.event.currentMessageId}, conversationId=${this.event.conversationId}`);
                this.logger.debug('Event received:', this.event);
                if (this.event.streamResponse) {
                    const chunks = this.bedrockConverseAdapter.value.askBedrockStreaming();
                    for await (const chunk of chunks) {
                        await this.responseSender.value.sendResponseChunk(chunk);
                    }
                }
                else {
                    const assistantResponse = await this.bedrockConverseAdapter.value.askBedrock();
                    await this.responseSender.value.sendResponse(assistantResponse);
                }
                this.logger.log(`Conversation turn event handled successfully, currentMessageId=${this.event.currentMessageId}, conversationId=${this.event.conversationId}`);
            }
            catch (e) {
                this.logger.error(`Failed to handle conversation turn event, currentMessageId=${this.event.currentMessageId}, conversationId=${this.event.conversationId}`, e);
                await this.tryForwardError(e);
                // Propagate error to mark lambda execution as failed in metrics.
                throw e;
            }
        };
        this.tryForwardError = async (e) => {
            try {
                let errorType = 'UnknownError';
                let message;
                if (e instanceof Error) {
                    errorType = e.name;
                    message = e.message;
                }
                else {
                    message = JSON.stringify(e);
                }
                await this.responseSender.value.sendErrors([{ errorType, message }]);
            }
            catch (e) {
                // Best effort, only log the fact that we tried to send error back to AppSync.
                this.logger.warn('Failed to send error mutation', e);
            }
        };
    }
}
exports.ConversationTurnExecutor = ConversationTurnExecutor;
/**
 * This function handles a conversation turn event that is coming from
 * AppSync instance with conversational routes defined and sends response back.
 */
const handleConversationTurnEvent = async (event, 
// This is by design, so that tools with different input types can be added
// to single arrays. Downstream code doesn't use these types.
// eslint-disable-next-line @typescript-eslint/no-explicit-any
props) => {
    var _a;
    await new ConversationTurnExecutor(event, (_a = props === null || props === void 0 ? void 0 : props.tools) !== null && _a !== void 0 ? _a : []).execute();
};
exports.handleConversationTurnEvent = handleConversationTurnEvent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVyc2F0aW9uX3R1cm5fZXhlY3V0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29udmVyc2F0aW9uL3J1bnRpbWUvY29udmVyc2F0aW9uX3R1cm5fZXhlY3V0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaUdBQXdGO0FBRXhGLCtFQUF1RTtBQUN2RSxpQ0FBOEI7QUFFOUI7Ozs7OztHQU1HO0FBQ0gsTUFBYSx3QkFBd0I7SUFDbkM7O09BRUc7SUFDSCxZQUNtQixLQUE0QixFQUM3QyxlQUFzQztJQUN0QywrRkFBK0Y7SUFDOUUsaUJBQWlCLElBQUksV0FBSSxDQUN4QyxHQUFHLEVBQUUsQ0FBQyxJQUFJLHFFQUE4QixDQUFDLEtBQUssQ0FBQyxDQUNoRCxFQUNnQix5QkFBeUIsSUFBSSxXQUFJLENBQ2hELEdBQUcsRUFBRSxDQUFDLElBQUksb0RBQXNCLENBQUMsS0FBSyxFQUFFLGVBQWUsQ0FBQyxDQUN6RCxFQUNnQixTQUFTLE9BQU87UUFUaEIsVUFBSyxHQUFMLEtBQUssQ0FBdUI7UUFHNUIsbUJBQWMsR0FBZCxjQUFjLENBRTlCO1FBQ2dCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FFdEM7UUFDZ0IsV0FBTSxHQUFOLE1BQU0sQ0FBVTtRQUduQyxZQUFPLEdBQUcsS0FBSyxJQUFtQixFQUFFO1lBQ2xDLElBQUk7Z0JBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2Isc0RBQXNELElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLG9CQUFvQixJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUNqSSxDQUFDO2dCQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFFakQsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRTtvQkFDN0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO29CQUN2RSxJQUFJLEtBQUssRUFBRSxNQUFNLEtBQUssSUFBSSxNQUFNLEVBQUU7d0JBQ2hDLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7cUJBQzFEO2lCQUNGO3FCQUFNO29CQUNMLE1BQU0saUJBQWlCLEdBQ3JCLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQztvQkFDdkQsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUMsQ0FBQztpQkFDakU7Z0JBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2Isa0VBQWtFLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLG9CQUFvQixJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUM3SSxDQUFDO2FBQ0g7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDVixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZiw4REFBOEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0Isb0JBQW9CLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxFQUFFLEVBQ3hJLENBQUMsQ0FDRixDQUFDO2dCQUNGLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDOUIsaUVBQWlFO2dCQUNqRSxNQUFNLENBQUMsQ0FBQzthQUNUO1FBQ0gsQ0FBQyxDQUFDO1FBRU0sb0JBQWUsR0FBRyxLQUFLLEVBQUUsQ0FBVSxFQUFFLEVBQUU7WUFDN0MsSUFBSTtnQkFDRixJQUFJLFNBQVMsR0FBRyxjQUFjLENBQUM7Z0JBQy9CLElBQUksT0FBZSxDQUFDO2dCQUNwQixJQUFJLENBQUMsWUFBWSxLQUFLLEVBQUU7b0JBQ3RCLFNBQVMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNuQixPQUFPLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQztpQkFDckI7cUJBQU07b0JBQ0wsT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQzdCO2dCQUNELE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ3RFO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1YsOEVBQThFO2dCQUM5RSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQywrQkFBK0IsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUN0RDtRQUNILENBQUMsQ0FBQztJQWpEQyxDQUFDO0NBa0RMO0FBakVELDREQWlFQztBQUVEOzs7R0FHRztBQUNJLE1BQU0sMkJBQTJCLEdBQUcsS0FBSyxFQUM5QyxLQUE0QjtBQUM1QiwyRUFBMkU7QUFDM0UsNkRBQTZEO0FBQzdELDhEQUE4RDtBQUM5RCxLQUEwRCxFQUMzQyxFQUFFOztJQUNqQixNQUFNLElBQUksd0JBQXdCLENBQUMsS0FBSyxFQUFFLE1BQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLEtBQUssbUNBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDMUUsQ0FBQyxDQUFDO0FBUlcsUUFBQSwyQkFBMkIsK0JBUXRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29udmVyc2F0aW9uVHVyblJlc3BvbnNlU2VuZGVyIH0gZnJvbSAnLi9jb252ZXJzYXRpb25fdHVybl9yZXNwb25zZV9zZW5kZXIuanMnO1xuaW1wb3J0IHsgQ29udmVyc2F0aW9uVHVybkV2ZW50LCBFeGVjdXRhYmxlVG9vbCwgSlNPTlNjaGVtYSB9IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgQmVkcm9ja0NvbnZlcnNlQWRhcHRlciB9IGZyb20gJy4vYmVkcm9ja19jb252ZXJzZV9hZGFwdGVyLmpzJztcbmltcG9ydCB7IExhenkgfSBmcm9tICcuL2xhenknO1xuXG4vKipcbiAqIFRoaXMgY2xhc3MgaXMgcmVzcG9uc2libGUgZm9yIG9yY2hlc3RyYXRpbmcgY29udmVyc2F0aW9uIHR1cm4gZXhlY3V0aW9uLlxuICogVGhlIGNvbnZlcnNhdGlvbiB0dXJuIGNvbnNpc3Qgb2Y6XG4gKiAxLiBBY2NlcHRpbmcgYW4gZXZlbnQgdGhhdCBpcyBjb21pbmcgZnJvbSBjb252ZXJzYXRpb25hbCByb3V0ZSByZXNvbHZlcnMgaW4gQXBwU3luYy5cbiAqIDIuIEludGVyYWN0aW5nIHdpdGggQVdTIEJlZHJvY2sgdG8gcHJvZHVjZSByZXNwb25zZS5cbiAqIDMuIFNlbmQgcmVzcG9uc2UgYmFjayB0byBBcHBTeW5jIGluIGEgZm9ybSBvZiBtdXRhdGlvbi5cbiAqL1xuZXhwb3J0IGNsYXNzIENvbnZlcnNhdGlvblR1cm5FeGVjdXRvciB7XG4gIC8qKlxuICAgKiBDcmVhdGVzIGNvbnZlcnNhdGlvbiB0dXJuIGV4ZWN1dG9yLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBldmVudDogQ29udmVyc2F0aW9uVHVybkV2ZW50LFxuICAgIGFkZGl0aW9uYWxUb29sczogQXJyYXk8RXhlY3V0YWJsZVRvb2w+LFxuICAgIC8vIFdlJ3JlIGRlZmVycmluZyBkZXBlbmRlbmN5IGluaXRpYWxpemF0aW9uIGhlcmUgc28gdGhhdCB3ZSBjYW4gY2FwdHVyZSBhbGwgdmFsaWRhdGlvbiBlcnJvcnMuXG4gICAgcHJpdmF0ZSByZWFkb25seSByZXNwb25zZVNlbmRlciA9IG5ldyBMYXp5KFxuICAgICAgKCkgPT4gbmV3IENvbnZlcnNhdGlvblR1cm5SZXNwb25zZVNlbmRlcihldmVudClcbiAgICApLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmVkcm9ja0NvbnZlcnNlQWRhcHRlciA9IG5ldyBMYXp5KFxuICAgICAgKCkgPT4gbmV3IEJlZHJvY2tDb252ZXJzZUFkYXB0ZXIoZXZlbnQsIGFkZGl0aW9uYWxUb29scylcbiAgICApLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gY29uc29sZVxuICApIHt9XG5cbiAgZXhlY3V0ZSA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgSGFuZGxpbmcgY29udmVyc2F0aW9uIHR1cm4gZXZlbnQsIGN1cnJlbnRNZXNzYWdlSWQ9JHt0aGlzLmV2ZW50LmN1cnJlbnRNZXNzYWdlSWR9LCBjb252ZXJzYXRpb25JZD0ke3RoaXMuZXZlbnQuY29udmVyc2F0aW9uSWR9YFxuICAgICAgKTtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdFdmVudCByZWNlaXZlZDonLCB0aGlzLmV2ZW50KTtcblxuICAgICAgaWYgKHRoaXMuZXZlbnQuc3RyZWFtUmVzcG9uc2UpIHtcbiAgICAgICAgY29uc3QgY2h1bmtzID0gdGhpcy5iZWRyb2NrQ29udmVyc2VBZGFwdGVyLnZhbHVlLmFza0JlZHJvY2tTdHJlYW1pbmcoKTtcbiAgICAgICAgZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBjaHVua3MpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnJlc3BvbnNlU2VuZGVyLnZhbHVlLnNlbmRSZXNwb25zZUNodW5rKGNodW5rKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgYXNzaXN0YW50UmVzcG9uc2UgPVxuICAgICAgICAgIGF3YWl0IHRoaXMuYmVkcm9ja0NvbnZlcnNlQWRhcHRlci52YWx1ZS5hc2tCZWRyb2NrKCk7XG4gICAgICAgIGF3YWl0IHRoaXMucmVzcG9uc2VTZW5kZXIudmFsdWUuc2VuZFJlc3BvbnNlKGFzc2lzdGFudFJlc3BvbnNlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgQ29udmVyc2F0aW9uIHR1cm4gZXZlbnQgaGFuZGxlZCBzdWNjZXNzZnVsbHksIGN1cnJlbnRNZXNzYWdlSWQ9JHt0aGlzLmV2ZW50LmN1cnJlbnRNZXNzYWdlSWR9LCBjb252ZXJzYXRpb25JZD0ke3RoaXMuZXZlbnQuY29udmVyc2F0aW9uSWR9YFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBoYW5kbGUgY29udmVyc2F0aW9uIHR1cm4gZXZlbnQsIGN1cnJlbnRNZXNzYWdlSWQ9JHt0aGlzLmV2ZW50LmN1cnJlbnRNZXNzYWdlSWR9LCBjb252ZXJzYXRpb25JZD0ke3RoaXMuZXZlbnQuY29udmVyc2F0aW9uSWR9YCxcbiAgICAgICAgZVxuICAgICAgKTtcbiAgICAgIGF3YWl0IHRoaXMudHJ5Rm9yd2FyZEVycm9yKGUpO1xuICAgICAgLy8gUHJvcGFnYXRlIGVycm9yIHRvIG1hcmsgbGFtYmRhIGV4ZWN1dGlvbiBhcyBmYWlsZWQgaW4gbWV0cmljcy5cbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgdHJ5Rm9yd2FyZEVycm9yID0gYXN5bmMgKGU6IHVua25vd24pID0+IHtcbiAgICB0cnkge1xuICAgICAgbGV0IGVycm9yVHlwZSA9ICdVbmtub3duRXJyb3InO1xuICAgICAgbGV0IG1lc3NhZ2U6IHN0cmluZztcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgZXJyb3JUeXBlID0gZS5uYW1lO1xuICAgICAgICBtZXNzYWdlID0gZS5tZXNzYWdlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KGUpO1xuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy5yZXNwb25zZVNlbmRlci52YWx1ZS5zZW5kRXJyb3JzKFt7IGVycm9yVHlwZSwgbWVzc2FnZSB9XSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gQmVzdCBlZmZvcnQsIG9ubHkgbG9nIHRoZSBmYWN0IHRoYXQgd2UgdHJpZWQgdG8gc2VuZCBlcnJvciBiYWNrIHRvIEFwcFN5bmMuXG4gICAgICB0aGlzLmxvZ2dlci53YXJuKCdGYWlsZWQgdG8gc2VuZCBlcnJvciBtdXRhdGlvbicsIGUpO1xuICAgIH1cbiAgfTtcbn1cblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIGhhbmRsZXMgYSBjb252ZXJzYXRpb24gdHVybiBldmVudCB0aGF0IGlzIGNvbWluZyBmcm9tXG4gKiBBcHBTeW5jIGluc3RhbmNlIHdpdGggY29udmVyc2F0aW9uYWwgcm91dGVzIGRlZmluZWQgYW5kIHNlbmRzIHJlc3BvbnNlIGJhY2suXG4gKi9cbmV4cG9ydCBjb25zdCBoYW5kbGVDb252ZXJzYXRpb25UdXJuRXZlbnQgPSBhc3luYyAoXG4gIGV2ZW50OiBDb252ZXJzYXRpb25UdXJuRXZlbnQsXG4gIC8vIFRoaXMgaXMgYnkgZGVzaWduLCBzbyB0aGF0IHRvb2xzIHdpdGggZGlmZmVyZW50IGlucHV0IHR5cGVzIGNhbiBiZSBhZGRlZFxuICAvLyB0byBzaW5nbGUgYXJyYXlzLiBEb3duc3RyZWFtIGNvZGUgZG9lc24ndCB1c2UgdGhlc2UgdHlwZXMuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIHByb3BzPzogeyB0b29scz86IEFycmF5PEV4ZWN1dGFibGVUb29sPEpTT05TY2hlbWEsIGFueT4+IH1cbik6IFByb21pc2U8dm9pZD4gPT4ge1xuICBhd2FpdCBuZXcgQ29udmVyc2F0aW9uVHVybkV4ZWN1dG9yKGV2ZW50LCBwcm9wcz8udG9vbHMgPz8gW10pLmV4ZWN1dGUoKTtcbn07XG4iXX0=