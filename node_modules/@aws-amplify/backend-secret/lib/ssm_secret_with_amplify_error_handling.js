import { SecretError } from './secret_error.js';
import { AmplifyFault, AmplifyUserError } from '@aws-amplify/platform-core';
import { SSMServiceException } from '@aws-sdk/client-ssm';
/**
 * Handles errors and translate them to AmplifyUserError or AmplifyFaults
 * To be used exclusively by the amplify cli
 */
export class SSMSecretClientWithAmplifyErrorHandling {
    secretClient;
    /**
     * wraps the secretClient with Amplify CLI specific error handling
     */
    constructor(secretClient) {
        this.secretClient = secretClient;
    }
    getSecret = async (backendIdentifier, secretIdentifier) => {
        try {
            return await this.secretClient.getSecret(backendIdentifier, secretIdentifier);
        }
        catch (e) {
            throw this.translateToAmplifyError(e, 'Get', secretIdentifier);
        }
    };
    listSecrets = async (backendIdentifier) => {
        try {
            return await this.secretClient.listSecrets(backendIdentifier);
        }
        catch (e) {
            throw this.translateToAmplifyError(e, 'List');
        }
    };
    setSecret = async (backendIdentifier, secretName, secretValue) => {
        try {
            return await this.secretClient.setSecret(backendIdentifier, secretName, secretValue);
        }
        catch (e) {
            throw this.translateToAmplifyError(e, 'Set');
        }
    };
    removeSecret = async (backendIdentifier, secretName) => {
        try {
            return await this.secretClient.removeSecret(backendIdentifier, secretName);
        }
        catch (e) {
            throw this.translateToAmplifyError(e, 'Remove', { name: secretName });
        }
    };
    translateToAmplifyError = (error, apiName, secretIdentifier) => {
        if (error instanceof SecretError && error.cause) {
            if ([
                'UnrecognizedClientException',
                'AccessDeniedException',
                'NotAuthorized',
                'ExpiredTokenException',
                'ExpiredToken',
                'CredentialsProviderError',
                'IncompleteSignatureException',
                'InvalidSignatureException',
            ].includes(error.cause.name)) {
                return new AmplifyUserError('SSMCredentialsError', {
                    message: `Failed to ${apiName.toLowerCase()} secrets. ${error.cause.name}: ${error.cause?.message}`,
                    resolution: 'Make sure your AWS credentials are set up correctly, refreshed and have necessary permissions to call SSM service',
                });
            }
            if (error.cause.name === 'ParameterNotFound' &&
                (apiName === 'Get' || apiName === 'Remove') &&
                secretIdentifier) {
                return new AmplifyUserError('SSMParameterNotFoundError', {
                    message: `Failed to ${apiName.toLowerCase()} ${secretIdentifier.name} secret. ${error.cause.name}: ${error.cause?.message}`,
                    resolution: `Make sure that ${secretIdentifier.name} has been set. See https://docs.amplify.aws/react/deploy-and-host/fullstack-branching/secrets-and-vars/.`,
                });
            }
            let downstreamException = error;
            if (!(error.cause instanceof SSMServiceException) &&
                error.cause instanceof Error) {
                downstreamException = error.cause;
            }
            throw new AmplifyFault(`${apiName}SecretsFailedFault`, {
                message: `Failed to ${apiName.toLowerCase()} secrets. ${error.cause.name}: ${error.cause?.message}`,
            }, downstreamException);
        }
        return error;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NtX3NlY3JldF93aXRoX2FtcGxpZnlfZXJyb3JfaGFuZGxpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvc3NtX3NlY3JldF93aXRoX2FtcGxpZnlfZXJyb3JfaGFuZGxpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBT0EsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM1RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUUxRDs7O0dBR0c7QUFDSCxNQUFNLE9BQU8sdUNBQXVDO0lBSXJCO0lBSDdCOztPQUVHO0lBQ0gsWUFBNkIsWUFBMEI7UUFBMUIsaUJBQVksR0FBWixZQUFZLENBQWM7SUFBRyxDQUFDO0lBRTNELFNBQVMsR0FBRyxLQUFLLEVBQ2YsaUJBQTRDLEVBQzVDLGdCQUFrQyxFQUNqQixFQUFFO1FBQ25CLElBQUk7WUFDRixPQUFPLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQ3RDLGlCQUFpQixFQUNqQixnQkFBZ0IsQ0FDakIsQ0FBQztTQUNIO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixNQUFNLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7U0FDaEU7SUFDSCxDQUFDLENBQUM7SUFFRixXQUFXLEdBQUcsS0FBSyxFQUNqQixpQkFBNEMsRUFDakIsRUFBRTtRQUM3QixJQUFJO1lBQ0YsT0FBTyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLGlCQUFpQixDQUFDLENBQUM7U0FDL0Q7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztTQUMvQztJQUNILENBQUMsQ0FBQztJQUVG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SWQsIEJhY2tlbmRJZGVudGlmaWVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBTZWNyZXQsXG4gIFNlY3JldENsaWVudCxcbiAgU2VjcmV0SWRlbnRpZmllcixcbiAgU2VjcmV0TGlzdEl0ZW0sXG59IGZyb20gJy4vc2VjcmV0LmpzJztcbmltcG9ydCB7IFNlY3JldEVycm9yIH0gZnJvbSAnLi9zZWNyZXRfZXJyb3IuanMnO1xuaW1wb3J0IHsgQW1wbGlmeUZhdWx0LCBBbXBsaWZ5VXNlckVycm9yIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgU1NNU2VydmljZUV4Y2VwdGlvbiB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zc20nO1xuXG4vKipcbiAqIEhhbmRsZXMgZXJyb3JzIGFuZCB0cmFuc2xhdGUgdGhlbSB0byBBbXBsaWZ5VXNlckVycm9yIG9yIEFtcGxpZnlGYXVsdHNcbiAqIFRvIGJlIHVzZWQgZXhjbHVzaXZlbHkgYnkgdGhlIGFtcGxpZnkgY2xpXG4gKi9cbmV4cG9ydCBjbGFzcyBTU01TZWNyZXRDbGllbnRXaXRoQW1wbGlmeUVycm9ySGFuZGxpbmcgaW1wbGVtZW50cyBTZWNyZXRDbGllbnQge1xuICAvKipcbiAgICogd3JhcHMgdGhlIHNlY3JldENsaWVudCB3aXRoIEFtcGxpZnkgQ0xJIHNwZWNpZmljIGVycm9yIGhhbmRsaW5nXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHNlY3JldENsaWVudDogU2VjcmV0Q2xpZW50KSB7fVxuXG4gIGdldFNlY3JldCA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZCxcbiAgICBzZWNyZXRJZGVudGlmaWVyOiBTZWNyZXRJZGVudGlmaWVyXG4gICk6IFByb21pc2U8U2VjcmV0PiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnNlY3JldENsaWVudC5nZXRTZWNyZXQoXG4gICAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgICBzZWNyZXRJZGVudGlmaWVyXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IHRoaXMudHJhbnNsYXRlVG9BbXBsaWZ5RXJyb3IoZSwgJ0dldCcsIHNlY3JldElkZW50aWZpZXIpO1xuICAgIH1cbiAgfTtcblxuICBsaXN0U2VjcmV0cyA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZFxuICApOiBQcm9taXNlPFNlY3JldExpc3RJdGVtW10+ID0+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VjcmV0Q2xpZW50Lmxpc3RTZWNyZXRzKGJhY2tlbmRJZGVudGlmaWVyKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyB0aGlzLnRyYW5zbGF0ZVRvQW1wbGlmeUVycm9yKGUsICdMaXN0Jyk7XG4gICAgfVxuICB9O1xuXG4gIHNldFNlY3JldCA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZCxcbiAgICBzZWNyZXROYW1lOiBzdHJpbmcsXG4gICAgc2VjcmV0VmFsdWU6IHN0cmluZ1xuICApOiBQcm9taXNlPFNlY3JldElkZW50aWZpZXI+ID0+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VjcmV0Q2xpZW50LnNldFNlY3JldChcbiAgICAgICAgYmFja2VuZElkZW50aWZpZXIsXG4gICAgICAgIHNlY3JldE5hbWUsXG4gICAgICAgIHNlY3JldFZhbHVlXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IHRoaXMudHJhbnNsYXRlVG9BbXBsaWZ5RXJyb3IoZSwgJ1NldCcpO1xuICAgIH1cbiAgfTtcblxuICByZW1vdmVTZWNyZXQgPSBhc3luYyAoXG4gICAgYmFja2VuZElkZW50aWZpZXI6IEJhY2tlbmRJZGVudGlmaWVyIHwgQXBwSWQsXG4gICAgc2VjcmV0TmFtZTogc3RyaW5nXG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zZWNyZXRDbGllbnQucmVtb3ZlU2VjcmV0KFxuICAgICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgICAgc2VjcmV0TmFtZVxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyB0aGlzLnRyYW5zbGF0ZVRvQW1wbGlmeUVycm9yKGUsICdSZW1vdmUnLCB7IG5hbWU6IHNlY3JldE5hbWUgfSk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgdHJhbnNsYXRlVG9BbXBsaWZ5RXJyb3IgPSAoXG4gICAgZXJyb3I6IHVua25vd24sXG4gICAgYXBpTmFtZTogc3RyaW5nLFxuICAgIHNlY3JldElkZW50aWZpZXI/OiBTZWNyZXRJZGVudGlmaWVyXG4gICkgPT4ge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFNlY3JldEVycm9yICYmIGVycm9yLmNhdXNlKSB7XG4gICAgICBpZiAoXG4gICAgICAgIFtcbiAgICAgICAgICAnVW5yZWNvZ25pemVkQ2xpZW50RXhjZXB0aW9uJyxcbiAgICAgICAgICAnQWNjZXNzRGVuaWVkRXhjZXB0aW9uJyxcbiAgICAgICAgICAnTm90QXV0aG9yaXplZCcsXG4gICAgICAgICAgJ0V4cGlyZWRUb2tlbkV4Y2VwdGlvbicsXG4gICAgICAgICAgJ0V4cGlyZWRUb2tlbicsXG4gICAgICAgICAgJ0NyZWRlbnRpYWxzUHJvdmlkZXJFcnJvcicsXG4gICAgICAgICAgJ0luY29tcGxldGVTaWduYXR1cmVFeGNlcHRpb24nLFxuICAgICAgICAgICdJbnZhbGlkU2lnbmF0dXJlRXhjZXB0aW9uJyxcbiAgICAgICAgXS5pbmNsdWRlcyhlcnJvci5jYXVzZS5uYW1lKVxuICAgICAgKSB7XG4gICAgICAgIHJldHVybiBuZXcgQW1wbGlmeVVzZXJFcnJvcignU1NNQ3JlZGVudGlhbHNFcnJvcicsIHtcbiAgICAgICAgICBtZXNzYWdlOiBgRmFpbGVkIHRvICR7YXBpTmFtZS50b0xvd2VyQ2FzZSgpfSBzZWNyZXRzLiAke1xuICAgICAgICAgICAgZXJyb3IuY2F1c2UubmFtZVxuICAgICAgICAgIH06ICR7ZXJyb3IuY2F1c2U/Lm1lc3NhZ2V9YCxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ01ha2Ugc3VyZSB5b3VyIEFXUyBjcmVkZW50aWFscyBhcmUgc2V0IHVwIGNvcnJlY3RseSwgcmVmcmVzaGVkIGFuZCBoYXZlIG5lY2Vzc2FyeSBwZXJtaXNzaW9ucyB0byBjYWxsIFNTTSBzZXJ2aWNlJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yLmNhdXNlLm5hbWUgPT09ICdQYXJhbWV0ZXJOb3RGb3VuZCcgJiZcbiAgICAgICAgKGFwaU5hbWUgPT09ICdHZXQnIHx8IGFwaU5hbWUgPT09ICdSZW1vdmUnKSAmJlxuICAgICAgICBzZWNyZXRJZGVudGlmaWVyXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIG5ldyBBbXBsaWZ5VXNlckVycm9yKCdTU01QYXJhbWV0ZXJOb3RGb3VuZEVycm9yJywge1xuICAgICAgICAgIG1lc3NhZ2U6IGBGYWlsZWQgdG8gJHthcGlOYW1lLnRvTG93ZXJDYXNlKCl9ICR7XG4gICAgICAgICAgICBzZWNyZXRJZGVudGlmaWVyLm5hbWVcbiAgICAgICAgICB9IHNlY3JldC4gJHtlcnJvci5jYXVzZS5uYW1lfTogJHtlcnJvci5jYXVzZT8ubWVzc2FnZX1gLFxuICAgICAgICAgIHJlc29sdXRpb246IGBNYWtlIHN1cmUgdGhhdCAke3NlY3JldElkZW50aWZpZXIubmFtZX0gaGFzIGJlZW4gc2V0LiBTZWUgaHR0cHM6Ly9kb2NzLmFtcGxpZnkuYXdzL3JlYWN0L2RlcGxveS1hbmQtaG9zdC9mdWxsc3RhY2stYnJhbmNoaW5nL3NlY3JldHMtYW5kLXZhcnMvLmAsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgbGV0IGRvd25zdHJlYW1FeGNlcHRpb246IEVycm9yID0gZXJyb3I7XG4gICAgICBpZiAoXG4gICAgICAgICEoZXJyb3IuY2F1c2UgaW5zdGFuY2VvZiBTU01TZXJ2aWNlRXhjZXB0aW9uKSAmJlxuICAgICAgICBlcnJvci5jYXVzZSBpbnN0YW5jZW9mIEVycm9yXG4gICAgICApIHtcbiAgICAgICAgZG93bnN0cmVhbUV4Y2VwdGlvbiA9IGVycm9yLmNhdXNlO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlGYXVsdChcbiAgICAgICAgYCR7YXBpTmFtZX1TZWNyZXRzRmFpbGVkRmF1bHRgLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogYEZhaWxlZCB0byAke2FwaU5hbWUudG9Mb3dlckNhc2UoKX0gc2VjcmV0cy4gJHtcbiAgICAgICAgICAgIGVycm9yLmNhdXNlLm5hbWVcbiAgICAgICAgICB9OiAke2Vycm9yLmNhdXNlPy5tZXNzYWdlfWAsXG4gICAgICAgIH0sXG4gICAgICAgIGRvd25zdHJlYW1FeGNlcHRpb25cbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBlcnJvcjtcbiAgfTtcbn1cbiJdfQ==