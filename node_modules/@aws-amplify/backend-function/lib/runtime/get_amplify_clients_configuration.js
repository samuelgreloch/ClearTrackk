import { NamingConverter } from '@aws-amplify/platform-core';
import { GetObjectCommand, NoSuchKey, S3Client, S3ServiceException, } from '@aws-sdk/client-s3';
const dataKeyNameContent = '_MODEL_INTROSPECTION_SCHEMA_KEY';
const dataBucketNameContent = '_MODEL_INTROSPECTION_SCHEMA_BUCKET_NAME';
const dataEndpointNameContent = '_GRAPHQL_ENDPOINT';
/* eslint-enable @typescript-eslint/naming-convention */
const getResourceConfig = (env, modelIntrospectionSchema) => {
    return {
        API: {
            GraphQL: {
                endpoint: env.dataEndpoint,
                region: env.AWS_REGION,
                defaultAuthMode: 'iam',
                modelIntrospection: modelIntrospectionSchema,
            },
        },
    };
};
const getLibraryOptions = (env) => {
    return {
        Auth: {
            credentialsProvider: {
                getCredentialsAndIdentityId: async () => ({
                    credentials: {
                        accessKeyId: env.AWS_ACCESS_KEY_ID,
                        secretAccessKey: env.AWS_SECRET_ACCESS_KEY,
                        sessionToken: env.AWS_SESSION_TOKEN,
                    },
                }),
                clearCredentialsAndIdentityId: () => {
                    /* noop */
                },
            },
        },
    };
};
const extendEnv = (env, dataName) => {
    const bucketName = `${dataName}${dataBucketNameContent}`;
    const keyName = `${dataName}${dataKeyNameContent}`;
    const endpointName = `${dataName}${dataEndpointNameContent}`;
    if (!(bucketName in env &&
        keyName in env &&
        endpointName in env &&
        typeof env[bucketName] === 'string' &&
        typeof env[keyName] === 'string' &&
        typeof env[endpointName] === 'string')) {
        throw new Error(`The data environment variables are malformed. env=${JSON.stringify(env)}`);
    }
    const dataBucket = env[bucketName];
    const dataKey = env[keyName];
    const dataEndpoint = env[endpointName];
    return {
        ...env,
        dataBucket,
        dataKey,
        dataEndpoint,
    };
};
/**
 * Generate the `resourceConfig` and `libraryOptions` need to configure
 * Amplify for the data client in a lambda.
 *
 * Your function needs to be granted resource access on your schema for this to work
 * `a.schema(...).authorization((allow) => [a.resource(myFunction)])`
 * @param env - The environment variables for the data client
 * @returns An object containing the `resourceConfig` and `libraryOptions`
 */
export const getAmplifyDataClientConfig = async (env, s3Client) => {
    if (!s3Client) {
        s3Client = new S3Client();
    }
    const dataName = new NamingConverter().toScreamingSnakeCase(env.AMPLIFY_DATA_DEFAULT_NAME);
    const extendedEnv = extendEnv(env, dataName);
    let modelIntrospectionSchema;
    try {
        const response = await s3Client.send(new GetObjectCommand({
            Bucket: extendedEnv.dataBucket,
            Key: extendedEnv.dataKey,
        }));
        const modelIntrospectionSchemaJson = await response.Body?.transformToString();
        modelIntrospectionSchema = JSON.parse(modelIntrospectionSchemaJson ?? '{}');
    }
    catch (caught) {
        if (caught instanceof NoSuchKey) {
            throw new Error('Error retrieving the schema from S3. Please confirm that your project has a `defineData` included in the `defineBackend` definition.', { cause: caught });
        }
        else if (caught instanceof S3ServiceException) {
            throw new Error(`Error retrieving the schema from S3. You may need to grant this function authorization on the schema. ${caught.name}: ${caught.message}.`, { cause: caught });
        }
        else {
            throw caught;
        }
    }
    const libraryOptions = getLibraryOptions(env);
    const resourceConfig = getResourceConfig(extendedEnv, modelIntrospectionSchema);
    return { resourceConfig, libraryOptions };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3J1bnRpbWUvZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLFNBQVMsRUFDVCxRQUFRLEVBQ1Isa0JBQWtCLEdBQ25CLE1BQU0sb0JBQW9CLENBQUM7QUFFNUIsTUFBTSxrQkFBa0IsR0FBRyxpQ0FBaUMsQ0FBQztBQUM3RCxNQUFNLHFCQUFxQixHQUFHLHlDQUF5QyxDQUFDO0FBQ3hFLE1BQU0sdUJBQXVCLEdBQUcsbUJBQW1CLENBQUM7QUFrQ3BELHdEQUF3RDtBQUV4RCxNQUFNLGlCQUFpQixHQUFHLENBQ3hCLEdBQTZCLEVBQzdCLHdCQUFnQyxFQUNoQixFQUFFO0lBQ2xCLE9BQU87UUFDTCxHQUFHLEVBQUU7WUFDSCxPQUFPLEVBQUU7Z0JBQ1AsUUFBUSxFQUFFLEdBQUcsQ0FBQyxZQUFZO2dCQUMxQixNQUFNLEVBQUUsR0FBRyxDQUFDLFVBQVU7Z0JBQ3RCLGVBQWUsRUFBRSxLQUFjO2dCQUMvQixrQkFBa0IsRUFBRSx3QkFBd0I7YUFDN0M7U0FDRjtLQUNGLENBQUM7QUFDSixDQUFDLENBQUM7QUFrQkYsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLEdBQWtCLEVBQWtCLEVBQUU7SUFDL0QsT0FBTztRQUNMLElBQUksRUFBRTtZQUNKLG1CQUFtQixFQUFFO2dCQUNuQiwyQkFBMkIsRUFBRSxLQUFLLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQ3hDLFdBQVcsRUFBRTt3QkFDWCxXQUFXLEVBQUUsR0FBRyxDQUFDLGlCQUFpQjt3QkFDbEMsZUFBZSxFQUFFLEdBQUcsQ0FBQyxxQkFBcUI7d0JBQzFDLFlBQVksRUFBRSxHQUFHLENBQUMsaUJB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QUFDO0lBRTlDLE1BQU0sY0FBYyxHQUFHLGlCQUFpQixDQUN0QyxXQUFXLEVBQ1gsd0JBQXdCLENBQ3pCLENBQUM7SUFFRixPQUFPLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxDQUFDO0FBQzVDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5hbWluZ0NvbnZlcnRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIEdldE9iamVjdENvbW1hbmQsXG4gIE5vU3VjaEtleSxcbiAgUzNDbGllbnQsXG4gIFMzU2VydmljZUV4Y2VwdGlvbixcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcblxuY29uc3QgZGF0YUtleU5hbWVDb250ZW50ID0gJ19NT0RFTF9JTlRST1NQRUNUSU9OX1NDSEVNQV9LRVknO1xuY29uc3QgZGF0YUJ1Y2tldE5hbWVDb250ZW50ID0gJ19NT0RFTF9JTlRST1NQRUNUSU9OX1NDSEVNQV9CVUNLRVRfTkFNRSc7XG5jb25zdCBkYXRhRW5kcG9pbnROYW1lQ29udGVudCA9ICdfR1JBUEhRTF9FTkRQT0lOVCc7XG5cbmV4cG9ydCB0eXBlIERhdGFDbGllbnRFbnYgPSB7XG4gIC8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuICBBV1NfQUNDRVNTX0tFWV9JRDogc3RyaW5nO1xuICBBV1NfU0VDUkVUX0FDQ0VTU19LRVk6IHN0cmluZztcbiAgQVdTX1NFU1NJT05fVE9LRU46IHN0cmluZztcbiAgQVdTX1JFR0lPTjogc3RyaW5nO1xuICBBTVBMSUZZX0RBVEFfREVGQVVMVF9OQU1FOiBzdHJpbmc7XG4gIC8qIGVzbGludC1lbmFibGUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG59ICYgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG5cbnR5cGUgRGF0YUVudkV4dGVuc2lvbiA9IHtcbiAgZGF0YUJ1Y2tldDogc3RyaW5nO1xuICBkYXRhS2V5OiBzdHJpbmc7XG4gIGRhdGFFbmRwb2ludDogc3RyaW5nO1xufTtcblxudHlwZSBFeHRlbmRlZEFtcGxpZnlDbGllbnRFbnYgPSBEYXRhQ2xpZW50RW52ICYgRGF0YUVudkV4dGVuc2lvbjtcblxuLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG5leHBvcnQgdHlwZSBSZXNvdXJjZUNvbmZpZyA9IHtcbiAgQVBJOiB7XG4gICAgR3JhcGhRTDoge1xuICAgICAgZW5kcG9pbnQ6IHN0cmluZztcbiAgICAgIHJlZ2lvbjogc3RyaW5nO1xuICAgICAgZGVmYXVsdEF1dGhNb2RlOiAnaWFtJztcbiAgICAgIC8vIFVzaW5nIGBhbnlgIHRvIGF2b2lkIHJlcHJvZHVjaW5nIDEwMCsgbGluZXMgb2YgdHlwaW5nIHRvIG1hdGNoIHRoZSBleHBlY3RlZCBzaGFwZSBkZWZpbmVkIGluIGF3cy1hbXBsaWZ5OlxuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2F3cy1hbXBsaWZ5L2FtcGxpZnktanMvYmxvYi9tYWluL3BhY2thZ2VzL2NvcmUvc3JjL3NpbmdsZXRvbi9BUEkvdHlwZXMudHMjTDE0My1MMTUzXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgbW9kZWxJbnRyb3NwZWN0aW9uOiBhbnk7XG4gICAgfTtcbiAgfTtcbn07XG4vKiBlc2xpbnQtZW5hYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuXG5jb25zdCBnZXRSZXNvdXJjZUNvbmZpZyA9IChcbiAgZW52OiBFeHRlbmRlZEFtcGxpZnlDbGllbnRFbnYsXG4gIG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYTogb2JqZWN0XG4pOiBSZXNvdXJjZUNvbmZpZyA9PiB7XG4gIHJldHVybiB7XG4gICAgQVBJOiB7XG4gICAgICBHcmFwaFFMOiB7XG4gICAgICAgIGVuZHBvaW50OiBlbnYuZGF0YUVuZHBvaW50LFxuICAgICAgICByZWdpb246IGVudi5BV1NfUkVHSU9OLFxuICAgICAgICBkZWZhdWx0QXV0aE1vZGU6ICdpYW0nIGFzIGNvbnN0LFxuICAgICAgICBtb2RlbEludHJvc3BlY3Rpb246IG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfTtcbn07XG5cbmV4cG9ydCB0eXBlIExpYnJhcnlPcHRpb25zID0ge1xuICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG4gIEF1dGg6IHtcbiAgICBjcmVkZW50aWFsc1Byb3ZpZGVyOiB7XG4gICAgICBnZXRDcmVkZW50aWFsc0FuZElkZW50aXR5SWQ6ICgpID0+IFByb21pc2U8e1xuICAgICAgICBjcmVkZW50aWFsczoge1xuICAgICAgICAgIGFjY2Vzc0tleUlkOiBzdHJpbmc7XG4gICAgICAgICAgc2VjcmV0QWNjZXNzS2V5OiBzdHJpbmc7XG4gICAgICAgICAgc2Vzc2lvblRva2VuOiBzdHJpbmc7XG4gICAgICAgIH07XG4gICAgICB9PjtcbiAgICAgIGNsZWFyQ3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiAoKSA9PiB2b2lkO1xuICAgIH07XG4gIH07XG59O1xuXG5jb25zdCBnZXRMaWJyYXJ5T3B0aW9ucyA9IChlbnY6IERhdGFDbGllbnRFbnYpOiBMaWJyYXJ5T3B0aW9ucyA9PiB7XG4gIHJldHVybiB7XG4gICAgQXV0aDoge1xuICAgICAgY3JlZGVudGlhbHNQcm92aWRlcjoge1xuICAgICAgICBnZXRDcmVkZW50aWFsc0FuZElkZW50aXR5SWQ6IGFzeW5jICgpID0+ICh7XG4gICAgICAgICAgY3JlZGVudGlhbHM6IHtcbiAgICAgICAgICAgIGFjY2Vzc0tleUlkOiBlbnYuQVdTX0FDQ0VTU19LRVlfSUQsXG4gICAgICAgICAgICBzZWNyZXRBY2Nlc3NLZXk6IGVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVksXG4gICAgICAgICAgICBzZXNzaW9uVG9rZW46IGVudi5BV1NfU0VTU0lPTl9UT0tFTixcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICAgY2xlYXJDcmVkZW50aWFsc0FuZElkZW50aXR5SWQ6ICgpID0+IHtcbiAgICAgICAgICAvKiBub29wICovXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0sXG4gIH07XG59O1xuXG5leHBvcnQgdHlwZSBEYXRhQ2xpZW50Q29uZmlnID0ge1xuICByZXNvdXJjZUNvbmZpZzogUmVzb3VyY2VDb25maWc7XG4gIGxpYnJhcnlPcHRpb25zOiBMaWJyYXJ5T3B0aW9ucztcbn07XG5cbmNvbnN0IGV4dGVuZEVudiA9IChcbiAgZW52OiBEYXRhQ2xpZW50RW52ICYgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIGRhdGFOYW1lOiBzdHJpbmdcbik6IEV4dGVuZGVkQW1wbGlmeUNsaWVudEVudiA9PiB7XG4gIGNvbnN0IGJ1Y2tldE5hbWUgPSBgJHtkYXRhTmFtZX0ke2RhdGFCdWNrZXROYW1lQ29udGVudH1gO1xuICBjb25zdCBrZXlOYW1lID0gYCR7ZGF0YU5hbWV9JHtkYXRhS2V5TmFtZUNvbnRlbnR9YDtcbiAgY29uc3QgZW5kcG9pbnROYW1lID0gYCR7ZGF0YU5hbWV9JHtkYXRhRW5kcG9pbnROYW1lQ29udGVudH1gO1xuICBpZiAoXG4gICAgIShcbiAgICAgIGJ1Y2tldE5hbWUgaW4gZW52ICYmXG4gICAgICBrZXlOYW1lIGluIGVudiAmJlxuICAgICAgZW5kcG9pbnROYW1lIGluIGVudiAmJlxuICAgICAgdHlwZW9mIGVudltidWNrZXROYW1lXSA9PT0gJ3N0cmluZycgJiZcbiAgICAgIHR5cGVvZiBlbnZba2V5TmFtZV0gPT09ICdzdHJpbmcnICYmXG4gICAgICB0eXBlb2YgZW52W2VuZHBvaW50TmFtZV0gPT09ICdzdHJpbmcnXG4gICAgKVxuICApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIGRhdGEgZW52aXJvbm1lbnQgdmFyaWFibGVzIGFyZSBtYWxmb3JtZWQuIGVudj0ke0pTT04uc3RyaW5naWZ5KGVudil9YFxuICAgICk7XG4gIH1cblxuICBjb25zdCBkYXRhQnVja2V0ID0gZW52W2J1Y2tldE5hbWVdIGFzIHN0cmluZztcbiAgY29uc3QgZGF0YUtleSA9IGVudltrZXlOYW1lXSBhcyBzdHJpbmc7XG4gIGNvbnN0IGRhdGFFbmRwb2ludCA9IGVudltlbmRwb2ludE5hbWVdIGFzIHN0cmluZztcblxuICByZXR1cm4ge1xuICAgIC4uLmVudixcbiAgICBkYXRhQnVja2V0LFxuICAgIGRhdGFLZXksXG4gICAgZGF0YUVuZHBvaW50LFxuICB9O1xufTtcblxuLyoqXG4gKiBHZW5lcmF0ZSB0aGUgYHJlc291cmNlQ29uZmlnYCBhbmQgYGxpYnJhcnlPcHRpb25zYCBuZWVkIHRvIGNvbmZpZ3VyZVxuICogQW1wbGlmeSBmb3IgdGhlIGRhdGEgY2xpZW50IGluIGEgbGFtYmRhLlxuICpcbiAqIFlvdXIgZnVuY3Rpb24gbmVlZHMgdG8gYmUgZ3JhbnRlZCByZXNvdXJjZSBhY2Nlc3Mgb24geW91ciBzY2hlbWEgZm9yIHRoaXMgdG8gd29ya1xuICogYGEuc2NoZW1hKC4uLikuYXV0aG9yaXphdGlvbigoYWxsb3cpID0+IFthLnJlc291cmNlKG15RnVuY3Rpb24pXSlgXG4gKiBAcGFyYW0gZW52IC0gVGhlIGVudmlyb25tZW50IHZhcmlhYmxlcyBmb3IgdGhlIGRhdGEgY2xpZW50XG4gKiBAcmV0dXJucyBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgYHJlc291cmNlQ29uZmlnYCBhbmQgYGxpYnJhcnlPcHRpb25zYFxuICovXG5leHBvcnQgY29uc3QgZ2V0QW1wbGlmeURhdGFDbGllbnRDb25maWcgPSBhc3luYyAoXG4gIGVudjogRGF0YUNsaWVudEVudixcbiAgczNDbGllbnQ/OiBTM0NsaWVudFxuKTogUHJvbWlzZTxEYXRhQ2xpZW50Q29uZmlnPiA9PiB7XG4gIGlmICghczNDbGllbnQpIHtcbiAgICBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCgpO1xuICB9XG5cbiAgY29uc3QgZGF0YU5hbWUgPSBuZXcgTmFtaW5nQ29udmVydGVyKCkudG9TY3JlYW1pbmdTbmFrZUNhc2UoXG4gICAgZW52LkFNUExJRllfREFUQV9ERUZBVUxUX05BTUVcbiAgKTtcbiAgY29uc3QgZXh0ZW5kZWRFbnYgPSBleHRlbmRFbnYoZW52LCBkYXRhTmFtZSk7XG5cbiAgbGV0IG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYTogb2JqZWN0O1xuXG4gIHRyeSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzM0NsaWVudC5zZW5kKFxuICAgICAgbmV3IEdldE9iamVjdENvbW1hbmQoe1xuICAgICAgICBCdWNrZXQ6IGV4dGVuZGVkRW52LmRhdGFCdWNrZXQsXG4gICAgICAgIEtleTogZXh0ZW5kZWRFbnYuZGF0YUtleSxcbiAgICAgIH0pXG4gICAgKTtcbiAgICBjb25zdCBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFKc29uID1cbiAgICAgIGF3YWl0IHJlc3BvbnNlLkJvZHk/LnRyYW5zZm9ybVRvU3RyaW5nKCk7XG4gICAgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hID0gSlNPTi5wYXJzZShtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFKc29uID8/ICd7fScpO1xuICB9IGNhdGNoIChjYXVnaHQpIHtcbiAgICBpZiAoY2F1Z2h0IGluc3RhbmNlb2YgTm9TdWNoS2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdFcnJvciByZXRyaWV2aW5nIHRoZSBzY2hlbWEgZnJvbSBTMy4gUGxlYXNlIGNvbmZpcm0gdGhhdCB5b3VyIHByb2plY3QgaGFzIGEgYGRlZmluZURhdGFgIGluY2x1ZGVkIGluIHRoZSBgZGVmaW5lQmFja2VuZGAgZGVmaW5pdGlvbi4nLFxuICAgICAgICB7IGNhdXNlOiBjYXVnaHQgfVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKGNhdWdodCBpbnN0YW5jZW9mIFMzU2VydmljZUV4Y2VwdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRXJyb3IgcmV0cmlldmluZyB0aGUgc2NoZW1hIGZyb20gUzMuIFlvdSBtYXkgbmVlZCB0byBncmFudCB0aGlzIGZ1bmN0aW9uIGF1dGhvcml6YXRpb24gb24gdGhlIHNjaGVtYS4gJHtjYXVnaHQubmFtZX06ICR7Y2F1Z2h0Lm1lc3NhZ2V9LmAsXG4gICAgICAgIHsgY2F1c2U6IGNhdWdodCB9XG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBjYXVnaHQ7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgbGlicmFyeU9wdGlvbnMgPSBnZXRMaWJyYXJ5T3B0aW9ucyhlbnYpO1xuXG4gIGNvbnN0IHJlc291cmNlQ29uZmlnID0gZ2V0UmVzb3VyY2VDb25maWcoXG4gICAgZXh0ZW5kZWRFbnYsXG4gICAgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hXG4gICk7XG5cbiAgcmV0dXJuIHsgcmVzb3VyY2VDb25maWcsIGxpYnJhcnlPcHRpb25zIH07XG59O1xuIl19