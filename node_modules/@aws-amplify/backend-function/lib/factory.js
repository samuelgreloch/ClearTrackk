import { AmplifyUserError, CallerDirectoryExtractor, TagName, } from '@aws-amplify/platform-core';
import { Duration, Size, Stack, Tags } from 'aws-cdk-lib';
import { Rule } from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import { Architecture, LayerVersion, Runtime, } from 'aws-cdk-lib/aws-lambda';
import { NodejsFunction, OutputFormat } from 'aws-cdk-lib/aws-lambda-nodejs';
import { readFileSync } from 'fs';
import { createRequire } from 'module';
import { EOL } from 'os';
import * as path from 'path';
import { FunctionEnvironmentTranslator } from './function_env_translator.js';
import { FunctionEnvironmentTypeGenerator } from './function_env_type_generator.js';
import { FunctionLayerArnParser } from './layer_parser.js';
import { convertLoggingOptionsToCDK } from './logging_options_parser.js';
import { convertFunctionSchedulesToRuleSchedules } from './schedule_parser.js';
import { ProvidedFunctionFactory, } from './provided_function_factory.js';
import { AmplifyFunctionBase } from './function_construct_base.js';
import { FunctionResourceAccessAcceptor } from './resource_access_acceptor.js';
/**
 * Entry point for defining a function in the Amplify ecosystem
 */
// This is the "implementation overload", it's not visible in public api.
// We have to use function notation instead of arrow notation.
// Arrow notation does not support overloads.
// eslint-disable-next-line no-restricted-syntax
export function defineFunction(propsOrProvider = {}, providerProps) {
    if (propsOrProvider && typeof propsOrProvider === 'function') {
        return new ProvidedFunctionFactory(propsOrProvider, providerProps);
    }
    return new FunctionFactory(propsOrProvider, new Error().stack);
}
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
class FunctionFactory {
    props;
    callerStack;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props, callerStack) {
        this.props = props;
        this.callerStack = callerStack;
    }
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, outputStorageStrategy, resourceNameValidator, }) => {
        if (!this.generator) {
            this.generator = new FunctionGenerator(this.hydrateDefaults(resourceNameValidator), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
    hydrateDefaults = (resourceNameValidator) => {
        const name = this.resolveName();
        resourceNameValidator?.validate(name);
        return {
            name,
            entry: this.resolveEntry(),
            timeoutSeconds: this.resolveTimeout(),
            memoryMB: this.resolveMemory(),
            ephemeralStorageSizeMB: this.resolveEphemeralStorageSize(),
            environment: this.resolveEnvironment(),
            runtime: this.resolveRuntime(),
            architecture: this.resolveArchitecture(),
            schedule: this.resolveSchedule(),
            bundling: this.resolveBundling(),
            layers: this.props.layers ?? {},
            resourceGroupName: this.props.resourceGroupName ?? 'function',
            logging: this.props.logging ?? {},
        };
    };
    resolveName = () => {
        // If name is set explicitly, use that
        if (this.props.name) {
            return this.props.name;
        }
        // If entry is set, use the basename of the entry path
        if (this.props.entry) {
            return path.parse(this.props.entry).name;
        }
        // Otherwise, use the directory name where the function is defined
        return path.basename(new CallerDirectoryExtractor(this.callerStack).extract());
    };
    resolveEntry = () => {
        // if entry is not set, default to handler.ts
        if (!this.props.entry) {
            return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), 'handler.ts');
        }
        // if entry is absolute use that
        if (path.isAbsolute(this.props.entry)) {
            return this.props.entry;
        }
        // if entry is relative, compute with respect to the caller directory
        return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), this.props.entry);
    };
    resolveTimeout = () => {
        const timeoutMin = 1;
        const timeoutMax = 60 * 15; // 15 minutes in seconds
        const timeoutDefault = 3;
        if (this.props.timeoutSeconds === undefined) {
            return timeoutDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.timeoutSeconds, timeoutMin, timeoutMax)) {
            throw new AmplifyUserError('InvalidTimeoutError', {
                message: `Invalid function timeout of ${this.props.timeoutSeconds}`,
                resolution: `timeoutSeconds must be a whole number between ${timeoutMin} and ${timeoutMax} inclusive`,
            });
        }
        return this.props.timeoutSeconds;
    };
    resolveMemory = () => {
        const memoryMin = 128;
        const memoryMax = 10240;
        const memoryDefault = 512;
        if (this.props.memoryMB === undefined) {
            return memoryDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.memoryMB, memoryMin, memoryMax)) {
            throw new AmplifyUserError('InvalidMemoryMBError', {
                message: `Invalid function memoryMB of ${this.props.memoryMB}`,
                resolution: `memoryMB must be a whole number between ${memoryMin} and ${memoryMax} inclusive`,
            });
        }
        return this.props.memoryMB;
    };
    resolveEphemeralStorageSize = () => {
        const ephemeralStorageSizeMin = 512;
        const ephemeralStorageSizeMax = 10240;
        const ephemeralStorageSizeDefault = 512;
        if (this.props.ephemeralStorageSizeMB === undefined) {
            return ephemeralStorageSizeDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.ephemeralStorageSizeMB, ephemeralStorageSizeMin, ephemeralStorageSizeMax)) {
            throw new AmplifyUserError('InvalidEphemeralStorageSizeMBError', {
                message: `Invalid function ephemeralStorageSizeMB of ${this.props.ephemeralStorageSizeMB}`,
                resolution: `ephemeralStorageSizeMB must be a whole number between ${ephemeralStorageSizeMin} and ${ephemeralStorageSizeMax} inclusive`,
            });
        }
        return this.props.ephemeralStorageSizeMB;
    };
    resolveEnvironment = () => {
        if (this.props.environment === undefined) {
            return {};
        }
        const invalidKeys = [];
        Object.keys(this.props.environment).forEach((key) => {
            // validate using key pattern from https://docs.aws.amazon.com/lambda/latest/api/API_Environment.html
            if (!key.match(/^[a-zA-Z]([a-zA-Z0-9_])+$/)) {
                invalidKeys.push(key);
            }
        });
        if (invalidKeys.length > 0) {
            throw new AmplifyUserError('InvalidEnvironmentKeyError', {
                message: `Invalid function environment key(s): ${invalidKeys.join(', ')}`,
                resolution: 'Environment keys must match [a-zA-Z]([a-zA-Z0-9_])+ and be at least 2 characters',
            });
        }
        return this.props.environment;
    };
    resolveRuntime = () => {
        const runtimeDefault = 18;
        // if runtime is not set, default to the oldest LTS
        if (!this.props.runtime) {
            return runtimeDefault;
        }
        if (!(this.props.runtime in nodeVersionMap)) {
            throw new AmplifyUserError('InvalidRuntimeError', {
                message: `Invalid function runtime of ${this.props.runtime}`,
                resolution: `runtime must be one of the following: ${Object.keys(nodeVersionMap).join(', ')}`,
            });
        }
        return this.props.runtime;
    };
    resolveArchitecture = () => {
        const architectureDefault = 'x86_64';
        if (!this.props.architecture) {
            return architectureDefault;
        }
        if (!(this.props.architecture in architectureMap)) {
            throw new AmplifyUserError('InvalidArchitectureError', {
                message: `Invalid function architecture of ${this.props.architecture}`,
                resolution: `architecture must be one of the following: ${Object.keys(architectureMap).join(', ')}`,
            });
        }
        return this.props.architecture;
    };
    resolveSchedule = () => {
        if (!this.props.schedule) {
            return [];
        }
        return this.props.schedule;
    };
    resolveBundling = () => {
        const bundlingDefault = {
            format: OutputFormat.ESM,
            bundleAwsSDK: true,
            loader: {
                '.node': 'file',
            },
            minify: true,
            sourceMap: true,
        };
        return {
            ...bundlingDefault,
            minify: this.resolveMinify(this.props.bundling),
        };
    };
    resolveMinify = (bundling) => {
        return bundling?.minify === undefined ? true : bundling.minify;
    };
}
class FunctionGenerator {
    props;
    outputStorageStrategy;
    resourceGroupName;
    constructor(props, outputStorageStrategy) {
        this.props = props;
        this.outputStorageStrategy = outputStorageStrategy;
        this.resourceGroupName = props.resourceGroupName;
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        // Move layer resolution here where we have access to scope
        const parser = new FunctionLayerArnParser(Stack.of(scope).region, Stack.of(scope).account);
        const resolvedLayerArns = parser.parseLayers(this.props.layers ?? {}, this.props.name);
        // resolve layers to LayerVersion objects for the NodejsFunction constructor
        const resolvedLayers = Object.entries(resolvedLayerArns).map(([key, arn]) => LayerVersion.fromLayerVersionArn(scope, `${this.props.name}-${key}-layer`, arn));
        return new AmplifyFunction(scope, this.props.name, { ...this.props, resolvedLayers }, backendSecretResolver, this.outputStorageStrategy);
    };
}
class AmplifyFunction extends AmplifyFunctionBase {
    resources;
    functionEnvironmentTranslator;
    constructor(scope, id, props, backendSecretResolver, outputStorageStrategy) {
        super(scope, id, outputStorageStrategy);
        const runtime = nodeVersionMap[props.runtime];
        const require = createRequire(import.meta.url);
        const shims = runtime === Runtime.NODEJS_16_X
            ? []
            : [require.resolve('./lambda-shims/cjs_shim')];
        const ssmResolverFile = runtime === Runtime.NODEJS_16_X
            ? require.resolve('./lambda-shims/resolve_ssm_params_sdk_v2') // use aws cdk v2 in node 16
            : require.resolve('./lambda-shims/resolve_ssm_params');
        const invokeSsmResolverFile = require.resolve('./lambda-shims/invoke_ssm_shim');
        /**
         * This code concatenates the contents of the ssm resolver and invoker into a single line that can be used as the esbuild banner content
         * This banner is responsible for resolving the customer's SSM parameters at runtime
         */
        const bannerCode = readFileSync(ssmResolverFile, 'utf-8')
            .concat(readFileSync(invokeSsmResolverFile, 'utf-8'))
            .split(new RegExp(`${EOL}|\n|\r`, 'g'))
            .map((line) => line.replace(/\/\/.*$/, '')) // strip out inline comments because the banner is going to be flattened into a single line
            .join('');
        const functionEnvironmentTypeGenerator = new FunctionEnvironmentTypeGenerator(id);
        // esbuild runs as part of the NodejsFunction constructor, so we eagerly generate the process env shim without types so it can be included in the function bundle.
        // This will be overwritten with the typed file at the end of synthesis
        functionEnvironmentTypeGenerator.generateProcessEnvShim();
        let functionLambda;
        const cdkLoggingOptions = convertLoggingOptionsToCDK(props.logging);
        try {
            functionLambda = new NodejsFunction(scope, `${id}-lambda`, {
                entry: props.entry,
                timeout: Duration.seconds(props.timeoutSeconds),
                memorySize: props.memoryMB,
                architecture: architectureMap[props.architecture],
                ephemeralStorageSize: Size.mebibytes(props.ephemeralStorageSizeMB),
                runtime: nodeVersionMap[props.runtime],
                layers: props.resolvedLayers,
                bundling: {
                    ...props.bundling,
                    banner: bannerCode,
                    inject: shims,
                    externalModules: Object.keys(props.layers),
                },
                logRetention: cdkLoggingOptions.retention,
                applicationLogLevelV2: cdkLoggingOptions.level,
                loggingFormat: cdkLoggingOptions.format,
            });
        }
        catch (error) {
            // If the error is from ES Bundler which is executed as a child process by CDK,
            // then the error from CDK contains the command that was executed along with the exit status.
            // Wrapping it here  would cause the cdk_deployer to re-throw this wrapped exception
            // instead of scraping the stderr for actual ESBuild error.
            if (error instanceof Error &&
                error.message.match(/Failed to bundle asset.*exited with status/)) {
                throw error;
            }
            throw new AmplifyUserError('NodeJSFunctionConstructInitializationError', {
                message: 'Failed to instantiate nodejs function construct',
                resolution: 'See the underlying error message for more details. Use `--debug` for additional debugging information.',
            }, error);
        }
        try {
            const schedules = convertFunctionSchedulesToRuleSchedules(functionLambda, props.schedule);
            const lambdaTarget = new targets.LambdaFunction(functionLambda);
            schedules.forEach((schedule, index) => {
                // Lambda name will be prepended to rule id, so only using index here for uniqueness
                const rule = new Rule(functionLambda, `schedule${index}`, {
                    schedule,
                });
                rule.addTarget(lambdaTarget);
            });
        }
        catch (error) {
            throw new AmplifyUserError('FunctionScheduleInitializationError', {
                message: 'Failed to instantiate schedule for nodejs function',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(functionLambda).add(TagName.FRIENDLY_NAME, id);
        this.functionEnvironmentTranslator = new FunctionEnvironmentTranslator(functionLambda, props.environment, backendSecretResolver, functionEnvironmentTypeGenerator);
        this.resources = {
            lambda: functionLambda,
            cfnResources: {
                cfnFunction: functionLambda.node.findChild('Resource'),
            },
        };
        this.storeOutput();
    }
    addEnvironment = (key, value) => {
        this.functionEnvironmentTranslator.addEnvironmentEntry(key, value);
    };
    getResourceAccessAcceptor = () => new FunctionResourceAccessAcceptor(this, this.functionEnvironmentTranslator);
}
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const nodeVersionMap = {
    16: Runtime.NODEJS_16_X,
    18: Runtime.NODEJS_18_X,
    20: Runtime.NODEJS_20_X,
    22: Runtime.NODEJS_22_X,
};
const architectureMap = {
    arm64: Architecture.ARM_64,
    x86_64: Architecture.X86_64,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLE9BQU8sR0FDUixNQUFNLDRCQUE0QixDQUFDO0FBbUJwQyxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzFELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM5QyxPQUFPLEtBQUssT0FBTyxNQUFNLGdDQUFnQyxDQUFDO0FBQzFELE9BQU8sRUFDTCxZQUFZLEVBSVosWUFBWSxFQUNaLE9BQU8sR0FDUixNQUFNLHdCQUF3QixDQUFDO0FBQ2hDLE9BQU8sRUFBRSxjQUFjLEVBQUUsWUFBWSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFFN0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLElBQUksQ0FBQztBQUNsQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDN0UsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEYsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDM0QsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDekUsT0FBTyxFQUFFLHVDQUF1QyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0UsT0FBTyxFQUNMLHVCQUF1QixHQUV4QixNQUFNLGdDQUFnQyxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxN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SUFDckIsQ0FBQztJQUVELGNBQWMsR0FBRyxDQUFDLEdBQVcsRUFBRSxLQUE2QixFQUFFLEVBQUU7UUFDOUQsSUFBSSxDQUFDLDZCQUE2QixDQUFDLG1CQUFtQixDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNyRSxDQUFDLENBQUM7SUFFRix5QkFBeUIsR0FBRyxHQUEyQixFQUFFLENBQ3ZELElBQUksOEJBQThCLENBQ2hDLElBQUksRUFDSixJQUFJLENBQUMsNkJBQTZCLENBQ25DLENBQUM7Q0FDTDtBQUVELE1BQU0sNkJBQTZCLEdBQUcsQ0FDcEMsSUFBWSxFQUNaLEdBQVcsRUFDWCxHQUFXLEVBQ1gsRUFBRSxDQUFDLEdBQUcsSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLEdBQUcsSUFBSSxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUlsRCxNQUFNLGNBQWMsR0FBaUM7SUFDbkQsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0lBQ3ZCLEVBQUUsRUFBRSxPQUFPLENBQUMsV0FBVztJQUN2QixFQUFFLEVBQUUsT0FBTyxDQUFDLFdBQVc7SUFDdkIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0NBQ3hCLENBQUM7QUFJRixNQUFNLGVBQWUsR0FBK0M7SUFDbEUsS0FBSyxFQUFFLFlBQVksQ0FBQyxNQUFNO0lBQzFCLE1BQU0sRUFBRSxZQUFZLENBQUMsTUFBTTtDQUM1QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRnVuY3Rpb25PdXRwdXQgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQge1xuICBBbXBsaWZ5VXNlckVycm9yLFxuICBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IsXG4gIFRhZ05hbWUsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSxcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgQmFja2VuZFNlY3JldCxcbiAgQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcixcbiAgQ29uc3RydWN0RmFjdG9yeSxcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIEZ1bmN0aW9uUmVzb3VyY2VzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIExvZ0xldmVsLFxuICBMb2dSZXRlbnRpb24sXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3IsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5LFxuICBSZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gIFJlc291cmNlUHJvdmlkZXIsXG4gIFN0YWNrUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgRHVyYXRpb24sIFNpemUsIFN0YWNrLCBUYWdzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgUnVsZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1ldmVudHMnO1xuaW1wb3J0ICogYXMgdGFyZ2V0cyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzLXRhcmdldHMnO1xuaW1wb3J0IHtcbiAgQXJjaGl0ZWN0dXJlLFxuICBDZm5GdW5jdGlvbixcbiAgSUZ1bmN0aW9uLFxuICBJTGF5ZXJWZXJzaW9uLFxuICBMYXllclZlcnNpb24sXG4gIFJ1bnRpbWUsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgTm9kZWpzRnVuY3Rpb24sIE91dHB1dEZvcm1hdCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgY3JlYXRlUmVxdWlyZSB9IGZyb20gJ21vZHVsZSc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IgfSBmcm9tICcuL2Z1bmN0aW9uX2Vudl90cmFuc2xhdG9yLmpzJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHlwZV9nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgRnVuY3Rpb25MYXllckFyblBhcnNlciB9IGZyb20gJy4vbGF5ZXJfcGFyc2VyLmpzJztcbmltcG9ydCB7IGNvbnZlcnRMb2dnaW5nT3B0aW9uc1RvQ0RLIH0gZnJvbSAnLi9sb2dnaW5nX29wdGlvbnNfcGFyc2VyLmpzJztcbmltcG9ydCB7IGNvbnZlcnRGdW5jdGlvblNjaGVkdWxlc1RvUnVsZVNjaGVkdWxlcyB9IGZyb20gJy4vc2NoZWR1bGVfcGFyc2VyLmpzJztcbmltcG9ydCB7XG4gIFByb3ZpZGVkRnVuY3Rpb25GYWN0b3J5LFxuICBQcm92aWRlZEZ1bmN0aW9uUHJvcHMsXG59IGZyb20gJy4vcHJvdmlkZWRfZnVuY3Rpb25fZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBBbXBsaWZ5RnVuY3Rpb25CYXNlIH0gZnJvbSAnLi9mdW5jdGlvbl9jb25zdHJ1Y3RfYmFzZS5qcyc7XG5pbXBvcnQgeyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IgfSBmcm9tICcuL3Jlc291cmNlX2FjY2Vzc19hY2NlcHRvci5qcyc7XG5cbmV4cG9ydCB0eXBlIEFkZEVudmlyb25tZW50RmFjdG9yeSA9IHtcbiAgYWRkRW52aXJvbm1lbnQ6IChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IEJhY2tlbmRTZWNyZXQpID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgdHlwZSBDcm9uU2NoZWR1bGUgPVxuICB8IGAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9YFxuICB8IGAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfWA7XG5leHBvcnQgdHlwZSBUaW1lSW50ZXJ2YWwgPVxuICB8IGBldmVyeSAke251bWJlcn1tYFxuICB8IGBldmVyeSAke251bWJlcn1oYFxuICB8IGBldmVyeSBkYXlgXG4gIHwgYGV2ZXJ5IHdlZWtgXG4gIHwgYGV2ZXJ5IG1vbnRoYFxuICB8IGBldmVyeSB5ZWFyYDtcbmV4cG9ydCB0eXBlIEZ1bmN0aW9uU2NoZWR1bGUgPSBUaW1lSW50ZXJ2YWwgfCBDcm9uU2NoZWR1bGU7XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uTG9nTGV2ZWwgPSBFeHRyYWN0PFxuICBMb2dMZXZlbCxcbiAgJ2luZm8nIHwgJ2RlYnVnJyB8ICd3YXJuJyB8ICdlcnJvcicgfCAnZmF0YWwnIHwgJ3RyYWNlJ1xuPjtcbmV4cG9ydCB0eXBlIEZ1bmN0aW9uTG9nUmV0ZW50aW9uID0gTG9nUmV0ZW50aW9uO1xuXG5leHBvcnQgZnVuY3Rpb24gZGVmaW5lRnVuY3Rpb24oXG4gIHByb3BzPzogRnVuY3Rpb25Qcm9wc1xuKTogQ29uc3RydWN0RmFjdG9yeTxcbiAgUmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4gJlxuICAgIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5ICZcbiAgICBBZGRFbnZpcm9ubWVudEZhY3RvcnkgJlxuICAgIFN0YWNrUHJvdmlkZXJcbj47XG5leHBvcnQgZnVuY3Rpb24gZGVmaW5lRnVuY3Rpb24oXG4gIHByb3ZpZGVyOiAoc2NvcGU6IENvbnN0cnVjdCkgPT4gSUZ1bmN0aW9uLFxuICBwcm92aWRlclByb3BzPzogUHJvdmlkZWRGdW5jdGlvblByb3BzXG4pOiBDb25zdHJ1Y3RGYWN0b3J5PFxuICBSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPiAmXG4gICAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnkgJlxuICAgIFN0YWNrUHJvdmlkZXJcbj47XG4vKipcbiAqIEVudHJ5IHBvaW50IGZvciBkZWZpbmluZyBhIGZ1bmN0aW9uIGluIHRoZSBBbXBsaWZ5IGVjb3N5c3RlbVxuICovXG4vLyBUaGlzIGlzIHRoZSBcImltcGxlbWVudGF0aW9uIG92ZXJsb2FkXCIsIGl0J3Mgbm90IHZpc2libGUgaW4gcHVibGljIGFwaS5cbi8vIFdlIGhhdmUgdG8gdXNlIGZ1bmN0aW9uIG5vdGF0aW9uIGluc3RlYWQgb2YgYXJyb3cgbm90YXRpb24uXG4vLyBBcnJvdyBub3RhdGlvbiBkb2VzIG5vdCBzdXBwb3J0IG92ZXJsb2Fkcy5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1yZXN0cmljdGVkLXN5bnRheFxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZUZ1bmN0aW9uKFxuICBwcm9wc09yUHJvdmlkZXI6IEZ1bmN0aW9uUHJvcHMgfCAoKHNjb3BlOiBDb25zdHJ1Y3QpID0+IElGdW5jdGlvbikgPSB7fSxcbiAgcHJvdmlkZXJQcm9wcz86IFByb3ZpZGVkRnVuY3Rpb25Qcm9wc1xuKTogdW5rbm93biB7XG4gIGlmIChwcm9wc09yUHJvdmlkZXIgJiYgdHlwZW9mIHByb3BzT3JQcm92aWRlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBuZXcgUHJvdmlkZWRGdW5jdGlvbkZhY3RvcnkocHJvcHNPclByb3ZpZGVyLCBwcm92aWRlclByb3BzKTtcbiAgfVxuICByZXR1cm4gbmV3IEZ1bmN0aW9uRmFjdG9yeShwcm9wc09yUHJvdmlkZXIsIG5ldyBFcnJvcigpLnN0YWNrKTtcbn1cblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25Qcm9wcyA9IHtcbiAgLyoqXG4gICAqIEEgbmFtZSBmb3IgdGhlIGZ1bmN0aW9uLlxuICAgKiBEZWZhdWx0cyB0byB0aGUgYmFzZW5hbWUgb2YgdGhlIGVudHJ5IHBhdGggaWYgc3BlY2lmaWVkLlxuICAgKiBJZiBubyBlbnRyeSBpcyBzcGVjaWZpZWQsIGRlZmF1bHRzIHRvIHRoZSBkaXJlY3RvcnkgbmFtZSBpbiB3aGljaCB0aGlzIGZ1bmN0aW9uIGlzIGRlZmluZWQuXG4gICAqXG4gICAqIEV4YW1wbGU6XG4gICAqIElmIGVudHJ5IGlzIGAuL3NjaGVkdWxlZC1kYi1iYWNrdXAudHNgIHRoZSBuYW1lIHdpbGwgZGVmYXVsdCB0byBcInNjaGVkdWxlZC1kYi1iYWNrdXBcIlxuICAgKiBJZiBlbnRyeSBpcyBub3Qgc2V0IGFuZCB0aGUgZnVuY3Rpb24gaXMgZGVmaW5lZCBpbiBgYW1wbGlmeS9mdW5jdGlvbnMvZGItYmFja3VwL3Jlc291cmNlLnRzYCB0aGUgbmFtZSB3aWxsIGRlZmF1bHQgdG8gXCJkYi1iYWNrdXBcIlxuICAgKi9cbiAgbmFtZT86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBmaWxlIHRoYXQgY29udGFpbnMgdGhlIGZ1bmN0aW9uIGVudHJ5IHBvaW50LlxuICAgKiBJZiB0aGlzIGlzIGEgcmVsYXRpdmUgcGF0aCwgaXQgaXMgY29tcHV0ZWQgcmVsYXRpdmUgdG8gdGhlIGZpbGUgd2hlcmUgdGhpcyBmdW5jdGlvbiBpcyBkZWZpbmVkXG4gICAqXG4gICAqIERlZmF1bHRzIHRvICcuL2hhbmRsZXIudHMnXG4gICAqL1xuICBlbnRyeT86IHN0cmluZztcblxuICAvKipcbiAgICogQW4gYW1vdW50IG9mIHRpbWUgaW4gc2Vjb25kcyBiZXR3ZWVuIDEgc2Vjb25kIGFuZCAxNSBtaW51dGVzLlxuICAgKiBNdXN0IGJlIGEgd2hvbGUgbnVtYmVyLlxuICAgKiBEZWZhdWx0IGlzIDMgc2Vjb25kcy5cbiAgICovXG4gIHRpbWVvdXRTZWNvbmRzPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBBbiBhbW91bnQgb2YgbWVtb3J5IChSQU0pIHRvIGFsbG9jYXRlIHRvIHRoZSBmdW5jdGlvbiBiZXR3ZWVuIDEyOCBhbmQgMTAyNDAgTUIuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIERlZmF1bHQgaXMgNTEyTUIuXG4gICAqL1xuICBtZW1vcnlNQj86IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIHNpemUgb2YgdGhlIGZ1bmN0aW9uJ3MgL3RtcCBkaXJlY3RvcnkgaW4gTUIuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIEBkZWZhdWx0IDUxMlxuICAgKi9cbiAgZXBoZW1lcmFsU3RvcmFnZVNpemVNQj86IG51bWJlcjtcblxuICAvKipcbiAgICogRW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgZHVyaW5nIGZ1bmN0aW9uIGV4ZWN1dGlvblxuICAgKi9cbiAgZW52aXJvbm1lbnQ/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0PjtcblxuICAvKipcbiAgICogTm9kZSBydW50aW1lIHZlcnNpb24gZm9yIHRoZSBsYW1iZGEgZW52aXJvbm1lbnQuXG4gICAqXG4gICAqIERlZmF1bHRzIHRvIHRoZSBvbGRlc3QgTm9kZUpTIExUUyB2ZXJzaW9uLiBTZWUgaHR0cHM6Ly9ub2RlanMub3JnL2VuL2Fib3V0L3ByZXZpb3VzLXJlbGVhc2VzXG4gICAqL1xuICBydW50aW1lPzogTm9kZVZlcnNpb247XG5cbiAgLyoqXG4gICAqIFRoZSBhcmNoaXRlY3R1cmUgb2YgdGhlIHRhcmdldCBwbGF0Zm9ybSBmb3IgdGhlIGxhbWJkYSBlbnZpcm9ubWVudC5cbiAgICogRGVmYXVsdHMgdG8gWDg2XzY0LlxuICAgKi9cbiAgYXJjaGl0ZWN0dXJlPzogRnVuY3Rpb25BcmNoaXRlY3R1cmU7XG5cbiAgLyoqXG4gICAqIEEgdGltZSBpbnRlcnZhbCBzdHJpbmcgdG8gcGVyaW9kaWNhbGx5IHJ1biB0aGUgZnVuY3Rpb24uXG4gICAqIFRoaXMgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvZiBgXCJldmVyeSA8cG9zaXRpdmUgd2hvbGUgbnVtYmVyPjxtIChtaW51dGUpIG9yIGggKGhvdXIpPlwiYCwgYFwiZXZlcnkgZGF5fHdlZWt8bW9udGh8eWVhclwiYCBvciBjcm9uIGV4cHJlc3Npb24uXG4gICAqIERlZmF1bHRzIHRvIG5vIHNjaGVkdWxpbmcgZm9yIHRoZSBmdW5jdGlvbi5cbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiZXZlcnkgNW1cIlxuICAgKiBAZXhhbXBsZVxuICAgKiBzY2hlZHVsZTogXCJldmVyeSB3ZWVrXCJcbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiMCA5ID8gKiAyICpcIiAvLyBldmVyeSBNb25kYXkgYXQgOWFtXG4gICAqL1xuICBzY2hlZHVsZT86IEZ1bmN0aW9uU2NoZWR1bGUgfCBGdW5jdGlvblNjaGVkdWxlW107XG5cbiAgLyoqXG4gICAqIEF0dGFjaCBMYW1iZGEgbGF5ZXJzIHRvIGEgZnVuY3Rpb25cbiAgICogLSBBIExhbWJkYSBsYXllciBpcyByZXByZXNlbnRlZCBieSBhbiBvYmplY3Qgb2Yga2V5L3ZhbHVlIHBhaXIgd2hlcmUgdGhlIGtleSBpcyB0aGUgbW9kdWxlIG5hbWUgdGhhdCBpcyBleHBvcnRlZCBmcm9tIHlvdXIgbGF5ZXIgYW5kIHRoZSB2YWx1ZSBpcyB0aGUgQVJOIG9mIHRoZSBsYXllci4gVGhlIGtleSAobW9kdWxlIG5hbWUpIGlzIHVzZWQgdG8gZXh0ZXJuYWxpemUgdGhlIG1vZHVsZSBkZXBlbmRlbmN5IHNvIGl0IGRvZXNuJ3QgZ2V0IGJ1bmRsZWQgd2l0aCB5b3VyIGxhbWJkYSBmdW5jdGlvblxuICAgKiAtIE1heGltdW0gb2YgNSBsYXllcnMgY2FuIGJlIGF0dGFjaGVkIHRvIGEgZnVuY3Rpb24gYW5kIG11c3QgYmUgaW4gdGhlIHNhbWUgcmVnaW9uIGFzIHRoZSBmdW5jdGlvbi5cbiAgICogQGV4YW1wbGVcbiAgICogbGF5ZXJzOiB7XG4gICAqICAgIFwiQGF3cy1sYW1iZGEtcG93ZXJ0b29scy9sb2dnZXJcIjogXCJhcm46YXdzOmxhbWJkYTo8Y3VycmVudC1yZWdpb24+OjA5NDI3NDEwNTkxNTpsYXllcjpBV1NMYW1iZGFQb3dlcnRvb2xzVHlwZVNjcmlwdFYyOjExXCJcbiAgICogfSxcbiAgICogb3JcbiAgICogQGV4YW1wbGVcbiAgICogbGF5ZXJzOiB7XG4gICAqICAgIFwiU2hhcnBcIjogXCJTaGFycExheWVyOjFcIlxuICAgKiB9LFxuICAgKiBAc2VlIFtBbXBsaWZ5IGRvY3VtZW50YXRpb24gZm9yIExhbWJkYSBsYXllcnNdKGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvZnVuY3Rpb25zL2FkZC1sYW1iZGEtbGF5ZXJzKVxuICAgKiBAc2VlIFtBV1MgZG9jdW1lbnRhdGlvbiBmb3IgTGFtYmRhIGxheWVyc10oaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvY2hhcHRlci1sYXllcnMuaHRtbClcbiAgICovXG4gIGxheWVycz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgLypcbiAgICogT3B0aW9ucyBmb3IgYnVuZGxpbmcgdGhlIGZ1bmN0aW9uIGNvZGUuXG4gICAqL1xuICBidW5kbGluZz86IEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBHcm91cCB0aGUgZnVuY3Rpb24gd2l0aCBleGlzdGluZyBBbXBsaWZ5IHJlc291cmNlcyBvciBzZXBhcmF0ZSB0aGUgZnVuY3Rpb24gaW50byBpdHMgb3duIGdyb3VwLlxuICAgKiBAZGVmYXVsdCAnZnVuY3Rpb24nIC8vIGdyb3VwaW5nIHdpdGggb3RoZXIgQW1wbGlmeSBmdW5jdGlvbnNcbiAgICogQGV4YW1wbGVcbiAgICogcmVzb3VyY2VHcm91cE5hbWU6ICdhdXRoJyAvLyB0byBncm91cCBhbiBhdXRoIHRyaWdnZXIgd2l0aCBhbiBhdXRoIHJlc291cmNlXG4gICAqL1xuICByZXNvdXJjZUdyb3VwTmFtZT86IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZTtcblxuICBsb2dnaW5nPzogRnVuY3Rpb25Mb2dnaW5nT3B0aW9ucztcbn07XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zID0ge1xuICAvKipcbiAgICogV2hldGhlciB0byBtaW5pZnkgdGhlIGZ1bmN0aW9uIGNvZGUuXG4gICAqXG4gICAqIERlZmF1bHRzIHRvIHRydWUuXG4gICAqL1xuICBtaW5pZnk/OiBib29sZWFuO1xufTtcblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25Mb2dnaW5nT3B0aW9ucyA9IChcbiAgfCB7XG4gICAgICBmb3JtYXQ6ICdqc29uJztcbiAgICAgIGxldmVsPzogRnVuY3Rpb25Mb2dMZXZlbDtcbiAgICB9XG4gIHwge1xuICAgICAgZm9ybWF0PzogJ3RleHQnO1xuICAgIH1cbikgJiB7XG4gIHJldGVudGlvbj86IEZ1bmN0aW9uTG9nUmV0ZW50aW9uO1xufTtcblxuLyoqXG4gKiBDcmVhdGUgTGFtYmRhIGZ1bmN0aW9ucyBpbiB0aGUgY29udGV4dCBvZiBhbiBBbXBsaWZ5IGJhY2tlbmQgZGVmaW5pdGlvblxuICovXG5jbGFzcyBGdW5jdGlvbkZhY3RvcnkgaW1wbGVtZW50cyBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlGdW5jdGlvbj4ge1xuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhbGxlclN0YWNrPzogc3RyaW5nXG4gICkge31cblxuICAvKipcbiAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBBbXBsaWZ5RnVuY3Rpb24gd2l0aGluIHRoZSBwcm92aWRlZCBBbXBsaWZ5IGNvbnRleHRcbiAgICovXG4gIGdldEluc3RhbmNlID0gKHtcbiAgICBjb25zdHJ1Y3RDb250YWluZXIsXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgIHJlc291cmNlTmFtZVZhbGlkYXRvcixcbiAgfTogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMpOiBBbXBsaWZ5RnVuY3Rpb24gPT4ge1xuICAgIGlmICghdGhpcy5nZW5lcmF0b3IpIHtcbiAgICAgIHRoaXMuZ2VuZXJhdG9yID0gbmV3IEZ1bmN0aW9uR2VuZXJhdG9yKFxuICAgICAgICB0aGlzLmh5ZHJhdGVEZWZhdWx0cyhyZXNvdXJjZU5hbWVWYWxpZGF0b3IpLFxuICAgICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3lcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBjb25zdHJ1Y3RDb250YWluZXIuZ2V0T3JDb21wdXRlKHRoaXMuZ2VuZXJhdG9yKSBhcyBBbXBsaWZ5RnVuY3Rpb247XG4gIH07XG5cbiAgcHJpdmF0ZSBoeWRyYXRlRGVmYXVsdHMgPSAoXG4gICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yPzogUmVzb3VyY2VOYW1lVmFsaWRhdG9yXG4gICk6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHRoaXMucmVzb2x2ZU5hbWUoKTtcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/LnZhbGlkYXRlKG5hbWUpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBlbnRyeTogdGhpcy5yZXNvbHZlRW50cnkoKSxcbiAgICAgIHRpbWVvdXRTZWNvbmRzOiB0aGlzLnJlc29sdmVUaW1lb3V0KCksXG4gICAgICBtZW1vcnlNQjogdGhpcy5yZXNvbHZlTWVtb3J5KCksXG4gICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1COiB0aGlzLnJlc29sdmVFcGhlbWVyYWxTdG9yYWdlU2l6ZSgpLFxuICAgICAgZW52aXJvbm1lbnQ6IHRoaXMucmVzb2x2ZUVudmlyb25tZW50KCksXG4gICAgICBydW50aW1lOiB0aGlzLnJlc29sdmVSdW50aW1lKCksXG4gICAgICBhcmNoaXRlY3R1cmU6IHRoaXMucmVzb2x2ZUFyY2hpdGVjdHVyZSgpLFxuICAgICAgc2NoZWR1bGU6IHRoaXMucmVzb2x2ZVNjaGVkdWxlKCksXG4gICAgICBidW5kbGluZzogdGhpcy5yZXNvbHZlQnVuZGxpbmcoKSxcbiAgICAgIGxheWVyczogdGhpcy5wcm9wcy5sYXllcnMgPz8ge30sXG4gICAgICByZXNvdXJjZUdyb3VwTmFtZTogdGhpcy5wcm9wcy5yZXNvdXJjZUdyb3VwTmFtZSA/PyAnZnVuY3Rpb24nLFxuICAgICAgbG9nZ2luZzogdGhpcy5wcm9wcy5sb2dnaW5nID8/IHt9LFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlTmFtZSA9ICgpID0+IHtcbiAgICAvLyBJZiBuYW1lIGlzIHNldCBleHBsaWNpdGx5LCB1c2UgdGhhdFxuICAgIGlmICh0aGlzLnByb3BzLm5hbWUpIHtcbiAgICAgIHJldHVybiB0aGlzLnByb3BzLm5hbWU7XG4gICAgfVxuICAgIC8vIElmIGVudHJ5IGlzIHNldCwgdXNlIHRoZSBiYXNlbmFtZSBvZiB0aGUgZW50cnkgcGF0aFxuICAgIGlmICh0aGlzLnByb3BzLmVudHJ5KSB7XG4gICAgICByZXR1cm4gcGF0aC5wYXJzZSh0aGlzLnByb3BzLmVudHJ5KS5uYW1lO1xuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSwgdXNlIHRoZSBkaXJlY3RvcnkgbmFtZSB3aGVyZSB0aGUgZnVuY3Rpb24gaXMgZGVmaW5lZFxuICAgIHJldHVybiBwYXRoLmJhc2VuYW1lKFxuICAgICAgbmV3IENhbGxlckRpcmVjdG9yeUV4dHJhY3Rvcih0aGlzLmNhbGxlclN0YWNrKS5leHRyYWN0KClcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUVudHJ5ID0gKCkgPT4ge1xuICAgIC8vIGlmIGVudHJ5IGlzIG5vdCBzZXQsIGRlZmF1bHQgdG8gaGFuZGxlci50c1xuICAgIGlmICghdGhpcy5wcm9wcy5lbnRyeSkge1xuICAgICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgICAgbmV3IENhbGxlckRpcmVjdG9yeUV4dHJhY3Rvcih0aGlzLmNhbGxlclN0YWNrKS5leHRyYWN0KCksXG4gICAgICAgICdoYW5kbGVyLnRzJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBpZiBlbnRyeSBpcyBhYnNvbHV0ZSB1c2UgdGhhdFxuICAgIGlmIChwYXRoLmlzQWJzb2x1dGUodGhpcy5wcm9wcy5lbnRyeSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnByb3BzLmVudHJ5O1xuICAgIH1cblxuICAgIC8vIGlmIGVudHJ5IGlzIHJlbGF0aXZlLCBjb21wdXRlIHdpdGggcmVzcGVjdCB0byB0aGUgY2FsbGVyIGRpcmVjdG9yeVxuICAgIHJldHVybiBwYXRoLmpvaW4oXG4gICAgICBuZXcgQ2FsbGVyRGlyZWN0b3J5RXh0cmFjdG9yKHRoaXMuY2FsbGVyU3RhY2spLmV4dHJhY3QoKSxcbiAgICAgIHRoaXMucHJvcHMuZW50cnlcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVRpbWVvdXQgPSAoKSA9PiB7XG4gICAgY29uc3QgdGltZW91dE1pbiA9IDE7XG4gICAgY29uc3QgdGltZW91dE1heCA9IDYwICogMTU7IC8vIDE1IG1pbnV0ZXMgaW4gc2Vjb25kc1xuICAgIGNvbnN0IHRpbWVvdXREZWZhdWx0ID0gMztcbiAgICBpZiAodGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdGltZW91dERlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKFxuICAgICAgICB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzLFxuICAgICAgICB0aW1lb3V0TWluLFxuICAgICAgICB0aW1lb3V0TWF4XG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZFRpbWVvdXRFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gdGltZW91dCBvZiAke3RoaXMucHJvcHMudGltZW91dFNlY29uZHN9YCxcbiAgICAgICAgcmVzb2x1dGlvbjogYHRpbWVvdXRTZWNvbmRzIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke3RpbWVvdXRNaW59IGFuZCAke3RpbWVvdXRNYXh9IGluY2x1c2l2ZWAsXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJvcHMudGltZW91dFNlY29uZHM7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlTWVtb3J5ID0gKCkgPT4ge1xuICAgIGNvbnN0IG1lbW9yeU1pbiA9IDEyODtcbiAgICBjb25zdCBtZW1vcnlNYXggPSAxMDI0MDtcbiAgICBjb25zdCBtZW1vcnlEZWZhdWx0ID0gNTEyO1xuICAgIGlmICh0aGlzLnByb3BzLm1lbW9yeU1CID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBtZW1vcnlEZWZhdWx0O1xuICAgIH1cbiAgICBpZiAoXG4gICAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUodGhpcy5wcm9wcy5tZW1vcnlNQiwgbWVtb3J5TWluLCBtZW1vcnlNYXgpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZE1lbW9yeU1CRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIGZ1bmN0aW9uIG1lbW9yeU1CIG9mICR7dGhpcy5wcm9wcy5tZW1vcnlNQn1gLFxuICAgICAgICByZXNvbHV0aW9uOiBgbWVtb3J5TUIgbXVzdCBiZSBhIHdob2xlIG51bWJlciBiZXR3ZWVuICR7bWVtb3J5TWlufSBhbmQgJHttZW1vcnlNYXh9IGluY2x1c2l2ZWAsXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJvcHMubWVtb3J5TUI7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlRXBoZW1lcmFsU3RvcmFnZVNpemUgPSAoKSA9PiB7XG4gICAgY29uc3QgZXBoZW1lcmFsU3RvcmFnZVNpemVNaW4gPSA1MTI7XG4gICAgY29uc3QgZXBoZW1lcmFsU3RvcmFnZVNpemVNYXggPSAxMDI0MDtcbiAgICBjb25zdCBlcGhlbWVyYWxTdG9yYWdlU2l6ZURlZmF1bHQgPSA1MTI7XG4gICAgaWYgKHRoaXMucHJvcHMuZXBoZW1lcmFsU3RvcmFnZVNpemVNQiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gZXBoZW1lcmFsU3RvcmFnZVNpemVEZWZhdWx0O1xuICAgIH1cbiAgICBpZiAoXG4gICAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoXG4gICAgICAgIHRoaXMucHJvcHMuZXBoZW1lcmFsU3RvcmFnZVNpemVNQixcbiAgICAgICAgZXBoZW1lcmFsU3RvcmFnZVNpemVNaW4sXG4gICAgICAgIGVwaGVtZXJhbFN0b3JhZ2VTaXplTWF4XG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZEVwaGVtZXJhbFN0b3JhZ2VTaXplTUJFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gZXBoZW1lcmFsU3RvcmFnZVNpemVNQiBvZiAke3RoaXMucHJvcHMuZXBoZW1lcmFsU3RvcmFnZVNpemVNQn1gLFxuICAgICAgICByZXNvbHV0aW9uOiBgZXBoZW1lcmFsU3RvcmFnZVNpemVNQiBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHtlcGhlbWVyYWxTdG9yYWdlU2l6ZU1pbn0gYW5kICR7ZXBoZW1lcmFsU3RvcmFnZVNpemVNYXh9IGluY2x1c2l2ZWAsXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJvcHMuZXBoZW1lcmFsU3RvcmFnZVNpemVNQjtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVFbnZpcm9ubWVudCA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5wcm9wcy5lbnZpcm9ubWVudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgY29uc3QgaW52YWxpZEtleXM6IHN0cmluZ1tdID0gW107XG5cbiAgICBPYmplY3Qua2V5cyh0aGlzLnByb3BzLmVudmlyb25tZW50KS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIC8vIHZhbGlkYXRlIHVzaW5nIGtleSBwYXR0ZXJuIGZyb20gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvYXBpL0FQSV9FbnZpcm9ubWVudC5odG1sXG4gICAgICBpZiAoIWtleS5tYXRjaCgvXlthLXpBLVpdKFthLXpBLVowLTlfXSkrJC8pKSB7XG4gICAgICAgIGludmFsaWRLZXlzLnB1c2goa2V5KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChpbnZhbGlkS2V5cy5sZW5ndGggPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZEVudmlyb25tZW50S2V5RXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIGZ1bmN0aW9uIGVudmlyb25tZW50IGtleShzKTogJHtpbnZhbGlkS2V5cy5qb2luKFxuICAgICAgICAgICcsICdcbiAgICAgICAgKX1gLFxuICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICdFbnZpcm9ubWVudCBrZXlzIG11c3QgbWF0Y2ggW2EtekEtWl0oW2EtekEtWjAtOV9dKSsgYW5kIGJlIGF0IGxlYXN0IDIgY2hhcmFjdGVycycsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5lbnZpcm9ubWVudDtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVSdW50aW1lID0gKCkgPT4ge1xuICAgIGNvbnN0IHJ1bnRpbWVEZWZhdWx0ID0gMTg7XG5cbiAgICAvLyBpZiBydW50aW1lIGlzIG5vdCBzZXQsIGRlZmF1bHQgdG8gdGhlIG9sZGVzdCBMVFNcbiAgICBpZiAoIXRoaXMucHJvcHMucnVudGltZSkge1xuICAgICAgcmV0dXJuIHJ1bnRpbWVEZWZhdWx0O1xuICAgIH1cblxuICAgIGlmICghKHRoaXMucHJvcHMucnVudGltZSBpbiBub2RlVmVyc2lvbk1hcCkpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkUnVudGltZUVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBydW50aW1lIG9mICR7dGhpcy5wcm9wcy5ydW50aW1lfWAsXG4gICAgICAgIHJlc29sdXRpb246IGBydW50aW1lIG11c3QgYmUgb25lIG9mIHRoZSBmb2xsb3dpbmc6ICR7T2JqZWN0LmtleXMoXG4gICAgICAgICAgbm9kZVZlcnNpb25NYXBcbiAgICAgICAgKS5qb2luKCcsICcpfWAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5ydW50aW1lO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUFyY2hpdGVjdHVyZSA9ICgpID0+IHtcbiAgICBjb25zdCBhcmNoaXRlY3R1cmVEZWZhdWx0ID0gJ3g4Nl82NCc7XG5cbiAgICBpZiAoIXRoaXMucHJvcHMuYXJjaGl0ZWN0dXJlKSB7XG4gICAgICByZXR1cm4gYXJjaGl0ZWN0dXJlRGVmYXVsdDtcbiAgICB9XG5cbiAgICBpZiAoISh0aGlzLnByb3BzLmFyY2hpdGVjdHVyZSBpbiBhcmNoaXRlY3R1cmVNYXApKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZEFyY2hpdGVjdHVyZUVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBhcmNoaXRlY3R1cmUgb2YgJHt0aGlzLnByb3BzLmFyY2hpdGVjdHVyZX1gLFxuICAgICAgICByZXNvbHV0aW9uOiBgYXJjaGl0ZWN0dXJlIG11c3QgYmUgb25lIG9mIHRoZSBmb2xsb3dpbmc6ICR7T2JqZWN0LmtleXMoXG4gICAgICAgICAgYXJjaGl0ZWN0dXJlTWFwXG4gICAgICAgICkuam9pbignLCAnKX1gLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMuYXJjaGl0ZWN0dXJlO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVNjaGVkdWxlID0gKCkgPT4ge1xuICAgIGlmICghdGhpcy5wcm9wcy5zY2hlZHVsZSkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb3BzLnNjaGVkdWxlO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUJ1bmRsaW5nID0gKCkgPT4ge1xuICAgIGNvbnN0IGJ1bmRsaW5nRGVmYXVsdCA9IHtcbiAgICAgIGZvcm1hdDogT3V0cHV0Rm9ybWF0LkVTTSxcbiAgICAgIGJ1bmRsZUF3c1NESzogdHJ1ZSxcbiAgICAgIGxvYWRlcjoge1xuICAgICAgICAnLm5vZGUnOiAnZmlsZScsXG4gICAgICB9LFxuICAgICAgbWluaWZ5OiB0cnVlLFxuICAgICAgc291cmNlTWFwOiB0cnVlLFxuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4uYnVuZGxpbmdEZWZhdWx0LFxuICAgICAgbWluaWZ5OiB0aGlzLnJlc29sdmVNaW5pZnkodGhpcy5wcm9wcy5idW5kbGluZyksXG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVNaW5pZnkgPSAoYnVuZGxpbmc/OiBGdW5jdGlvbkJ1bmRsaW5nT3B0aW9ucykgPT4ge1xuICAgIHJldHVybiBidW5kbGluZz8ubWluaWZ5ID09PSB1bmRlZmluZWQgPyB0cnVlIDogYnVuZGxpbmcubWluaWZ5O1xuICB9O1xufVxuXG50eXBlIEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyA9IFJlcXVpcmVkPEZ1bmN0aW9uUHJvcHM+O1xuXG5jbGFzcyBGdW5jdGlvbkdlbmVyYXRvciBpbXBsZW1lbnRzIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yIHtcbiAgcmVhZG9ubHkgcmVzb3VyY2VHcm91cE5hbWU6IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBIeWRyYXRlZEZ1bmN0aW9uUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8RnVuY3Rpb25PdXRwdXQ+XG4gICkge1xuICAgIHRoaXMucmVzb3VyY2VHcm91cE5hbWUgPSBwcm9wcy5yZXNvdXJjZUdyb3VwTmFtZTtcbiAgfVxuXG4gIGdlbmVyYXRlQ29udGFpbmVyRW50cnkgPSAoe1xuICAgIHNjb3BlLFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgfTogR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzKSA9PiB7XG4gICAgLy8gTW92ZSBsYXllciByZXNvbHV0aW9uIGhlcmUgd2hlcmUgd2UgaGF2ZSBhY2Nlc3MgdG8gc2NvcGVcbiAgICBjb25zdCBwYXJzZXIgPSBuZXcgRnVuY3Rpb25MYXllckFyblBhcnNlcihcbiAgICAgIFN0YWNrLm9mKHNjb3BlKS5yZWdpb24sXG4gICAgICBTdGFjay5vZihzY29wZSkuYWNjb3VudFxuICAgICk7XG4gICAgY29uc3QgcmVzb2x2ZWRMYXllckFybnMgPSBwYXJzZXIucGFyc2VMYXllcnMoXG4gICAgICB0aGlzLnByb3BzLmxheWVycyA/PyB7fSxcbiAgICAgIHRoaXMucHJvcHMubmFtZVxuICAgICk7XG5cbiAgICAvLyByZXNvbHZlIGxheWVycyB0byBMYXllclZlcnNpb24gb2JqZWN0cyBmb3IgdGhlIE5vZGVqc0Z1bmN0aW9uIGNvbnN0cnVjdG9yXG4gICAgY29uc3QgcmVzb2x2ZWRMYXllcnMgPSBPYmplY3QuZW50cmllcyhyZXNvbHZlZExheWVyQXJucykubWFwKChba2V5LCBhcm5dKSA9PlxuICAgICAgTGF5ZXJWZXJzaW9uLmZyb21MYXllclZlcnNpb25Bcm4oXG4gICAgICAgIHNjb3BlLFxuICAgICAgICBgJHt0aGlzLnByb3BzLm5hbWV9LSR7a2V5fS1sYXllcmAsXG4gICAgICAgIGFyblxuICAgICAgKVxuICAgICk7XG5cbiAgICByZXR1cm4gbmV3IEFtcGxpZnlGdW5jdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgdGhpcy5wcm9wcy5uYW1lLFxuICAgICAgeyAuLi50aGlzLnByb3BzLCByZXNvbHZlZExheWVycyB9LFxuICAgICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgICAgdGhpcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3lcbiAgICApO1xuICB9O1xufVxuXG5jbGFzcyBBbXBsaWZ5RnVuY3Rpb25cbiAgZXh0ZW5kcyBBbXBsaWZ5RnVuY3Rpb25CYXNlXG4gIGltcGxlbWVudHMgQWRkRW52aXJvbm1lbnRGYWN0b3J5XG57XG4gIHJlYWRvbmx5IHJlc291cmNlczogRnVuY3Rpb25SZXNvdXJjZXM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3I6IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yO1xuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyAmIHsgcmVzb2x2ZWRMYXllcnM6IElMYXllclZlcnNpb25bXSB9LFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxGdW5jdGlvbk91dHB1dD5cbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuXG4gICAgY29uc3QgcnVudGltZSA9IG5vZGVWZXJzaW9uTWFwW3Byb3BzLnJ1bnRpbWVdO1xuXG4gICAgY29uc3QgcmVxdWlyZSA9IGNyZWF0ZVJlcXVpcmUoaW1wb3J0Lm1ldGEudXJsKTtcblxuICAgIGNvbnN0IHNoaW1zID1cbiAgICAgIHJ1bnRpbWUgPT09IFJ1bnRpbWUuTk9ERUpTXzE2X1hcbiAgICAgICAgPyBbXVxuICAgICAgICA6IFtyZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL2Nqc19zaGltJyldO1xuXG4gICAgY29uc3Qgc3NtUmVzb2x2ZXJGaWxlID1cbiAgICAgIHJ1bnRpbWUgPT09IFJ1bnRpbWUuTk9ERUpTXzE2X1hcbiAgICAgICAgPyByZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL3Jlc29sdmVfc3NtX3BhcmFtc19zZGtfdjInKSAvLyB1c2UgYXdzIGNkayB2MiBpbiBub2RlIDE2XG4gICAgICAgIDogcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9yZXNvbHZlX3NzbV9wYXJhbXMnKTtcblxuICAgIGNvbnN0IGludm9rZVNzbVJlc29sdmVyRmlsZSA9IHJlcXVpcmUucmVzb2x2ZShcbiAgICAgICcuL2xhbWJkYS1zaGltcy9pbnZva2Vfc3NtX3NoaW0nXG4gICAgKTtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgY29kZSBjb25jYXRlbmF0ZXMgdGhlIGNvbnRlbnRzIG9mIHRoZSBzc20gcmVzb2x2ZXIgYW5kIGludm9rZXIgaW50byBhIHNpbmdsZSBsaW5lIHRoYXQgY2FuIGJlIHVzZWQgYXMgdGhlIGVzYnVpbGQgYmFubmVyIGNvbnRlbnRcbiAgICAgKiBUaGlzIGJhbm5lciBpcyByZXNwb25zaWJsZSBmb3IgcmVzb2x2aW5nIHRoZSBjdXN0b21lcidzIFNTTSBwYXJhbWV0ZXJzIGF0IHJ1bnRpbWVcbiAgICAgKi9cbiAgICBjb25zdCBiYW5uZXJDb2RlID0gcmVhZEZpbGVTeW5jKHNzbVJlc29sdmVyRmlsZSwgJ3V0Zi04JylcbiAgICAgIC5jb25jYXQocmVhZEZpbGVTeW5jKGludm9rZVNzbVJlc29sdmVyRmlsZSwgJ3V0Zi04JykpXG4gICAgICAuc3BsaXQobmV3IFJlZ0V4cChgJHtFT0x9fFxcbnxcXHJgLCAnZycpKVxuICAgICAgLm1hcCgobGluZSkgPT4gbGluZS5yZXBsYWNlKC9cXC9cXC8uKiQvLCAnJykpIC8vIHN0cmlwIG91dCBpbmxpbmUgY29tbWVudHMgYmVjYXVzZSB0aGUgYmFubmVyIGlzIGdvaW5nIHRvIGJlIGZsYXR0ZW5lZCBpbnRvIGEgc2luZ2xlIGxpbmVcbiAgICAgIC5qb2luKCcnKTtcblxuICAgIGNvbnN0IGZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yID1cbiAgICAgIG5ldyBGdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvcihpZCk7XG5cbiAgICAvLyBlc2J1aWxkIHJ1bnMgYXMgcGFydCBvZiB0aGUgTm9kZWpzRnVuY3Rpb24gY29uc3RydWN0b3IsIHNvIHdlIGVhZ2VybHkgZ2VuZXJhdGUgdGhlIHByb2Nlc3MgZW52IHNoaW0gd2l0aG91dCB0eXBlcyBzbyBpdCBjYW4gYmUgaW5jbHVkZWQgaW4gdGhlIGZ1bmN0aW9uIGJ1bmRsZS5cbiAgICAvLyBUaGlzIHdpbGwgYmUgb3ZlcndyaXR0ZW4gd2l0aCB0aGUgdHlwZWQgZmlsZSBhdCB0aGUgZW5kIG9mIHN5bnRoZXNpc1xuICAgIGZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yLmdlbmVyYXRlUHJvY2Vzc0VudlNoaW0oKTtcblxuICAgIGxldCBmdW5jdGlvbkxhbWJkYTogTm9kZWpzRnVuY3Rpb247XG4gICAgY29uc3QgY2RrTG9nZ2luZ09wdGlvbnMgPSBjb252ZXJ0TG9nZ2luZ09wdGlvbnNUb0NESyhwcm9wcy5sb2dnaW5nKTtcbiAgICB0cnkge1xuICAgICAgZnVuY3Rpb25MYW1iZGEgPSBuZXcgTm9kZWpzRnVuY3Rpb24oc2NvcGUsIGAke2lkfS1sYW1iZGFgLCB7XG4gICAgICAgIGVudHJ5OiBwcm9wcy5lbnRyeSxcbiAgICAgICAgdGltZW91dDogRHVyYXRpb24uc2Vjb25kcyhwcm9wcy50aW1lb3V0U2Vjb25kcyksXG4gICAgICAgIG1lbW9yeVNpemU6IHByb3BzLm1lbW9yeU1CLFxuICAgICAgICBhcmNoaXRlY3R1cmU6IGFyY2hpdGVjdHVyZU1hcFtwcm9wcy5hcmNoaXRlY3R1cmVdLFxuICAgICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZTogU2l6ZS5tZWJpYnl0ZXMocHJvcHMuZXBoZW1lcmFsU3RvcmFnZVNpemVNQiksXG4gICAgICAgIHJ1bnRpbWU6IG5vZGVWZXJzaW9uTWFwW3Byb3BzLnJ1bnRpbWVdLFxuICAgICAgICBsYXllcnM6IHByb3BzLnJlc29sdmVkTGF5ZXJzLFxuICAgICAgICBidW5kbGluZzoge1xuICAgICAgICAgIC4uLnByb3BzLmJ1bmRsaW5nLFxuICAgICAgICAgIGJhbm5lcjogYmFubmVyQ29kZSxcbiAgICAgICAgICBpbmplY3Q6IHNoaW1zLFxuICAgICAgICAgIGV4dGVybmFsTW9kdWxlczogT2JqZWN0LmtleXMocHJvcHMubGF5ZXJzKSxcbiAgICAgICAgfSxcbiAgICAgICAgbG9nUmV0ZW50aW9uOiBjZGtMb2dnaW5nT3B0aW9ucy5yZXRlbnRpb24sXG4gICAgICAgIGFwcGxpY2F0aW9uTG9nTGV2ZWxWMjogY2RrTG9nZ2luZ09wdGlvbnMubGV2ZWwsXG4gICAgICAgIGxvZ2dpbmdGb3JtYXQ6IGNka0xvZ2dpbmdPcHRpb25zLmZvcm1hdCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBJZiB0aGUgZXJyb3IgaXMgZnJvbSBFUyBCdW5kbGVyIHdoaWNoIGlzIGV4ZWN1dGVkIGFzIGEgY2hpbGQgcHJvY2VzcyBieSBDREssXG4gICAgICAvLyB0aGVuIHRoZSBlcnJvciBmcm9tIENESyBjb250YWlucyB0aGUgY29tbWFuZCB0aGF0IHdhcyBleGVjdXRlZCBhbG9uZyB3aXRoIHRoZSBleGl0IHN0YXR1cy5cbiAgICAgIC8vIFdyYXBwaW5nIGl0IGhlcmUgIHdvdWxkIGNhdXNlIHRoZSBjZGtfZGVwbG95ZXIgdG8gcmUtdGhyb3cgdGhpcyB3cmFwcGVkIGV4Y2VwdGlvblxuICAgICAgLy8gaW5zdGVhZCBvZiBzY3JhcGluZyB0aGUgc3RkZXJyIGZvciBhY3R1YWwgRVNCdWlsZCBlcnJvci5cbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJlxuICAgICAgICBlcnJvci5tZXNzYWdlLm1hdGNoKC9GYWlsZWQgdG8gYnVuZGxlIGFzc2V0LipleGl0ZWQgd2l0aCBzdGF0dXMvKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICdOb2RlSlNGdW5jdGlvbkNvbnN0cnVjdEluaXRpYWxpemF0aW9uRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBpbnN0YW50aWF0ZSBub2RlanMgZnVuY3Rpb24gY29uc3RydWN0JyxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuIFVzZSBgLS1kZWJ1Z2AgZm9yIGFkZGl0aW9uYWwgZGVidWdnaW5nIGluZm9ybWF0aW9uLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yXG4gICAgICApO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzY2hlZHVsZXMgPSBjb252ZXJ0RnVuY3Rpb25TY2hlZHVsZXNUb1J1bGVTY2hlZHVsZXMoXG4gICAgICAgIGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgICBwcm9wcy5zY2hlZHVsZVxuICAgICAgKTtcbiAgICAgIGNvbnN0IGxhbWJkYVRhcmdldCA9IG5ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKGZ1bmN0aW9uTGFtYmRhKTtcblxuICAgICAgc2NoZWR1bGVzLmZvckVhY2goKHNjaGVkdWxlLCBpbmRleCkgPT4ge1xuICAgICAgICAvLyBMYW1iZGEgbmFtZSB3aWxsIGJlIHByZXBlbmRlZCB0byBydWxlIGlkLCBzbyBvbmx5IHVzaW5nIGluZGV4IGhlcmUgZm9yIHVuaXF1ZW5lc3NcbiAgICAgICAgY29uc3QgcnVsZSA9IG5ldyBSdWxlKGZ1bmN0aW9uTGFtYmRhLCBgc2NoZWR1bGUke2luZGV4fWAsIHtcbiAgICAgICAgICBzY2hlZHVsZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcnVsZS5hZGRUYXJnZXQobGFtYmRhVGFyZ2V0KTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0Z1bmN0aW9uU2NoZWR1bGVJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgc2NoZWR1bGUgZm9yIG5vZGVqcyBmdW5jdGlvbicsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3JcbiAgICAgICk7XG4gICAgfVxuXG4gICAgVGFncy5vZihmdW5jdGlvbkxhbWJkYSkuYWRkKFRhZ05hbWUuRlJJRU5ETFlfTkFNRSwgaWQpO1xuXG4gICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvciA9IG5ldyBGdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvcihcbiAgICAgIGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgcHJvcHMuZW52aXJvbm1lbnQsXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvclxuICAgICk7XG5cbiAgICB0aGlzLnJlc291cmNlcyA9IHtcbiAgICAgIGxhbWJkYTogZnVuY3Rpb25MYW1iZGEsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuRnVuY3Rpb246IGZ1bmN0aW9uTGFtYmRhLm5vZGUuZmluZENoaWxkKCdSZXNvdXJjZScpIGFzIENmbkZ1bmN0aW9uLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5zdG9yZU91dHB1dCgpO1xuICB9XG5cbiAgYWRkRW52aXJvbm1lbnQgPSAoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0KSA9PiB7XG4gICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvci5hZGRFbnZpcm9ubWVudEVudHJ5KGtleSwgdmFsdWUpO1xuICB9O1xuXG4gIGdldFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPSAoKTogUmVzb3VyY2VBY2Nlc3NBY2NlcHRvciA9PlxuICAgIG5ldyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IoXG4gICAgICB0aGlzLFxuICAgICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvclxuICAgICk7XG59XG5cbmNvbnN0IGlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlID0gKFxuICB0ZXN0OiBudW1iZXIsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlclxuKSA9PiBtaW4gPD0gdGVzdCAmJiB0ZXN0IDw9IG1heCAmJiB0ZXN0ICUgMSA9PT0gMDtcblxuZXhwb3J0IHR5cGUgTm9kZVZlcnNpb24gPSAxNiB8IDE4IHwgMjAgfCAyMjtcblxuY29uc3Qgbm9kZVZlcnNpb25NYXA6IFJlY29yZDxOb2RlVmVyc2lvbiwgUnVudGltZT4gPSB7XG4gIDE2OiBSdW50aW1lLk5PREVKU18xNl9YLFxuICAxODogUnVudGltZS5OT0RFSlNfMThfWCxcbiAgMjA6IFJ1bnRpbWUuTk9ERUpTXzIwX1gsXG4gIDIyOiBSdW50aW1lLk5PREVKU18yMl9YLFxufTtcblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25BcmNoaXRlY3R1cmUgPSAneDg2XzY0JyB8ICdhcm02NCc7XG5cbmNvbnN0IGFyY2hpdGVjdHVyZU1hcDogUmVjb3JkPEZ1bmN0aW9uQXJjaGl0ZWN0dXJlLCBBcmNoaXRlY3R1cmU+ID0ge1xuICBhcm02NDogQXJjaGl0ZWN0dXJlLkFSTV82NCxcbiAgeDg2XzY0OiBBcmNoaXRlY3R1cmUuWDg2XzY0LFxufTtcbiJdfQ==