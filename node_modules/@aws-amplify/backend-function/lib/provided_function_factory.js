import { Tags } from 'aws-cdk-lib';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { AmplifyFunctionBase } from './function_construct_base.js';
import { FunctionResourceAccessAcceptor } from './resource_access_acceptor.js';
/**
 * Adapts provided CDK function as Amplify function.
 */
export class ProvidedFunctionFactory {
    functionProvider;
    props;
    generator;
    /**
     * Creates provided function factory.
     */
    constructor(functionProvider, props) {
        this.functionProvider = functionProvider;
        this.props = props;
    }
    /**
     * Creates a function instance.
     */
    getInstance(props) {
        if (!this.generator) {
            this.generator = new ProvidedFunctionGenerator(this.functionProvider, props.outputStorageStrategy, this.props);
        }
        return props.constructContainer.getOrCompute(this.generator);
    }
}
class ProvidedFunctionGenerator {
    functionProvider;
    outputStorageStrategy;
    resourceGroupName;
    constructor(functionProvider, outputStorageStrategy, props) {
        this.functionProvider = functionProvider;
        this.outputStorageStrategy = outputStorageStrategy;
        this.resourceGroupName = props?.resourceGroupName ?? 'function';
    }
    generateContainerEntry = ({ scope }) => {
        let providedFunction;
        try {
            providedFunction = this.functionProvider(scope);
        }
        catch (e) {
            if (e instanceof Error &&
                (e.message.includes('docker exited with status 1') ||
                    e.message.includes('docker ENOENT'))) {
                throw new AmplifyUserError('CustomFunctionProviderDockerError', {
                    message: 'Failed to instantiate custom function provider',
                    resolution: 'See https://docs.amplify.aws/react/build-a-backend/functions/custom-functions for more details about current limitations and troubleshooting steps.',
                }, e);
            }
            else {
                throw new AmplifyUserError('CustomFunctionProviderError', {
                    message: 'Failed to instantiate custom function provider',
                    resolution: 'Check the definition of your custom function provided in `defineFunction` and refer to the logs for more information. See https://docs.amplify.aws/react/build-a-backend/functions/custom-functions for more details.',
                }, e instanceof Error ? e : undefined);
            }
        }
        return new ProvidedAmplifyFunction(scope, `${providedFunction.node.id}-provided`, this.outputStorageStrategy, providedFunction);
    };
}
class ProvidedAmplifyFunction extends AmplifyFunctionBase {
    resources;
    constructor(scope, id, outputStorageStrategy, providedFunction) {
        super(scope, id, outputStorageStrategy);
        const cfnFunction = providedFunction.node.findChild('Resource');
        Tags.of(cfnFunction).add(TagName.FRIENDLY_NAME, providedFunction.node.id);
        this.resources = {
            lambda: providedFunction,
            cfnResources: {
                cfnFunction,
            },
        };
        this.storeOutput();
    }
    getResourceAccessAcceptor = () => new FunctionResourceAccessAcceptor(this);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZWRfZnVuY3Rpb25fZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wcm92aWRlZF9mdW5jdGlvbl9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWNBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDbkMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE9BQU8sRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ25FLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBWS9FOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHVCQUF1QjtJQVNmO0lBQ0E7SUFQWCxTQUFTLENBQW1DO0lBRXBEOztPQUVHO0lBQ0gsWUFDbUIsZ0JBQWlELEVBQ2pELEtBQTZCO1FBRDdCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBaUM7UUFDakQsVUFBSyxHQUFMLEtBQUssQ0FBd0I7SUFDN0MsQ0FBQztJQUVKOztPQUVHO0lBQ0gsV0FBVyxDQUFDLEtBQXVDO1FBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSx5QkFBeUIsQ0FDNUMsSUFBSSxDQUFDLGdCQUFnQixFQUNyQixLQUFLLENBQUMscUJBQXFCLEVBQzNCLElBQUksQ0FBQyxLQUFLLENBQ1gsQ0FBQztTQUNIO1FBQ0QsT0FBTyxLQUFLLENBQUMsa0JBQWtCLENBQUMsWUFBWSxDQUMxQyxJQUFJLENBQUMsU0FBUyxDQUNJLENBQUM7SUFDdkIsQ0FBQztDQUNGO0FBRUQsTUFBTSx5QkFBeUI7SUFJVjtJQUNBO0lBSlYsaUJBQWlCLENBQTJCO0lBRXJELFlBQ21CLGdCQUFpRCxFQUNqRCxxQkFBbUUsRUFDcEYsS0FBNkI7UUFGWixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWlDO1FBQ2pELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBOEM7UUFHcEYsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssRUFBRSxpQkFBaUIsSUFBSSxVQUFVLENBQUM7SUFDbEUsQ0FBQztJQUVELHNCQUFzQixHQUFHLENBQUMsRUFBRSxLQUFLLEVBQStCLEVBQUUsRUFBRTtRQUNsRSxJQUFJLGdCQUEyQixDQUFDO1FBQ2hDLElBQUk7WUFDRixnQkFBZ0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDakQ7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLElBQ0UsQ0FBQyxZQUFZLEtBQUs7Z0JBQ2xCLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsNkJBQTZCLENBQUM7b0JBQ2hELENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQ3RDO2dCQUNBLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsbUNBQW1DLEVBQ25DO29CQUNFLE9BQU8sRUFBRSxnREFBZ0Q7b0JBQ3pELFVBQVUsRUFDUixxSkFBcUo7aUJBQ3hKLEVBQ0QsQ0FBQyxDQUNGLENBQUM7YUFDSDtpQkFBTTtnQkFDTCxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLDZCQUE2QixFQUM3QjtvQkFDRSxPQUFPLEVBQUUsZ0RBQWdEO29CQUN6RCxVQUFVLEVBQ1IsdU5BQXVOO2lCQUMxTixFQUNELENBQUMsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUNuQyxDQUFDO2FBQ0g7U0FDRjtRQUNELE9BQU8sSUFBSSx1QkFBdUIsQ0FDaEMsS0FBSyxFQUNMLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEVBQUUsV0FBVyxFQUN0QyxJQUFJLENBQUMscUJBQXFCLEVBQzFCLGdCQUFnQixDQUNqQixDQUFDO0lBQ0osQ0FBQyxDQUFDO0NBQ0g7QUFFRCxNQUFNLHVCQUF3QixTQUFRLG1CQUFtQjtJQUM5QyxTQUFTLENBQW9CO0lBQ3RDLFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLHFCQUFtRSxFQUNuRSxnQkFBMkI7UUFFM0IsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUscUJBQXFCLENBQUMsQ0FBQztRQUV4QyxNQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUNqRCxVQUFVLENBQ0ksQ0FBQztRQUVqQixJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUxRSxJQUFJLENBQUMsU0FBUyxHQUFHO1lBQ2YsTUFBTSxFQUFFLGdCQUFnQjtZQUN4QixZQUFZLEVBQUU7Z0JBQ1osV0FBVzthQUNaO1NBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQseUJBQXlCLEdBQUcsR0FBMkIsRUFBRSxDQUN2RCxJQUFJLDhCQUE4QixDQUFDLElBQUksQ0FBQyxDQUFDO0NBQzVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQW1wbGlmeUZ1bmN0aW9uLFxuICBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWUsXG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yLFxuICBDb25zdHJ1Y3RGYWN0b3J5LFxuICBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbiAgRnVuY3Rpb25SZXNvdXJjZXMsXG4gIEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcyxcbiAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IENmbkZ1bmN0aW9uLCBJRnVuY3Rpb24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IEZ1bmN0aW9uT3V0cHV0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IsIFRhZ05hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBBbXBsaWZ5RnVuY3Rpb25CYXNlIH0gZnJvbSAnLi9mdW5jdGlvbl9jb25zdHJ1Y3RfYmFzZS5qcyc7XG5pbXBvcnQgeyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IgfSBmcm9tICcuL3Jlc291cmNlX2FjY2Vzc19hY2NlcHRvci5qcyc7XG5cbmV4cG9ydCB0eXBlIFByb3ZpZGVkRnVuY3Rpb25Qcm9wcyA9IHtcbiAgLyoqXG4gICAqIEdyb3VwIHRoZSBmdW5jdGlvbiB3aXRoIGV4aXN0aW5nIEFtcGxpZnkgcmVzb3VyY2VzIG9yIHNlcGFyYXRlIHRoZSBmdW5jdGlvbiBpbnRvIGl0cyBvd24gZ3JvdXAuXG4gICAqIEBkZWZhdWx0ICdmdW5jdGlvbicgLy8gZ3JvdXBpbmcgd2l0aCBvdGhlciBBbXBsaWZ5IGZ1bmN0aW9uc1xuICAgKiBAZXhhbXBsZVxuICAgKiByZXNvdXJjZUdyb3VwTmFtZTogJ2F1dGgnIC8vIHRvIGdyb3VwIGFuIGF1dGggdHJpZ2dlciB3aXRoIGFuIGF1dGggcmVzb3VyY2VcbiAgICovXG4gIHJlc291cmNlR3JvdXBOYW1lPzogQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lO1xufTtcblxuLyoqXG4gKiBBZGFwdHMgcHJvdmlkZWQgQ0RLIGZ1bmN0aW9uIGFzIEFtcGxpZnkgZnVuY3Rpb24uXG4gKi9cbmV4cG9ydCBjbGFzcyBQcm92aWRlZEZ1bmN0aW9uRmFjdG9yeVxuICBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QW1wbGlmeUZ1bmN0aW9uPlxue1xuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgcHJvdmlkZWQgZnVuY3Rpb24gZmFjdG9yeS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25Qcm92aWRlcjogKHNjb3BlOiBDb25zdHJ1Y3QpID0+IElGdW5jdGlvbixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzPzogUHJvdmlkZWRGdW5jdGlvblByb3BzXG4gICkge31cblxuICAvKipcbiAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIGluc3RhbmNlLlxuICAgKi9cbiAgZ2V0SW5zdGFuY2UocHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzKTogQW1wbGlmeUZ1bmN0aW9uIHtcbiAgICBpZiAoIXRoaXMuZ2VuZXJhdG9yKSB7XG4gICAgICB0aGlzLmdlbmVyYXRvciA9IG5ldyBQcm92aWRlZEZ1bmN0aW9uR2VuZXJhdG9yKFxuICAgICAgICB0aGlzLmZ1bmN0aW9uUHJvdmlkZXIsXG4gICAgICAgIHByb3BzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICAgICAgdGhpcy5wcm9wc1xuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHByb3BzLmNvbnN0cnVjdENvbnRhaW5lci5nZXRPckNvbXB1dGUoXG4gICAgICB0aGlzLmdlbmVyYXRvclxuICAgICkgYXMgQW1wbGlmeUZ1bmN0aW9uO1xuICB9XG59XG5cbmNsYXNzIFByb3ZpZGVkRnVuY3Rpb25HZW5lcmF0b3IgaW1wbGVtZW50cyBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvciB7XG4gIHJlYWRvbmx5IHJlc291cmNlR3JvdXBOYW1lOiBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWU7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvblByb3ZpZGVyOiAoc2NvcGU6IENvbnN0cnVjdCkgPT4gSUZ1bmN0aW9uLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PixcbiAgICBwcm9wcz86IFByb3ZpZGVkRnVuY3Rpb25Qcm9wc1xuICApIHtcbiAgICB0aGlzLnJlc291cmNlR3JvdXBOYW1lID0gcHJvcHM/LnJlc291cmNlR3JvdXBOYW1lID8/ICdmdW5jdGlvbic7XG4gIH1cblxuICBnZW5lcmF0ZUNvbnRhaW5lckVudHJ5ID0gKHsgc2NvcGUgfTogR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzKSA9PiB7XG4gICAgbGV0IHByb3ZpZGVkRnVuY3Rpb246IElGdW5jdGlvbjtcbiAgICB0cnkge1xuICAgICAgcHJvdmlkZWRGdW5jdGlvbiA9IHRoaXMuZnVuY3Rpb25Qcm92aWRlcihzY29wZSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKFxuICAgICAgICBlIGluc3RhbmNlb2YgRXJyb3IgJiZcbiAgICAgICAgKGUubWVzc2FnZS5pbmNsdWRlcygnZG9ja2VyIGV4aXRlZCB3aXRoIHN0YXR1cyAxJykgfHxcbiAgICAgICAgICBlLm1lc3NhZ2UuaW5jbHVkZXMoJ2RvY2tlciBFTk9FTlQnKSlcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAnQ3VzdG9tRnVuY3Rpb25Qcm92aWRlckRvY2tlckVycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGluc3RhbnRpYXRlIGN1c3RvbSBmdW5jdGlvbiBwcm92aWRlcicsXG4gICAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgICAnU2VlIGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvZnVuY3Rpb25zL2N1c3RvbS1mdW5jdGlvbnMgZm9yIG1vcmUgZGV0YWlscyBhYm91dCBjdXJyZW50IGxpbWl0YXRpb25zIGFuZCB0cm91Ymxlc2hvb3Rpbmcgc3RlcHMuJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdDdXN0b21GdW5jdGlvblByb3ZpZGVyRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgY3VzdG9tIGZ1bmN0aW9uIHByb3ZpZGVyJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdDaGVjayB0aGUgZGVmaW5pdGlvbiBvZiB5b3VyIGN1c3RvbSBmdW5jdGlvbiBwcm92aWRlZCBpbiBgZGVmaW5lRnVuY3Rpb25gIGFuZCByZWZlciB0byB0aGUgbG9ncyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4gU2VlIGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvZnVuY3Rpb25zL2N1c3RvbS1mdW5jdGlvbnMgZm9yIG1vcmUgZGV0YWlscy4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZSBpbnN0YW5jZW9mIEVycm9yID8gZSA6IHVuZGVmaW5lZFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb3ZpZGVkQW1wbGlmeUZ1bmN0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgJHtwcm92aWRlZEZ1bmN0aW9uLm5vZGUuaWR9LXByb3ZpZGVkYCxcbiAgICAgIHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgICAgcHJvdmlkZWRGdW5jdGlvblxuICAgICk7XG4gIH07XG59XG5cbmNsYXNzIFByb3ZpZGVkQW1wbGlmeUZ1bmN0aW9uIGV4dGVuZHMgQW1wbGlmeUZ1bmN0aW9uQmFzZSB7XG4gIHJlYWRvbmx5IHJlc291cmNlczogRnVuY3Rpb25SZXNvdXJjZXM7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8RnVuY3Rpb25PdXRwdXQ+LFxuICAgIHByb3ZpZGVkRnVuY3Rpb246IElGdW5jdGlvblxuICApIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIG91dHB1dFN0b3JhZ2VTdHJhdGVneSk7XG5cbiAgICBjb25zdCBjZm5GdW5jdGlvbiA9IHByb3ZpZGVkRnVuY3Rpb24ubm9kZS5maW5kQ2hpbGQoXG4gICAgICAnUmVzb3VyY2UnXG4gICAgKSBhcyBDZm5GdW5jdGlvbjtcblxuICAgIFRhZ3Mub2YoY2ZuRnVuY3Rpb24pLmFkZChUYWdOYW1lLkZSSUVORExZX05BTUUsIHByb3ZpZGVkRnVuY3Rpb24ubm9kZS5pZCk7XG5cbiAgICB0aGlzLnJlc291cmNlcyA9IHtcbiAgICAgIGxhbWJkYTogcHJvdmlkZWRGdW5jdGlvbixcbiAgICAgIGNmblJlc291cmNlczoge1xuICAgICAgICBjZm5GdW5jdGlvbixcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRoaXMuc3RvcmVPdXRwdXQoKTtcbiAgfVxuXG4gIGdldFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPSAoKTogUmVzb3VyY2VBY2Nlc3NBY2NlcHRvciA9PlxuICAgIG5ldyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IodGhpcyk7XG59XG4iXX0=