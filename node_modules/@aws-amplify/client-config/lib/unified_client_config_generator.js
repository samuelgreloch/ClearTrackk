import { unifiedBackendOutputSchema } from '@aws-amplify/backend-output-schemas';
import { AmplifyUserError, ObjectAccumulator, ObjectAccumulatorPropertyAlreadyExistsError, ObjectAccumulatorVersionMismatchError, } from '@aws-amplify/platform-core';
import { BackendOutputClientError, BackendOutputClientErrorType, } from '@aws-amplify/deployed-backend-client';
/**
 * Right now this is mostly a stub. This will become a translation layer between backend output and frontend config
 *
 * There may be multiple implementations of this for different frontends
 */
export class UnifiedClientConfigGenerator {
    fetchOutput;
    clientConfigContributors;
    /**
     * Provide a reference to how this config generator should retrieve backend output
     */
    constructor(fetchOutput, clientConfigContributors) {
        this.fetchOutput = fetchOutput;
        this.clientConfigContributors = clientConfigContributors;
    }
    /**
     * Fetch all backend output, invoke each ClientConfigContributor on the result and merge into a single config object
     */
    generateClientConfig = async () => {
        let output;
        try {
            output = await this.fetchOutput();
        }
        catch (error) {
            if (BackendOutputClientError.isBackendOutputClientError(error)) {
                switch (error.code) {
                    case BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS:
                        throw new AmplifyUserError('DeploymentInProgressError', {
                            message: 'Deployment is currently in progress.',
                            resolution: 'Re-run this command once the deployment completes.',
                        }, error);
                    case BackendOutputClientErrorType.NO_STACK_FOUND:
                        throw new AmplifyUserError('StackDoesNotExistError', {
                            message: 'Stack does not exist.',
                            resolution: 'Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists, then re-run this command.',
                        }, error);
                    case BackendOutputClientErrorType.METADATA_RETRIEVAL_ERROR:
                        throw new AmplifyUserError('NonAmplifyStackError', {
                            message: 'Stack was not created with Amplify.',
                            resolution: 'Ensure the CloudFormation stack ID references a main stack created with Amplify, then re-run this command.',
                        }, error);
                    case BackendOutputClientErrorType.NO_OUTPUTS_FOUND:
                        throw new AmplifyUserError('AmplifyOutputsNotFoundError', {
                            message: 'Amplify outputs not found in stack metadata',
                            resolution: `Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists.
        If this is a new sandbox or branch deployment, wait for the deployment to be successfully finished and try again.`,
                        }, error);
                    case BackendOutputClientErrorType.CREDENTIALS_ERROR:
                        throw new AmplifyUserError('CredentialsError', {
                            message: 'Unable to get backend outputs due to invalid credentials.',
                            resolution: 'Ensure your AWS credentials are correctly set and refreshed.',
                        }, error);
                    case BackendOutputClientErrorType.ACCESS_DENIED:
                        throw new AmplifyUserError('AccessDeniedError', {
                            message: 'Unable to get backend outputs due to insufficient permissions.',
                            resolution: 'Ensure you have permissions to call cloudformation:GetTemplateSummary.',
                        }, error);
                }
            }
            throw error;
        }
        const backendOutput = unifiedBackendOutputSchema.parse(output);
        const accumulator = new ObjectAccumulator({});
        for (const contributor of this.clientConfigContributors) {
            const clientConfigContribution = await contributor.contribute(backendOutput);
            try {
                // Partial to DeepPartialAmplifyGeneratedConfigs is always a safe case since it's up-casting
                accumulator.accumulate(clientConfigContribution);
            }
            catch (error) {
                if (error instanceof ObjectAccumulatorPropertyAlreadyExistsError) {
                    throw new AmplifyUserError('OutputEntryAlreadyExistsError', {
                        message: `Duplicated entry with key ${error.key} detected in deployment outputs`,
                        resolution: "Check if 'backend.addOutput' is called multiple times with overlapping inputs or" +
                            " if 'backend.addOutput' is called with values overlapping Amplify managed keys",
                    }, error);
                }
                if (error instanceof ObjectAccumulatorVersionMismatchError) {
                    throw new AmplifyUserError('VersionMismatchError', {
                        message: `Conflicting versions of client configuration found. `,
                        resolution: "Ensure that the version specified in 'backend.addOutput' is consistent" +
                            ' and is same as the one used for generating the client config',
                    }, error);
                }
                throw error;
            }
        }
        return accumulator.getAccumulatedObject();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidW5pZmllZF9jbGllbnRfY29uZmlnX2dlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91bmlmaWVkX2NsaWVudF9jb25maWdfZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBSWpGLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLDJDQUEyQyxFQUMzQyxxQ0FBcUMsR0FDdEMsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQ0wsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLHNDQUFzQyxDQUFDO0FBRTlDOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sNEJBQTRCO0lBS3BCO0lBQ0E7SUFMbkI7O09BRUc7SUFDSCxZQUNtQixXQUF5QyxFQUN6Qyx3QkFBbUQ7UUFEbkQsZ0JBQVcsR0FBWCxXQUFXLENBQThCO1FBQ3pDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMkI7SUFDbkUsQ0FBQztJQUVKOztPQUVHO0lBQ0gsb0JBQW9CLEdBQUcsS0FBSyxJQUEyQixFQUFFO1FBQ3ZELElBQUksTUFBTSxDQUFDO1FBQ1gsSUFBSTtZQUNGLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNuQztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsSUFBSSx3QkFBd0IsQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDOUQsUUFBUSxLQUFLLENBQUMsSUFBSSxFQUFFO29CQUNsQixLQUFLLDRCQUE0QixDQUFDLHNCQUFzQjt3QkFDdEQsTUFBTSxJQUFJLGdCQUFnQixDQUN4QiwyQkFBMkIsRUFDM0I7NEJBQ0UsT0FBTyxFQUFFLHNDQUFzQzs0QkFDL0MsVUFBVSxFQUNSLG9EQUFvRDt5QkFDdkQsRUFDRCxLQUFLLENBQ04sQ0FBQztvQkFDSixLQUFLLDRCQUE0QixDQUFDLGNBQWM7d0JBQzlDLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsd0JBQXdCLEVBQ3hCOzRCQUNFLE9BQU8sRUFBRSx1QkFBdUI7NEJBQ2hDLFVBQVUsRUFDUiw2SEFBNkg7eUJBQ2hJLEVBQ0QsS0FBSyxDQUNOLENBQUM7b0JBQ0osS0FBSyw0QkFBNEIsQ0FBQyx3QkFBd0I7d0JBQ3hELE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsc0JBQXNCLEVBQ3RCOzRCQUNFLE9BQU8sRUFBRSxxQ0FBcUM7NEJBQzlDLFVBQVUsRUFDUiw0R0FBNEc7eUJBQy9HLEVBQ0QsS0FBSyxDQUNOLENBQUM7b0JBQ0osS0FBSyw0QkFBNEIsQ0FBQyxnQkFBZ0I7d0JBQ2hELE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsNkJBQTZCLEVBQzdCOzRCQUNFLE9BQU8sRUFBRSw2Q0FBNkM7NEJBQ3RELFVBQVUsRUFBRTswSEFDOEY7eUJBQzNHLEVBQ0QsS0FBSyxDQUNOLENBQUM7b0JBQ0osS0FBSyw0QkFBNEIsQ0FBQyxpQkFBaUI7d0JBQ2pELE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsa0JBQWtCLEVBQ2xCOzRCQUNFLE9BQU8sRUFDTCwyREFBMkQ7NEJBQzdELFVBQVUsRUFDUiw4REFBOEQ7eUJBQ2pFLEVBQ0QsS0FBSyxDQUNOLENBQUM7b0JBQ0osS0FBSyw0QkFBNEIsQ0FBQyxhQUFhO3dCQUM3QyxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLG1CQUFtQixFQUNuQjs0QkFDRSxPQUFPLEVBQ0wsZ0VBQWdFOzRCQUNsRSxVQUFVLEVBQ1Isd0VBQXdFO3lCQUMzRSxFQUNELEtBQUssQ0FDTixDQUFDO2lCQUNMO2FBQ0Y7WUFDRCxNQUFNLEtBQUssQ0FBQztTQUNiO1FBQ0QsTUFBTSxhQUFhLEdBQUcsMEJBQTBCLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRS9ELE1BQU0sV0FBVyxHQUFHLElBQUksaUJBQWlCLENBQWUsRUFBRSxDQUFDLENBQUM7UUFFNUQsS0FBSyxNQUFNLFdBQVcsSUFBSSxJQUFJLENBQUMsd0JBQXdCLEVBQUU7WUFDdkQsTUFBTSx3QkFBd0IsR0FBRyxNQUFNLFdBQVcsQ0FBQyxVQUFVLENBQzNELGFBQWEsQ0FDZCxDQUFDO1lBQ0YsSUFBSTtnQkFDRiw0RkFBNEY7Z0JBQzVGLFdBQVcsQ0FBQyxVQUFVLENBQ3BCLHdCQUE0RSxDQUM3RSxDQUFDO2FBQ0g7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDZCxJQUFJLEtBQUssWUFBWSwyQ0FBMkMsRUFBRTtvQkFDaEUsTUFBTSxJQUFJLGdCQUFnQixDQUN4QiwrQkFBK0IsRUFDL0I7d0JBQ0UsT0FBTyxFQUFFLDZCQUE2QixLQUFLLENBQUMsR0FBRyxpQ0FBaUM7d0JBQ2hGLFVBQVUsRUFDUixrRkFBa0Y7NEJBQ2xGLGdGQUFnRjtxQkFDbkYsRUFDRCxLQUFLLENBQ04sQ0FBQztpQkFDSDtnQkFDRCxJQUFJLEtBQUssWUFBWSxxQ0FBcUMsRUFBRTtvQkFDMUQsTUFBTSxJQUFJLGdCQUFnQixDQUN4QixzQkFBc0IsRUFDdEI7d0JBQ0UsT0FBTyxFQUFFLHNEQUFzRDt3QkFDL0QsVUFBVSxFQUNSLHdFQUF3RTs0QkFDeEUsK0RBQStEO3FCQUNsRSxFQUNELEtBQUssQ0FDTixDQUFDO2lCQUNIO2dCQUNELE1BQU0sS0FBSyxDQUFDO2FBQ2I7U0FDRjtRQUNELE9BQXFCLFdBQVcsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0lBQzFELENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dCxcbiAgRGVlcFBhcnRpYWxBbXBsaWZ5R2VuZXJhdGVkQ29uZmlncyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyB1bmlmaWVkQmFja2VuZE91dHB1dFNjaGVtYSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7IENsaWVudENvbmZpZyB9IGZyb20gJy4vY2xpZW50LWNvbmZpZy10eXBlcy9jbGllbnRfY29uZmlnLmpzJztcbmltcG9ydCB7IENsaWVudENvbmZpZ0NvbnRyaWJ1dG9yIH0gZnJvbSAnLi9jbGllbnQtY29uZmlnLXR5cGVzL2NsaWVudF9jb25maWdfY29udHJpYnV0b3IuanMnO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnR2VuZXJhdG9yIH0gZnJvbSAnLi9jbGllbnRfY29uZmlnX2dlbmVyYXRvci5qcyc7XG5pbXBvcnQge1xuICBBbXBsaWZ5VXNlckVycm9yLFxuICBPYmplY3RBY2N1bXVsYXRvcixcbiAgT2JqZWN0QWNjdW11bGF0b3JQcm9wZXJ0eUFscmVhZHlFeGlzdHNFcnJvcixcbiAgT2JqZWN0QWNjdW11bGF0b3JWZXJzaW9uTWlzbWF0Y2hFcnJvcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yLFxuICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvZGVwbG95ZWQtYmFja2VuZC1jbGllbnQnO1xuXG4vKipcbiAqIFJpZ2h0IG5vdyB0aGlzIGlzIG1vc3RseSBhIHN0dWIuIFRoaXMgd2lsbCBiZWNvbWUgYSB0cmFuc2xhdGlvbiBsYXllciBiZXR3ZWVuIGJhY2tlbmQgb3V0cHV0IGFuZCBmcm9udGVuZCBjb25maWdcbiAqXG4gKiBUaGVyZSBtYXkgYmUgbXVsdGlwbGUgaW1wbGVtZW50YXRpb25zIG9mIHRoaXMgZm9yIGRpZmZlcmVudCBmcm9udGVuZHNcbiAqL1xuZXhwb3J0IGNsYXNzIFVuaWZpZWRDbGllbnRDb25maWdHZW5lcmF0b3IgaW1wbGVtZW50cyBDbGllbnRDb25maWdHZW5lcmF0b3Ige1xuICAvKipcbiAgICogUHJvdmlkZSBhIHJlZmVyZW5jZSB0byBob3cgdGhpcyBjb25maWcgZ2VuZXJhdG9yIHNob3VsZCByZXRyaWV2ZSBiYWNrZW5kIG91dHB1dFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBmZXRjaE91dHB1dDogKCkgPT4gUHJvbWlzZTxCYWNrZW5kT3V0cHV0PixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNsaWVudENvbmZpZ0NvbnRyaWJ1dG9yczogQ2xpZW50Q29uZmlnQ29udHJpYnV0b3JbXVxuICApIHt9XG5cbiAgLyoqXG4gICAqIEZldGNoIGFsbCBiYWNrZW5kIG91dHB1dCwgaW52b2tlIGVhY2ggQ2xpZW50Q29uZmlnQ29udHJpYnV0b3Igb24gdGhlIHJlc3VsdCBhbmQgbWVyZ2UgaW50byBhIHNpbmdsZSBjb25maWcgb2JqZWN0XG4gICAqL1xuICBnZW5lcmF0ZUNsaWVudENvbmZpZyA9IGFzeW5jICgpOiBQcm9taXNlPENsaWVudENvbmZpZz4gPT4ge1xuICAgIGxldCBvdXRwdXQ7XG4gICAgdHJ5IHtcbiAgICAgIG91dHB1dCA9IGF3YWl0IHRoaXMuZmV0Y2hPdXRwdXQoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvci5pc0JhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihlcnJvcikpIHtcbiAgICAgICAgc3dpdGNoIChlcnJvci5jb2RlKSB7XG4gICAgICAgICAgY2FzZSBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkRFUExPWU1FTlRfSU5fUFJPR1JFU1M6XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICAgJ0RlcGxveW1lbnRJblByb2dyZXNzRXJyb3InLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogJ0RlcGxveW1lbnQgaXMgY3VycmVudGx5IGluIHByb2dyZXNzLicsXG4gICAgICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgICAgICdSZS1ydW4gdGhpcyBjb21tYW5kIG9uY2UgdGhlIGRlcGxveW1lbnQgY29tcGxldGVzLicsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIGVycm9yXG4gICAgICAgICAgICApO1xuICAgICAgICAgIGNhc2UgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19TVEFDS19GT1VORDpcbiAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICAgICAnU3RhY2tEb2VzTm90RXhpc3RFcnJvcicsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnU3RhY2sgZG9lcyBub3QgZXhpc3QuJyxcbiAgICAgICAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgICAgICAgJ0Vuc3VyZSB0aGUgQ2xvdWRGb3JtYXRpb24gc3RhY2sgSUQgb3IgQW1wbGlmeSBBcHAgSUQgYW5kIGJyYW5jaCBzcGVjaWZpZWQgYXJlIGNvcnJlY3QgYW5kIGV4aXN0cywgdGhlbiByZS1ydW4gdGhpcyBjb21tYW5kLicsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIGVycm9yXG4gICAgICAgICAgICApO1xuICAgICAgICAgIGNhc2UgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5NRVRBREFUQV9SRVRSSUVWQUxfRVJST1I6XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICAgJ05vbkFtcGxpZnlTdGFja0Vycm9yJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdTdGFjayB3YXMgbm90IGNyZWF0ZWQgd2l0aCBBbXBsaWZ5LicsXG4gICAgICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgICAgICdFbnN1cmUgdGhlIENsb3VkRm9ybWF0aW9uIHN0YWNrIElEIHJlZmVyZW5jZXMgYSBtYWluIHN0YWNrIGNyZWF0ZWQgd2l0aCBBbXBsaWZ5LCB0aGVuIHJlLXJ1biB0aGlzIGNvbW1hbmQuJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZXJyb3JcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgY2FzZSBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLk5PX09VVFBVVFNfRk9VTkQ6XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICAgJ0FtcGxpZnlPdXRwdXRzTm90Rm91bmRFcnJvcicsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnQW1wbGlmeSBvdXRwdXRzIG5vdCBmb3VuZCBpbiBzdGFjayBtZXRhZGF0YScsXG4gICAgICAgICAgICAgICAgcmVzb2x1dGlvbjogYEVuc3VyZSB0aGUgQ2xvdWRGb3JtYXRpb24gc3RhY2sgSUQgb3IgQW1wbGlmeSBBcHAgSUQgYW5kIGJyYW5jaCBzcGVjaWZpZWQgYXJlIGNvcnJlY3QgYW5kIGV4aXN0cy5cbiAgICAgICAgSWYgdGhpcyBpcyBhIG5ldyBzYW5kYm94IG9yIGJyYW5jaCBkZXBsb3ltZW50LCB3YWl0IGZvciB0aGUgZGVwbG95bWVudCB0byBiZSBzdWNjZXNzZnVsbHkgZmluaXNoZWQgYW5kIHRyeSBhZ2Fpbi5gLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBlcnJvclxuICAgICAgICAgICAgKTtcbiAgICAgICAgICBjYXNlIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuQ1JFREVOVElBTFNfRVJST1I6XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICAgJ0NyZWRlbnRpYWxzRXJyb3InLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgICAgICAgICdVbmFibGUgdG8gZ2V0IGJhY2tlbmQgb3V0cHV0cyBkdWUgdG8gaW52YWxpZCBjcmVkZW50aWFscy4nLFxuICAgICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgICAnRW5zdXJlIHlvdXIgQVdTIGNyZWRlbnRpYWxzIGFyZSBjb3JyZWN0bHkgc2V0IGFuZCByZWZyZXNoZWQuJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZXJyb3JcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgY2FzZSBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkFDQ0VTU19ERU5JRUQ6XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICAgJ0FjY2Vzc0RlbmllZEVycm9yJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICAgICAgICAnVW5hYmxlIHRvIGdldCBiYWNrZW5kIG91dHB1dHMgZHVlIHRvIGluc3VmZmljaWVudCBwZXJtaXNzaW9ucy4nLFxuICAgICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgICAnRW5zdXJlIHlvdSBoYXZlIHBlcm1pc3Npb25zIHRvIGNhbGwgY2xvdWRmb3JtYXRpb246R2V0VGVtcGxhdGVTdW1tYXJ5LicsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIGVycm9yXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gICAgY29uc3QgYmFja2VuZE91dHB1dCA9IHVuaWZpZWRCYWNrZW5kT3V0cHV0U2NoZW1hLnBhcnNlKG91dHB1dCk7XG5cbiAgICBjb25zdCBhY2N1bXVsYXRvciA9IG5ldyBPYmplY3RBY2N1bXVsYXRvcjxDbGllbnRDb25maWc+KHt9KTtcblxuICAgIGZvciAoY29uc3QgY29udHJpYnV0b3Igb2YgdGhpcy5jbGllbnRDb25maWdDb250cmlidXRvcnMpIHtcbiAgICAgIGNvbnN0IGNsaWVudENvbmZpZ0NvbnRyaWJ1dGlvbiA9IGF3YWl0IGNvbnRyaWJ1dG9yLmNvbnRyaWJ1dGUoXG4gICAgICAgIGJhY2tlbmRPdXRwdXRcbiAgICAgICk7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBQYXJ0aWFsIHRvIERlZXBQYXJ0aWFsQW1wbGlmeUdlbmVyYXRlZENvbmZpZ3MgaXMgYWx3YXlzIGEgc2FmZSBjYXNlIHNpbmNlIGl0J3MgdXAtY2FzdGluZ1xuICAgICAgICBhY2N1bXVsYXRvci5hY2N1bXVsYXRlKFxuICAgICAgICAgIGNsaWVudENvbmZpZ0NvbnRyaWJ1dGlvbiBhcyBEZWVwUGFydGlhbEFtcGxpZnlHZW5lcmF0ZWRDb25maWdzPENsaWVudENvbmZpZz5cbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIE9iamVjdEFjY3VtdWxhdG9yUHJvcGVydHlBbHJlYWR5RXhpc3RzRXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICdPdXRwdXRFbnRyeUFscmVhZHlFeGlzdHNFcnJvcicsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBEdXBsaWNhdGVkIGVudHJ5IHdpdGgga2V5ICR7ZXJyb3Iua2V5fSBkZXRlY3RlZCBpbiBkZXBsb3ltZW50IG91dHB1dHNgLFxuICAgICAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgICAgIFwiQ2hlY2sgaWYgJ2JhY2tlbmQuYWRkT3V0cHV0JyBpcyBjYWxsZWQgbXVsdGlwbGUgdGltZXMgd2l0aCBvdmVybGFwcGluZyBpbnB1dHMgb3JcIiArXG4gICAgICAgICAgICAgICAgXCIgaWYgJ2JhY2tlbmQuYWRkT3V0cHV0JyBpcyBjYWxsZWQgd2l0aCB2YWx1ZXMgb3ZlcmxhcHBpbmcgQW1wbGlmeSBtYW5hZ2VkIGtleXNcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvclxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgT2JqZWN0QWNjdW11bGF0b3JWZXJzaW9uTWlzbWF0Y2hFcnJvcikge1xuICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICAgJ1ZlcnNpb25NaXNtYXRjaEVycm9yJyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogYENvbmZsaWN0aW5nIHZlcnNpb25zIG9mIGNsaWVudCBjb25maWd1cmF0aW9uIGZvdW5kLiBgLFxuICAgICAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgICAgIFwiRW5zdXJlIHRoYXQgdGhlIHZlcnNpb24gc3BlY2lmaWVkIGluICdiYWNrZW5kLmFkZE91dHB1dCcgaXMgY29uc2lzdGVudFwiICtcbiAgICAgICAgICAgICAgICAnIGFuZCBpcyBzYW1lIGFzIHRoZSBvbmUgdXNlZCBmb3IgZ2VuZXJhdGluZyB0aGUgY2xpZW50IGNvbmZpZycsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3JcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gPENsaWVudENvbmZpZz5hY2N1bXVsYXRvci5nZXRBY2N1bXVsYXRlZE9iamVjdCgpO1xuICB9O1xufVxuIl19