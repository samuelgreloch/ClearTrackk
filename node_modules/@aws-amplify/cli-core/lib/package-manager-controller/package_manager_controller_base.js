import { existsSync as _existsSync } from 'fs';
import _fsp from 'fs/promises';
import { execa as _execa } from 'execa';
import * as _path from 'path';
import { LogLevel } from '../printer/printer.js';
import { printer } from '../printer.js';
import { executeWithDebugLogger as _executeWithDebugLogger } from './execute_with_debugger_logger.js';
import { getPackageManagerRunnerName } from './get_package_manager_name.js';
/**
 * PackageManagerController is an abstraction around package manager commands that are needed to initialize a project and install dependencies
 */
export class PackageManagerControllerBase {
    cwd;
    executable;
    initDefault;
    installCommand;
    lockFileReader;
    fsp;
    path;
    execa;
    executeWithDebugLogger;
    existsSync;
    binaryRunner;
    /**
     * constructor - sets the project root
     */
    constructor(cwd, executable, initDefault, installCommand, lockFileReader, fsp = _fsp, path = _path, execa = _execa, executeWithDebugLogger = _executeWithDebugLogger, existsSync = _existsSync) {
        this.cwd = cwd;
        this.executable = executable;
        this.initDefault = initDefault;
        this.installCommand = installCommand;
        this.lockFileReader = lockFileReader;
        this.fsp = fsp;
        this.path = path;
        this.execa = execa;
        this.executeWithDebugLogger = executeWithDebugLogger;
        this.existsSync = existsSync;
        this.binaryRunner = getPackageManagerRunnerName();
    }
    /**
     * installDependencies - installs dependencies in the project root
     */
    async installDependencies(packageNames, type) {
        const args = [`${this.installCommand}`].concat(...packageNames);
        if (type === 'dev') {
            args.push('-D');
        }
        await this.executeWithDebugLogger(this.cwd, this.executable, args, this.execa);
    }
    /**
     * initializeProject - initializes a project in the project root by checking the package.json file
     */
    initializeProject = async () => {
        if (this.packageJsonExists(this.cwd)) {
            // if package.json already exists, no need to do anything
            return;
        }
        printer.log(`No package.json file found in the current directory. Running \`${this.executable} init\`...`, LogLevel.DEBUG);
        try {
            await this.executeWithDebugLogger(this.cwd, this.executable, this.initDefault, this.execa);
        }
        catch (err) {
            throw new Error(`\`${this.executable} init\` did not exit successfully. Initialize a valid JavaScript package before continuing.`, { cause: err });
        }
        if (!this.packageJsonExists(this.cwd)) {
            // this should only happen if the customer exits out of npm init before finishing
            throw new Error(`package.json does not exist after running \`${this.executable} init\`. Initialize a valid JavaScript package before continuing.'`);
        }
    };
    /**
     * initializeTsConfig - initializes a tsconfig.json file in the project root
     *
     * When changing this method, double check if a corresponding change is needed in the integration test setup in `setup_dir_as_esm_module.ts`.
     */
    async initializeTsConfig(targetDir) {
        const tsConfigTemplate = {
            compilerOptions: {
                target: 'es2022',
                module: 'es2022',
                moduleResolution: 'bundler',
                resolveJsonModule: true,
                esModuleInterop: true,
                forceConsistentCasingInFileNames: true,
                strict: true,
                skipLibCheck: true,
                // The path here is coupled with backend-function's generated typedef file path
                paths: { '$amplify/*': ['../.amplify/generated/*'] },
            },
        };
        const tsConfigPath = this.path.resolve(targetDir, 'tsconfig.json');
        await this.fsp.writeFile(tsConfigPath, JSON.stringify(tsConfigTemplate, null, 2), 'utf-8');
    }
    /**
     * runWithPackageManager - Factory function that runs a command with the specified package manager's binary runner
     */
    runWithPackageManager(args = [], dir, options) {
        return this.executeWithDebugLogger(dir, this.binaryRunner, args, this.execa, options);
    }
    getCommand = (args) => `${this.binaryRunner} ${args.join(' ')}`;
    /**
     * allowsSignalPropagation - Determines if the package manager allows the process
     * signals such as SIGINT to be propagated to the underlying node process.
     * @deprecated
     */
    allowsSignalPropagation = () => true;
    /**
     * tryGetDependencies - Tries to retrieve dependency versions from the lock file in the project root
     */
    tryGetDependencies = async () => {
        const lockFileContents = await this.lockFileReader.getLockFileContentsFromCwd();
        return lockFileContents?.dependencies;
    };
    /**
     * Check if a package.json file exists in projectRoot
     */
    packageJsonExists = (projectRoot) => {
        return this.existsSync(this.path.resolve(projectRoot, 'package.json'));
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2FnZV9tYW5hZ2VyX2NvbnRyb2xsZXJfYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wYWNrYWdlLW1hbmFnZXItY29udHJvbGxlci9wYWNrYWdlX21hbmFnZXJfY29udHJvbGxlcl9iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLElBQUksV0FBVyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQy9DLE9BQU8sSUFBSSxNQUFNLGFBQWEsQ0FBQztBQUMvQixPQUFPLEVBQUUsS0FBSyxJQUFJLE1BQU0sRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUN4QyxPQUFPLEtBQUssS0FBSyxNQUFNLE1BQU0sQ0FBQztBQU85QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDakQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsc0JBQXNCLElBQUksdUJBQXVCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN0RyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUc1RTs7R0FFRztBQUNILE1BQU0sT0FBZ0IsNEJBQTRCO0lBUTNCO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBZEYsWUFBWSxDQUFTO0lBQ3hDOztPQUVHO0lBQ0gsWUFDcUIsR0FBVyxFQUNYLFVBQWtCLEVBQ2xCLFdBQXFCLEVBQ3JCLGNBQXNCLEVBQ3RCLGNBQThCLEVBQzlCLE1BQU0sSUFBSSxFQUNWLE9BQU8sS0FBSyxFQUNaLFFBQVEsTUFBTSxFQUNkLHlCQUF5Qix1QkFBdUIsRUFDaEQsYUFBYSxXQUFXO1FBVHhCLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDWCxlQUFVLEdBQVYsVUFBVSxDQUFRO1FBQ2xCLGdCQUFXLEdBQVgsV0FBVyxDQUFVO1FBQ3JCLG1CQUFjLEdBQWQsY0FBYyxDQUFRO1FB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QXNCO1FBRXRCLE9BQU8sSUFBSSxDQUFDLHNCQUFzQixDQUNoQyxHQUFHLEVBQ0gsSUFBSSxDQUFDLFlBQVksRUFDakIsSUFBSSxFQUNKLElBQUksQ0FBQyxLQUFLLEVBQ1YsT0FBTyxDQUNSLENBQUM7SUFDSixDQUFDO0lBRUQsVUFBVSxHQUFHLENBQUMsSUFBYyxFQUFFLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO0lBRTFFOzs7O09BSUc7SUFDSCx1QkFBdUIsR0FBRyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUM7SUFFckM7O09BRUc7SUFDSCxrQkFBa0IsR0FBRyxLQUFLLElBQTRDLEVBQUU7UUFDdEUsTUFBTSxnQkFBZ0IsR0FDcEIsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLDBCQUEwQixFQUFFLENBQUM7UUFFekQsT0FBTyxnQkFBZ0IsRUFBRSxZQUFZLENBQUM7SUFDeEMsQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSyxpQkFBaUIsR0FBRyxDQUFDLFdBQW1CLEVBQVcsRUFBRTtRQUMzRCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQyxDQUFDLENBQUM7SUFDekUsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleGlzdHNTeW5jIGFzIF9leGlzdHNTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IF9mc3AgZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHsgZXhlY2EgYXMgX2V4ZWNhIH0gZnJvbSAnZXhlY2EnO1xuaW1wb3J0ICogYXMgX3BhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQge1xuICBEZXBlbmRlbmN5LFxuICBFeGVjYUNoaWxkUHJvY2VzcyxcbiAgRXhlY2FPcHRpb25zLFxuICB0eXBlIFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBMb2dMZXZlbCB9IGZyb20gJy4uL3ByaW50ZXIvcHJpbnRlci5qcyc7XG5pbXBvcnQgeyBwcmludGVyIH0gZnJvbSAnLi4vcHJpbnRlci5qcyc7XG5pbXBvcnQgeyBleGVjdXRlV2l0aERlYnVnTG9nZ2VyIGFzIF9leGVjdXRlV2l0aERlYnVnTG9nZ2VyIH0gZnJvbSAnLi9leGVjdXRlX3dpdGhfZGVidWdnZXJfbG9nZ2VyLmpzJztcbmltcG9ydCB7IGdldFBhY2thZ2VNYW5hZ2VyUnVubmVyTmFtZSB9IGZyb20gJy4vZ2V0X3BhY2thZ2VfbWFuYWdlcl9uYW1lLmpzJztcbmltcG9ydCB7IExvY2tGaWxlUmVhZGVyIH0gZnJvbSAnLi9sb2NrLWZpbGUtcmVhZGVyL3R5cGVzLmpzJztcblxuLyoqXG4gKiBQYWNrYWdlTWFuYWdlckNvbnRyb2xsZXIgaXMgYW4gYWJzdHJhY3Rpb24gYXJvdW5kIHBhY2thZ2UgbWFuYWdlciBjb21tYW5kcyB0aGF0IGFyZSBuZWVkZWQgdG8gaW5pdGlhbGl6ZSBhIHByb2plY3QgYW5kIGluc3RhbGwgZGVwZW5kZW5jaWVzXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBQYWNrYWdlTWFuYWdlckNvbnRyb2xsZXJCYXNlXG4gIGltcGxlbWVudHMgUGFja2FnZU1hbmFnZXJDb250cm9sbGVyXG57XG4gIHByb3RlY3RlZCByZWFkb25seSBiaW5hcnlSdW5uZXI6IHN0cmluZztcbiAgLyoqXG4gICAqIGNvbnN0cnVjdG9yIC0gc2V0cyB0aGUgcHJvamVjdCByb290XG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgY3dkOiBzdHJpbmcsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGV4ZWN1dGFibGU6IHN0cmluZyxcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgaW5pdERlZmF1bHQ6IHN0cmluZ1tdLFxuICAgIHByb3RlY3RlZCByZWFkb25seSBpbnN0YWxsQ29tbWFuZDogc3RyaW5nLFxuICAgIHByb3RlY3RlZCByZWFkb25seSBsb2NrRmlsZVJlYWRlcjogTG9ja0ZpbGVSZWFkZXIsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGZzcCA9IF9mc3AsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IHBhdGggPSBfcGF0aCxcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgZXhlY2EgPSBfZXhlY2EsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGV4ZWN1dGVXaXRoRGVidWdMb2dnZXIgPSBfZXhlY3V0ZVdpdGhEZWJ1Z0xvZ2dlcixcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgZXhpc3RzU3luYyA9IF9leGlzdHNTeW5jXG4gICkge1xuICAgIHRoaXMuYmluYXJ5UnVubmVyID0gZ2V0UGFja2FnZU1hbmFnZXJSdW5uZXJOYW1lKCk7XG4gIH1cblxuICAvKipcbiAgICogaW5zdGFsbERlcGVuZGVuY2llcyAtIGluc3RhbGxzIGRlcGVuZGVuY2llcyBpbiB0aGUgcHJvamVjdCByb290XG4gICAqL1xuICBhc3luYyBpbnN0YWxsRGVwZW5kZW5jaWVzKFxuICAgIHBhY2thZ2VOYW1lczogc3RyaW5nW10sXG4gICAgdHlwZTogJ2RldicgfCAncHJvZCdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgYXJncyA9IFtgJHt0aGlzLmluc3RhbGxDb21tYW5kfWBdLmNvbmNhdCguLi5wYWNrYWdlTmFtZXMpO1xuICAgIGlmICh0eXBlID09PSAnZGV2Jykge1xuICAgICAgYXJncy5wdXNoKCctRCcpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZVdpdGhEZWJ1Z0xvZ2dlcihcbiAgICAgIHRoaXMuY3dkLFxuICAgICAgdGhpcy5leGVjdXRhYmxlLFxuICAgICAgYXJncyxcbiAgICAgIHRoaXMuZXhlY2FcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIGluaXRpYWxpemVQcm9qZWN0IC0gaW5pdGlhbGl6ZXMgYSBwcm9qZWN0IGluIHRoZSBwcm9qZWN0IHJvb3QgYnkgY2hlY2tpbmcgdGhlIHBhY2thZ2UuanNvbiBmaWxlXG4gICAqL1xuICBpbml0aWFsaXplUHJvamVjdCA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAodGhpcy5wYWNrYWdlSnNvbkV4aXN0cyh0aGlzLmN3ZCkpIHtcbiAgICAgIC8vIGlmIHBhY2thZ2UuanNvbiBhbHJlYWR5IGV4aXN0cywgbm8gbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHByaW50ZXIubG9nKFxuICAgICAgYE5vIHBhY2thZ2UuanNvbiBmaWxlIGZvdW5kIGluIHRoZSBjdXJyZW50IGRpcmVjdG9yeS4gUnVubmluZyBcXGAke3RoaXMuZXhlY3V0YWJsZX0gaW5pdFxcYC4uLmAsXG4gICAgICBMb2dMZXZlbC5ERUJVR1xuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5leGVjdXRlV2l0aERlYnVnTG9nZ2VyKFxuICAgICAgICB0aGlzLmN3ZCxcbiAgICAgICAgdGhpcy5leGVjdXRhYmxlLFxuICAgICAgICB0aGlzLmluaXREZWZhdWx0LFxuICAgICAgICB0aGlzLmV4ZWNhXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgXFxgJHt0aGlzLmV4ZWN1dGFibGV9IGluaXRcXGAgZGlkIG5vdCBleGl0IHN1Y2Nlc3NmdWxseS4gSW5pdGlhbGl6ZSBhIHZhbGlkIEphdmFTY3JpcHQgcGFja2FnZSBiZWZvcmUgY29udGludWluZy5gLFxuICAgICAgICB7IGNhdXNlOiBlcnIgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMucGFja2FnZUpzb25FeGlzdHModGhpcy5jd2QpKSB7XG4gICAgICAvLyB0aGlzIHNob3VsZCBvbmx5IGhhcHBlbiBpZiB0aGUgY3VzdG9tZXIgZXhpdHMgb3V0IG9mIG5wbSBpbml0IGJlZm9yZSBmaW5pc2hpbmdcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYHBhY2thZ2UuanNvbiBkb2VzIG5vdCBleGlzdCBhZnRlciBydW5uaW5nIFxcYCR7dGhpcy5leGVjdXRhYmxlfSBpbml0XFxgLiBJbml0aWFsaXplIGEgdmFsaWQgSmF2YVNjcmlwdCBwYWNrYWdlIGJlZm9yZSBjb250aW51aW5nLidgXG4gICAgICApO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogaW5pdGlhbGl6ZVRzQ29uZmlnIC0gaW5pdGlhbGl6ZXMgYSB0c2NvbmZpZy5qc29uIGZpbGUgaW4gdGhlIHByb2plY3Qgcm9vdFxuICAgKlxuICAgKiBXaGVuIGNoYW5naW5nIHRoaXMgbWV0aG9kLCBkb3VibGUgY2hlY2sgaWYgYSBjb3JyZXNwb25kaW5nIGNoYW5nZSBpcyBuZWVkZWQgaW4gdGhlIGludGVncmF0aW9uIHRlc3Qgc2V0dXAgaW4gYHNldHVwX2Rpcl9hc19lc21fbW9kdWxlLnRzYC5cbiAgICovXG4gIGFzeW5jIGluaXRpYWxpemVUc0NvbmZpZyh0YXJnZXREaXI6IHN0cmluZykge1xuICAgIGNvbnN0IHRzQ29uZmlnVGVtcGxhdGUgPSB7XG4gICAgICBjb21waWxlck9wdGlvbnM6IHtcbiAgICAgICAgdGFyZ2V0OiAnZXMyMDIyJyxcbiAgICAgICAgbW9kdWxlOiAnZXMyMDIyJyxcbiAgICAgICAgbW9kdWxlUmVzb2x1dGlvbjogJ2J1bmRsZXInLFxuICAgICAgICByZXNvbHZlSnNvbk1vZHVsZTogdHJ1ZSxcbiAgICAgICAgZXNNb2R1bGVJbnRlcm9wOiB0cnVlLFxuICAgICAgICBmb3JjZUNvbnNpc3RlbnRDYXNpbmdJbkZpbGVOYW1lczogdHJ1ZSxcbiAgICAgICAgc3RyaWN0OiB0cnVlLFxuICAgICAgICBza2lwTGliQ2hlY2s6IHRydWUsXG4gICAgICAgIC8vIFRoZSBwYXRoIGhlcmUgaXMgY291cGxlZCB3aXRoIGJhY2tlbmQtZnVuY3Rpb24ncyBnZW5lcmF0ZWQgdHlwZWRlZiBmaWxlIHBhdGhcbiAgICAgICAgcGF0aHM6IHsgJyRhbXBsaWZ5LyonOiBbJy4uLy5hbXBsaWZ5L2dlbmVyYXRlZC8qJ10gfSxcbiAgICAgIH0sXG4gICAgfTtcbiAgICBjb25zdCB0c0NvbmZpZ1BhdGggPSB0aGlzLnBhdGgucmVzb2x2ZSh0YXJnZXREaXIsICd0c2NvbmZpZy5qc29uJyk7XG4gICAgYXdhaXQgdGhpcy5mc3Aud3JpdGVGaWxlKFxuICAgICAgdHNDb25maWdQYXRoLFxuICAgICAgSlNPTi5zdHJpbmdpZnkodHNDb25maWdUZW1wbGF0ZSwgbnVsbCwgMiksXG4gICAgICAndXRmLTgnXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBydW5XaXRoUGFja2FnZU1hbmFnZXIgLSBGYWN0b3J5IGZ1bmN0aW9uIHRoYXQgcnVucyBhIGNvbW1hbmQgd2l0aCB0aGUgc3BlY2lmaWVkIHBhY2thZ2UgbWFuYWdlcidzIGJpbmFyeSBydW5uZXJcbiAgICovXG4gIHJ1bldpdGhQYWNrYWdlTWFuYWdlcihcbiAgICBhcmdzOiBzdHJpbmdbXSA9IFtdLFxuICAgIGRpcjogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBFeGVjYU9wdGlvbnNcbiAgKTogRXhlY2FDaGlsZFByb2Nlc3Mge1xuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVXaXRoRGVidWdMb2dnZXIoXG4gICAgICBkaXIsXG4gICAgICB0aGlzLmJpbmFyeVJ1bm5lcixcbiAgICAgIGFyZ3MsXG4gICAgICB0aGlzLmV4ZWNhLFxuICAgICAgb3B0aW9uc1xuICAgICk7XG4gIH1cblxuICBnZXRDb21tYW5kID0gKGFyZ3M6IHN0cmluZ1tdKSA9PiBgJHt0aGlzLmJpbmFyeVJ1bm5lcn0gJHthcmdzLmpvaW4oJyAnKX1gO1xuXG4gIC8qKlxuICAgKiBhbGxvd3NTaWduYWxQcm9wYWdhdGlvbiAtIERldGVybWluZXMgaWYgdGhlIHBhY2thZ2UgbWFuYWdlciBhbGxvd3MgdGhlIHByb2Nlc3NcbiAgICogc2lnbmFscyBzdWNoIGFzIFNJR0lOVCB0byBiZSBwcm9wYWdhdGVkIHRvIHRoZSB1bmRlcmx5aW5nIG5vZGUgcHJvY2Vzcy5cbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIGFsbG93c1NpZ25hbFByb3BhZ2F0aW9uID0gKCkgPT4gdHJ1ZTtcblxuICAvKipcbiAgICogdHJ5R2V0RGVwZW5kZW5jaWVzIC0gVHJpZXMgdG8gcmV0cmlldmUgZGVwZW5kZW5jeSB2ZXJzaW9ucyBmcm9tIHRoZSBsb2NrIGZpbGUgaW4gdGhlIHByb2plY3Qgcm9vdFxuICAgKi9cbiAgdHJ5R2V0RGVwZW5kZW5jaWVzID0gYXN5bmMgKCk6IFByb21pc2U8QXJyYXk8RGVwZW5kZW5jeT4gfCB1bmRlZmluZWQ+ID0+IHtcbiAgICBjb25zdCBsb2NrRmlsZUNvbnRlbnRzID1cbiAgICAgIGF3YWl0IHRoaXMubG9ja0ZpbGVSZWFkZXIuZ2V0TG9ja0ZpbGVDb250ZW50c0Zyb21Dd2QoKTtcblxuICAgIHJldHVybiBsb2NrRmlsZUNvbnRlbnRzPy5kZXBlbmRlbmNpZXM7XG4gIH07XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGEgcGFja2FnZS5qc29uIGZpbGUgZXhpc3RzIGluIHByb2plY3RSb290XG4gICAqL1xuICBwcml2YXRlIHBhY2thZ2VKc29uRXhpc3RzID0gKHByb2plY3RSb290OiBzdHJpbmcpOiBib29sZWFuID0+IHtcbiAgICByZXR1cm4gdGhpcy5leGlzdHNTeW5jKHRoaXMucGF0aC5yZXNvbHZlKHByb2plY3RSb290LCAncGFja2FnZS5qc29uJykpO1xuICB9O1xufVxuIl19