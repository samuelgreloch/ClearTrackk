import { Construct } from 'constructs';
import { CustomResource, Duration, Stack, aws_cognito, aws_iam, } from 'aws-cdk-lib';
import { AttributionMetadataStorage, StackMetadataBackendOutputStorageStrategy, } from '@aws-amplify/backend-output-storage';
import * as path from 'path';
import { NodejsFunction } from 'aws-cdk-lib/aws-lambda-nodejs';
import { Runtime } from 'aws-cdk-lib/aws-lambda';
import { Provider } from 'aws-cdk-lib/custom-resources';
import { Role } from 'aws-cdk-lib/aws-iam';
import { fileURLToPath } from 'node:url';
/**
 * Expected key that auth output is stored under - must match backend-output-schemas's authOutputKey
 */
export const authOutputKey = 'AWS::Amplify::Auth';
const REFERENCE_AUTH_CUSTOM_RESOURCE_PROVIDER_ID = 'AmplifyRefAuthCustomResourceProvider';
const REFERENCE_AUTH_CUSTOM_RESOURCE_ID = 'AmplifyRefAuthCustomResource';
const RESOURCE_TYPE = 'Custom::AmplifyRefAuth';
const filename = fileURLToPath(import.meta.url);
const dirname = path.dirname(filename);
const resourcesRoot = path.normalize(path.join(dirname, 'lambda'));
const refAuthLambdaFilePath = path.join(resourcesRoot, 'reference_auth_initializer.js');
const authStackType = 'auth-Cognito';
/**
 * These properties are fetched by the custom resource and must be accounted for
 * in the final AuthOutput payload.
 */
export const OUTPUT_PROPERTIES_PROVIDED_BY_AUTH_CUSTOM_RESOURCE = [
    'allowUnauthenticatedIdentities',
    'signupAttributes',
    'usernameAttributes',
    'verificationMechanisms',
    'passwordPolicyMinLength',
    'passwordPolicyRequirements',
    'mfaConfiguration',
    'mfaTypes',
    'socialProviders',
    'oauthCognitoDomain',
    'oauthScope',
    'oauthRedirectSignIn',
    'oauthRedirectSignOut',
    'oauthResponseType',
    'oauthClientId',
];
/**
 * Reference Auth construct for using external auth resources
 */
export class AmplifyReferenceAuth extends Construct {
    resources;
    configurationCustomResource;
    /**
     * Create a new AmplifyConstruct
     */
    constructor(scope, id, props) {
        super(scope, id);
        this.resources = {
            userPool: aws_cognito.UserPool.fromUserPoolId(this, 'UserPool', props.userPoolId),
            userPoolClient: aws_cognito.UserPoolClient.fromUserPoolClientId(this, 'UserPoolClient', props.userPoolClientId),
            authenticatedUserIamRole: aws_iam.Role.fromRoleArn(this, 'authenticatedUserRole', props.authRoleArn),
            unauthenticatedUserIamRole: aws_iam.Role.fromRoleArn(this, 'unauthenticatedUserRole', props.unauthRoleArn),
            identityPoolId: props.identityPoolId,
            groups: {},
        };
        // mapping of existing group roles
        if (props.groups) {
            Object.entries(props.groups).forEach(([groupName, roleArn]) => {
                this.resources.groups[groupName] = {
                    role: Role.fromRoleArn(this, `${groupName}GroupRole`, roleArn),
                };
            });
        }
        // custom resource lambda
        const refAuthLambda = new NodejsFunction(scope, `${REFERENCE_AUTH_CUSTOM_RESOURCE_PROVIDER_ID}Lambda`, {
            runtime: Runtime.NODEJS_18_X,
            timeout: Duration.seconds(10),
            entry: refAuthLambdaFilePath,
            handler: 'handler',
        });
        // UserPool & UserPoolClient specific permissions
        refAuthLambda.grantPrincipal.addToPrincipalPolicy(new aws_iam.PolicyStatement({
            effect: aws_iam.Effect.ALLOW,
            actions: [
                'cognito-idp:DescribeUserPool',
                'cognito-idp:GetUserPoolMfaConfig',
                'cognito-idp:ListIdentityProviders',
                'cognito-idp:ListGroups',
                'cognito-idp:DescribeUserPoolClient',
            ],
            resources: [this.resources.userPool.userPoolArn],
        }));
        // IdentityPool specific permissions
        const stack = Stack.of(this);
        refAuthLambda.grantPrincipal.addToPrincipalPolicy(new aws_iam.PolicyStatement({
            effect: aws_iam.Effect.ALLOW,
            actions: [
                'cognito-identity:DescribeIdentityPool',
                'cognito-identity:GetIdentityPoolRoles',
            ],
            resources: [
                `arn:aws:cognito-identity:${stack.region}:${stack.account}:identitypool/${this.resources.identityPoolId}`,
            ],
        }));
        const provider = new Provider(scope, REFERENCE_AUTH_CUSTOM_RESOURCE_PROVIDER_ID, {
            onEventHandler: refAuthLambda,
        });
        const initializerProps = {
            userPoolId: props.userPoolId,
            identityPoolId: props.identityPoolId,
            userPoolClientId: props.userPoolClientId,
            authRoleArn: props.authRoleArn,
            unauthRoleArn: props.unauthRoleArn,
            groups: props.groups ?? {},
            region: Stack.of(this).region,
        };
        // custom resource
        this.configurationCustomResource = new CustomResource(scope, REFERENCE_AUTH_CUSTOM_RESOURCE_ID, {
            serviceToken: provider.serviceToken,
            properties: {
                ...initializerProps,
            },
            resourceType: RESOURCE_TYPE,
        });
        this.storeOutput(props.outputStorageStrategy);
        new AttributionMetadataStorage().storeAttributionMetadata(Stack.of(this), authStackType, fileURLToPath(new URL('../package.json', import.meta.url)));
    }
    /**
     * Stores auth output using the provided strategy
     */
    storeOutput = (outputStorageStrategy = new StackMetadataBackendOutputStorageStrategy(Stack.of(this))) => {
        // these properties cannot be overwritten
        const output = {
            userPoolId: this.resources.userPool.userPoolId,
            webClientId: this.resources.userPoolClient.userPoolClientId,
            identityPoolId: this.resources.identityPoolId,
            authRegion: Stack.of(this).region,
        };
        // assign cdk tokens which will be resolved during deployment
        for (const property of OUTPUT_PROPERTIES_PROVIDED_BY_AUTH_CUSTOM_RESOURCE) {
            output[property] =
                this.configurationCustomResource.getAttString(property);
        }
        outputStorageStrategy.addBackendOutputEntry(authOutputKey, {
            version: '1',
            payload: output,
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlX2NvbnN0cnVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9yZWZlcmVuY2VfY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdkMsT0FBTyxFQUNMLGNBQWMsRUFDZCxRQUFRLEVBQ1IsS0FBSyxFQUNMLFdBQVcsRUFDWCxPQUFPLEdBQ1IsTUFBTSxhQUFhLENBQUM7QUFNckIsT0FBTyxFQUNMLDBCQUEwQixFQUMxQix5Q0FBeUMsR0FDMUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUU3QyxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDL0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2pELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUd6Qzs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxvQkFBb0IsQ0FBQztBQUVsRCxNQUFNLDBDQUEwQyxHQUM5QyxzQ0FBc0MsQ0FBQztBQUN6QyxNQUFNLGlDQUFpQyxHQUFHLDhCQUE4QixDQUFDO0FBQ3pFLE1BQU0sYUFBYSxHQUFHLHdCQUF3QixDQUFDO0FBRS9DLE1BQU0sUUFBUSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDdkMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9B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cm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7XG4gIEN1c3RvbVJlc291cmNlLFxuICBEdXJhdGlvbixcbiAgU3RhY2ssXG4gIGF3c19jb2duaXRvLFxuICBhd3NfaWFtLFxufSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICBSZWZlcmVuY2VBdXRoUmVzb3VyY2VzLFxuICBSZXNvdXJjZVByb3ZpZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlLFxuICBTdGFja01ldGFkYXRhQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXN0b3JhZ2UnO1xuaW1wb3J0IHsgQXV0aE91dHB1dCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBOb2RlanNGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IFJ1bnRpbWUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IFByb3ZpZGVyIH0gZnJvbSAnYXdzLWNkay1saWIvY3VzdG9tLXJlc291cmNlcyc7XG5pbXBvcnQgeyBSb2xlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXJQcm9wcyB9IGZyb20gJy4vbGFtYmRhL3JlZmVyZW5jZV9hdXRoX2luaXRpYWxpemVyLmpzJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICdub2RlOnVybCc7XG5pbXBvcnQgeyBSZWZlcmVuY2VBdXRoUHJvcHMgfSBmcm9tICcuL3JlZmVyZW5jZV9mYWN0b3J5LmpzJztcblxuLyoqXG4gKiBFeHBlY3RlZCBrZXkgdGhhdCBhdXRoIG91dHB1dCBpcyBzdG9yZWQgdW5kZXIgLSBtdXN0IG1hdGNoIGJhY2tlbmQtb3V0cHV0LXNjaGVtYXMncyBhdXRoT3V0cHV0S2V5XG4gKi9cbmV4cG9ydCBjb25zdCBhdXRoT3V0cHV0S2V5ID0gJ0FXUzo6QW1wbGlmeTo6QXV0aCc7XG5cbmNvbnN0IFJFRkVSRU5DRV9BVVRIX0NVU1RPTV9SRVNPVVJDRV9QUk9WSURFUl9JRCA9XG4gICdBbXBsaWZ5UmVmQXV0aEN1c3RvbVJlc291cmNlUHJvdmlkZXInO1xuY29uc3QgUkVGRVJFTkNFX0FVVEhfQ1VTVE9NX1JFU09VUkNFX0lEID0gJ0FtcGxpZnlSZWZBdXRoQ3VzdG9tUmVzb3VyY2UnO1xuY29uc3QgUkVTT1VSQ0VfVFlQRSA9ICdDdXN0b206OkFtcGxpZnlSZWZBdXRoJztcblxuY29uc3QgZmlsZW5hbWUgPSBmaWxlVVJMVG9QYXRoKGltcG9ydC5tZXRhLnVybCk7XG5jb25zdCBkaXJuYW1lID0gcGF0aC5kaXJuYW1lKGZpbGVuYW1lKTtcbmNvbnN0IHJlc291cmNlc1Jvb3QgPSBwYXRoLm5vcm1hbGl6ZShwYXRoLmpvaW4oZGlybmFtZSwgJ2xhbWJkYScpKTtcbmNvbnN0IHJlZkF1dGhMYW1iZGFGaWxlUGF0aCA9IHBhdGguam9pbihcbiAgcmVzb3VyY2VzUm9vdCxcbiAgJ3JlZmVyZW5jZV9hdXRoX2luaXRpYWxpemVyLmpzJ1xuKTtcblxuY29uc3QgYXV0aFN0YWNrVHlwZSA9ICdhdXRoLUNvZ25pdG8nO1xuXG4vKipcbiAqIFRoZXNlIHByb3BlcnRpZXMgYXJlIGZldGNoZWQgYnkgdGhlIGN1c3RvbSByZXNvdXJjZSBhbmQgbXVzdCBiZSBhY2NvdW50ZWQgZm9yXG4gKiBpbiB0aGUgZmluYWwgQXV0aE91dHB1dCBwYXlsb2FkLlxuICovXG5leHBvcnQgY29uc3QgT1VUUFVUX1BST1BFUlRJRVNfUFJPVklERURfQllfQVVUSF9DVVNUT01fUkVTT1VSQ0U6IChrZXlvZiBBdXRoT3V0cHV0WydwYXlsb2FkJ10pW10gPVxuICBbXG4gICAgJ2FsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcycsXG4gICAgJ3NpZ251cEF0dHJpYnV0ZXMnLFxuICAgICd1c2VybmFtZUF0dHJpYnV0ZXMnLFxuICAgICd2ZXJpZmljYXRpb25NZWNoYW5pc21zJyxcbiAgICAncGFzc3dvcmRQb2xpY3lNaW5MZW5ndGgnLFxuICAgICdwYXNzd29yZFBvbGljeVJlcXVpcmVtZW50cycsXG4gICAgJ21mYUNvbmZpZ3VyYXRpb24nLFxuICAgICdtZmFUeXBlcycsXG4gICAgJ3NvY2lhbFByb3ZpZGVycycsXG4gICAgJ29hdXRoQ29nbml0b0RvbWFpbicsXG4gICAgJ29hdXRoU2NvcGUnLFxuICAgICdvYXV0aFJlZGlyZWN0U2lnbkluJyxcbiAgICAnb2F1dGhSZWRpcmVjdFNpZ25PdXQnLFxuICAgICdvYXV0aFJlc3BvbnNlVHlwZScsXG4gICAgJ29hdXRoQ2xpZW50SWQnLFxuICBdO1xuLyoqXG4gKiBSZWZlcmVuY2UgQXV0aCBjb25zdHJ1Y3QgZm9yIHVzaW5nIGV4dGVybmFsIGF1dGggcmVzb3VyY2VzXG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5UmVmZXJlbmNlQXV0aFxuICBleHRlbmRzIENvbnN0cnVjdFxuICBpbXBsZW1lbnRzIFJlc291cmNlUHJvdmlkZXI8UmVmZXJlbmNlQXV0aFJlc291cmNlcz5cbntcbiAgcmVzb3VyY2VzOiBSZWZlcmVuY2VBdXRoUmVzb3VyY2VzO1xuXG4gIHByaXZhdGUgY29uZmlndXJhdGlvbkN1c3RvbVJlc291cmNlOiBDdXN0b21SZXNvdXJjZTtcblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IEFtcGxpZnlDb25zdHJ1Y3RcbiAgICovXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBSZWZlcmVuY2VBdXRoUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5yZXNvdXJjZXMgPSB7XG4gICAgICB1c2VyUG9vbDogYXdzX2NvZ25pdG8uVXNlclBvb2wuZnJvbVVzZXJQb29sSWQoXG4gICAgICAgIHRoaXMsXG4gICAgICAgICdVc2VyUG9vbCcsXG4gICAgICAgIHByb3BzLnVzZXJQb29sSWRcbiAgICAgICksXG4gICAgICB1c2VyUG9vbENsaWVudDogYXdzX2NvZ25pdG8uVXNlclBvb2xDbGllbnQuZnJvbVVzZXJQb29sQ2xpZW50SWQoXG4gICAgICAgIHRoaXMsXG4gICAgICAgICdVc2VyUG9vbENsaWVudCcsXG4gICAgICAgIHByb3BzLnVzZXJQb29sQ2xpZW50SWRcbiAgICAgICksXG4gICAgICBhdXRoZW50aWNhdGVkVXNlcklhbVJvbGU6IGF3c19pYW0uUm9sZS5mcm9tUm9sZUFybihcbiAgICAgICAgdGhpcyxcbiAgICAgICAgJ2F1dGhlbnRpY2F0ZWRVc2VyUm9sZScsXG4gICAgICAgIHByb3BzLmF1dGhSb2xlQXJuXG4gICAgICApLFxuICAgICAgdW5hdXRoZW50aWNhdGVkVXNlcklhbVJvbGU6IGF3c19pYW0uUm9sZS5mcm9tUm9sZUFybihcbiAgICAgICAgdGhpcyxcbiAgICAgICAgJ3VuYXV0aGVudGljYXRlZFVzZXJSb2xlJyxcbiAgICAgICAgcHJvcHMudW5hdXRoUm9sZUFyblxuICAgICAgKSxcbiAgICAgIGlkZW50aXR5UG9vbElkOiBwcm9wcy5pZGVudGl0eVBvb2xJZCxcbiAgICAgIGdyb3Vwczoge30sXG4gICAgfTtcblxuICAgIC8vIG1hcHBpbmcgb2YgZXhpc3RpbmcgZ3JvdXAgcm9sZXNcbiAgICBpZiAocHJvcHMuZ3JvdXBzKSB7XG4gICAgICBPYmplY3QuZW50cmllcyhwcm9wcy5ncm91cHMpLmZvckVhY2goKFtncm91cE5hbWUsIHJvbGVBcm5dKSA9PiB7XG4gICAgICAgIHRoaXMucmVzb3VyY2VzLmdyb3Vwc1tncm91cE5hbWVdID0ge1xuICAgICAgICAgIHJvbGU6IFJvbGUuZnJvbVJvbGVBcm4odGhpcywgYCR7Z3JvdXBOYW1lfUdyb3VwUm9sZWAsIHJvbGVBcm4pLFxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gY3VzdG9tIHJlc291cmNlIGxhbWJkYVxuICAgIGNvbnN0IHJlZkF1dGhMYW1iZGEgPSBuZXcgTm9kZWpzRnVuY3Rpb24oXG4gICAgICBzY29wZSxcbiAgICAgIGAke1JFRkVSRU5DRV9BVVRIX0NVU1RPTV9SRVNPVVJDRV9QUk9WSURFUl9JRH1MYW1iZGFgLFxuICAgICAge1xuICAgICAgICBydW50aW1lOiBSdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKDEwKSxcbiAgICAgICAgZW50cnk6IHJlZkF1dGhMYW1iZGFGaWxlUGF0aCxcbiAgICAgICAgaGFuZGxlcjogJ2hhbmRsZXInLFxuICAgICAgfVxuICAgICk7XG4gICAgLy8gVXNlclBvb2wgJiBVc2VyUG9vbENsaWVudCBzcGVjaWZpYyBwZXJtaXNzaW9uc1xuICAgIHJlZkF1dGhMYW1iZGEuZ3JhbnRQcmluY2lwYWwuYWRkVG9QcmluY2lwYWxQb2xpY3koXG4gICAgICBuZXcgYXdzX2lhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGF3c19pYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgJ2NvZ25pdG8taWRwOkRlc2NyaWJlVXNlclBvb2wnLFxuICAgICAgICAgICdjb2duaXRvLWlkcDpHZXRVc2VyUG9vbE1mYUNvbmZpZycsXG4gICAgICAgICAgJ2NvZ25pdG8taWRwOkxpc3RJZGVudGl0eVByb3ZpZGVycycsXG4gICAgICAgICAgJ2NvZ25pdG8taWRwOkxpc3RHcm91cHMnLFxuICAgICAgICAgICdjb2duaXRvLWlkcDpEZXNjcmliZVVzZXJQb29sQ2xpZW50JyxcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbdGhpcy5yZXNvdXJjZXMudXNlclBvb2wudXNlclBvb2xBcm5dLFxuICAgICAgfSlcbiAgICApO1xuICAgIC8vIElkZW50aXR5UG9vbCBzcGVjaWZpYyBwZXJtaXNzaW9uc1xuICAgIGNvbnN0IHN0YWNrID0gU3RhY2sub2YodGhpcyk7XG4gICAgcmVmQXV0aExhbWJkYS5ncmFudFByaW5jaXBhbC5hZGRUb1ByaW5jaXBhbFBvbGljeShcbiAgICAgIG5ldyBhd3NfaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogYXdzX2lhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAnY29nbml0by1pZGVudGl0eTpEZXNjcmliZUlkZW50aXR5UG9vbCcsXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHk6R2V0SWRlbnRpdHlQb29sUm9sZXMnLFxuICAgICAgICBdLFxuICAgICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgICBgYXJuOmF3czpjb2duaXRvLWlkZW50aXR5OiR7c3RhY2sucmVnaW9ufToke3N0YWNrLmFjY291bnR9OmlkZW50aXR5cG9vbC8ke3RoaXMucmVzb3VyY2VzLmlkZW50aXR5UG9vbElkfWAsXG4gICAgICAgIF0sXG4gICAgICB9KVxuICAgICk7XG4gICAgY29uc3QgcHJvdmlkZXIgPSBuZXcgUHJvdmlkZXIoXG4gICAgICBzY29wZSxcbiAgICAgIFJFRkVSRU5DRV9BVVRIX0NVU1RPTV9SRVNPVVJDRV9QUk9WSURFUl9JRCxcbiAgICAgIHtcbiAgICAgICAgb25FdmVudEhhbmRsZXI6IHJlZkF1dGhMYW1iZGEsXG4gICAgICB9XG4gICAgKTtcbiAgICBjb25zdCBpbml0aWFsaXplclByb3BzOiBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXJQcm9wcyA9IHtcbiAgICAgIHVzZXJQb29sSWQ6IHByb3BzLnVzZXJQb29sSWQsXG4gICAgICBpZGVudGl0eVBvb2xJZDogcHJvcHMuaWRlbnRpdHlQb29sSWQsXG4gICAgICB1c2VyUG9vbENsaWVudElkOiBwcm9wcy51c2VyUG9vbENsaWVudElkLFxuICAgICAgYXV0aFJvbGVBcm46IHByb3BzLmF1dGhSb2xlQXJuLFxuICAgICAgdW5hdXRoUm9sZUFybjogcHJvcHMudW5hdXRoUm9sZUFybixcbiAgICAgIGdyb3VwczogcHJvcHMuZ3JvdXBzID8/IHt9LFxuICAgICAgcmVnaW9uOiBTdGFjay5vZih0aGlzKS5yZWdpb24sXG4gICAgfTtcbiAgICAvLyBjdXN0b20gcmVzb3VyY2VcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb25DdXN0b21SZXNvdXJjZSA9IG5ldyBDdXN0b21SZXNvdXJjZShcbiAgICAgIHNjb3BlLFxuICAgICAgUkVGRVJFTkNFX0FVVEhfQ1VTVE9NX1JFU09VUkNFX0lELFxuICAgICAge1xuICAgICAgICBzZXJ2aWNlVG9rZW46IHByb3ZpZGVyLnNlcnZpY2VUb2tlbixcbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgIC4uLmluaXRpYWxpemVyUHJvcHMsXG4gICAgICAgIH0sXG4gICAgICAgIHJlc291cmNlVHlwZTogUkVTT1VSQ0VfVFlQRSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5zdG9yZU91dHB1dChwcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuICAgIG5ldyBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSgpLnN0b3JlQXR0cmlidXRpb25NZXRhZGF0YShcbiAgICAgIFN0YWNrLm9mKHRoaXMpLFxuICAgICAgYXV0aFN0YWNrVHlwZSxcbiAgICAgIGZpbGVVUkxUb1BhdGgobmV3IFVSTCgnLi4vcGFja2FnZS5qc29uJywgaW1wb3J0Lm1ldGEudXJsKSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0b3JlcyBhdXRoIG91dHB1dCB1c2luZyB0aGUgcHJvdmlkZWQgc3RyYXRlZ3lcbiAgICovXG4gIHByaXZhdGUgc3RvcmVPdXRwdXQgPSAoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEF1dGhPdXRwdXQ+ID0gbmV3IFN0YWNrTWV0YWRhdGFCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5KFxuICAgICAgU3RhY2sub2YodGhpcylcbiAgICApXG4gICk6IHZvaWQgPT4ge1xuICAgIC8vIHRoZXNlIHByb3BlcnRpZXMgY2Fubm90IGJlIG92ZXJ3cml0dGVuXG4gICAgY29uc3Qgb3V0cHV0OiBBdXRoT3V0cHV0WydwYXlsb2FkJ10gPSB7XG4gICAgICB1c2VyUG9vbElkOiB0aGlzLnJlc291cmNlcy51c2VyUG9vbC51c2VyUG9vbElkLFxuICAgICAgd2ViQ2xpZW50SWQ6IHRoaXMucmVzb3VyY2VzLnVzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICBpZGVudGl0eVBvb2xJZDogdGhpcy5yZXNvdXJjZXMuaWRlbnRpdHlQb29sSWQsXG4gICAgICBhdXRoUmVnaW9uOiBTdGFjay5vZih0aGlzKS5yZWdpb24sXG4gICAgfTtcblxuICAgIC8vIGFzc2lnbiBjZGsgdG9rZW5zIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgZHVyaW5nIGRlcGxveW1lbnRcbiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIE9VVFBVVF9QUk9QRVJUSUVTX1BST1ZJREVEX0JZX0FVVEhfQ1VTVE9NX1JFU09VUkNFKSB7XG4gICAgICBvdXRwdXRbcHJvcGVydHldID1cbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uQ3VzdG9tUmVzb3VyY2UuZ2V0QXR0U3RyaW5nKHByb3BlcnR5KTtcbiAgICB9XG5cbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYWRkQmFja2VuZE91dHB1dEVudHJ5KGF1dGhPdXRwdXRLZXksIHtcbiAgICAgIHZlcnNpb246ICcxJyxcbiAgICAgIHBheWxvYWQ6IG91dHB1dCxcbiAgICB9KTtcbiAgfTtcbn1cbiJdfQ==