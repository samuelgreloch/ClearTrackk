import { CognitoIdentityProviderClient, DescribeUserPoolClientCommand, DescribeUserPoolCommand, GetUserPoolMfaConfigCommand, ListGroupsCommand, ListIdentityProvidersCommand, } from '@aws-sdk/client-cognito-identity-provider';
import { CognitoIdentityClient, DescribeIdentityPoolCommand, GetIdentityPoolRolesCommand, } from '@aws-sdk/client-cognito-identity';
import { randomUUID } from 'node:crypto';
/**
 * Initializer that fetches and process auth resources.
 */
export class ReferenceAuthInitializer {
    cognitoIdentityClient;
    cognitoIdentityProviderClient;
    uuidGenerator;
    /**
     * Create a new initializer
     * @param cognitoIdentityClient identity client
     * @param cognitoIdentityProviderClient identity provider client
     */
    constructor(cognitoIdentityClient, cognitoIdentityProviderClient, uuidGenerator) {
        this.cognitoIdentityClient = cognitoIdentityClient;
        this.cognitoIdentityProviderClient = cognitoIdentityProviderClient;
        this.uuidGenerator = uuidGenerator;
    }
    /**
     * Handles custom resource events
     * @param event event to process
     * @returns custom resource response
     */
    handleEvent = async (event) => {
        console.info(`Received '${event.RequestType}' event`);
        // physical id is only generated on create, otherwise it must stay the same
        const physicalId = event.RequestType === 'Create'
            ? this.uuidGenerator()
            : event.PhysicalResourceId;
        // on delete, just respond with success since we don't need to do anything
        if (event.RequestType === 'Delete') {
            return {
                RequestId: event.RequestId,
                LogicalResourceId: event.LogicalResourceId,
                PhysicalResourceId: physicalId,
                StackId: event.StackId,
                NoEcho: true,
                Status: 'SUCCESS',
            };
        }
        // for create or update events, we will fetch and validate resource properties
        const props = event.ResourceProperties;
        const { userPool, userPoolPasswordPolicy, userPoolMFA, userPoolGroups, userPoolProviders, userPoolClient, identityPool, roles, } = await this.getResourceDetails(props.userPoolId, props.identityPoolId, props.userPoolClientId);
        this.validateResources(userPool, userPoolProviders, userPoolGroups, userPoolClient, identityPool, roles, props);
        const userPoolOutputs = await this.getUserPoolOutputs(userPool, userPoolPasswordPolicy, userPoolProviders, userPoolMFA, props.region);
        const identityPoolOutputs = await this.getIdentityPoolOutputs(identityPool);
        const userPoolClientOutputs = await this.getUserPoolClientOutputs(userPoolClient);
        const data = {
            userPoolId: props.userPoolId,
            webClientId: props.userPoolClientId,
            identityPoolId: props.identityPoolId,
            ...userPoolOutputs,
            ...identityPoolOutputs,
            ...userPoolClientOutputs,
        };
        return {
            RequestId: event.RequestId,
            LogicalResourceId: event.LogicalResourceId,
            PhysicalResourceId: physicalId,
            StackId: event.StackId,
            NoEcho: true,
            Data: data,
            Status: 'SUCCESS',
        };
    };
    getUserPool = async (userPoolId) => {
        const userPoolCommand = new DescribeUserPoolCommand({
            UserPoolId: userPoolId,
        });
        const userPoolResponse = await this.cognitoIdentityProviderClient.send(userPoolCommand);
        if (!userPoolResponse.UserPool) {
            throw new Error('Failed to retrieve the specified UserPool.');
        }
        const userPool = userPoolResponse.UserPool;
        const policy = userPool.Policies?.PasswordPolicy;
        if (!policy) {
            throw new Error('Failed to retrieve password policy.');
        }
        return {
            userPool: userPoolResponse.UserPool,
            userPoolPasswordPolicy: policy,
        };
    };
    getUserPoolMFASettings = async (userPoolId) => {
        // mfa types
        const mfaCommand = new GetUserPoolMfaConfigCommand({
            UserPoolId: userPoolId,
        });
        const mfaResponse = await this.cognitoIdentityProviderClient.send(mfaCommand);
        return mfaResponse;
    };
    getUserPoolGroups = async (userPoolId) => {
        let nextToken;
        const groups = [];
        do {
            const listGroupsResponse = await this.cognitoIdentityProviderClient.send(new ListGroupsCommand({
                UserPoolId: userPoolId,
                NextToken: nextToken,
            }));
            if (!listGroupsResponse.Groups) {
                throw new Error('An error occurred while retrieving the groups for the user pool.');
            }
            groups.push(...listGroupsResponse.Groups);
            nextToken = listGroupsResponse.NextToken;
        } while (nextToken);
        return groups;
    };
    getUserPoolProviders = async (userPoolId) => {
        const providers = [];
        let nextToken;
        do {
            const providersResponse = await this.cognitoIdentityProviderClient.send(new ListIdentityProvidersCommand({
                UserPoolId: userPoolId,
                NextToken: nextToken,
            }));
            if (providersResponse.Providers === undefined) {
                throw new Error('An error occurred while retrieving identity providers for the user pool.');
            }
            providers.push(...providersResponse.Providers);
            nextToken = providersResponse.NextToken;
        } while (nextToken);
        return providers;
    };
    getIdentityPool = async (identityPoolId) => {
        const idpResponse = await this.cognitoIdentityClient.send(new DescribeIdentityPoolCommand({
            IdentityPoolId: identityPoolId,
        }));
        if (!idpResponse.IdentityPoolId) {
            throw new Error('An error occurred while retrieving the identity pool details.');
        }
        return idpResponse;
    };
    getIdentityPoolRoles = async (identityPoolId) => {
        const rolesCommand = new GetIdentityPoolRolesCommand({
            IdentityPoolId: identityPoolId,
        });
        const rolesResponse = await this.cognitoIdentityClient.send(rolesCommand);
        if (!rolesResponse.Roles) {
            throw new Error('An error occurred while retrieving the roles for the identity pool.');
        }
        return rolesResponse.Roles;
    };
    getUserPoolClient = async (userPoolId, userPoolClientId) => {
        const userPoolClientCommand = new DescribeUserPoolClientCommand({
            UserPoolId: userPoolId,
            ClientId: userPoolClientId,
        });
        const userPoolClientResponse = await this.cognitoIdentityProviderClient.send(userPoolClientCommand);
        if (!userPoolClientResponse.UserPoolClient) {
            throw new Error('An error occurred while retrieving the user pool client details.');
        }
        return userPoolClientResponse.UserPoolClient;
    };
    /**
     * Retrieves all of the resource data that is necessary for validation and output generation.
     * @param userPoolId userPoolId
     * @param identityPoolId identityPoolId
     * @param userPoolClientId userPoolClientId
     * @returns all necessary resource data
     */
    getResourceDetails = async (userPoolId, identityPoolId, userPoolClientId) => {
        const { userPool, userPoolPasswordPolicy } = await this.getUserPool(userPoolId);
        const userPoolMFA = await this.getUserPoolMFASettings(userPoolId);
        const userPoolProviders = await this.getUserPoolProviders(userPoolId);
        const userPoolGroups = await this.getUserPoolGroups(userPoolId);
        const userPoolClient = await this.getUserPoolClient(userPoolId, userPoolClientId);
        const identityPool = await this.getIdentityPool(identityPoolId);
        const roles = await this.getIdentityPoolRoles(identityPoolId);
        return {
            userPool,
            userPoolPasswordPolicy,
            userPoolMFA,
            userPoolProviders,
            userPoolGroups,
            userPoolClient,
            identityPool,
            roles,
        };
    };
    /**
     * Validate the resource associations.
     * 1. make sure the user pool & user pool client pair are a cognito provider for the identity pool
     * 2. make sure the provided auth/unauth role ARNs match the roles for the identity pool
     * 3. make sure the user pool client is a web client
     * @param userPool userPool
     * @param userPoolProviders the user pool providers
     * @param userPoolGroups the existing groups for the userPool
     * @param userPoolClient userPoolClient
     * @param identityPool identityPool
     * @param identityPoolRoles identityPool roles
     * @param props props that include the roles which we compare with the actual roles for the identity pool
     */
    validateResources = (userPool, userPoolProviders, userPoolGroups, userPoolClient, identityPool, identityPoolRoles, props) => {
        // verify the user pool is a cognito provider for this identity pool
        if (!identityPool.CognitoIdentityProviders ||
            identityPool.CognitoIdentityProviders.length === 0) {
            throw new Error('The specified identity pool does not have any cognito identity providers.');
        }
        // check for alias attributes, since we don't support this yet
        if (userPool.AliasAttributes && userPool.AliasAttributes.length > 0) {
            throw new Error('The specified user pool is configured with alias attributes which are not currently supported.');
        }
        // check OAuth settings
        if (userPoolProviders.length > 0) {
            // validate user pool
            const domainSpecified = userPool.Domain || userPool.CustomDomain;
            if (!domainSpecified) {
                throw new Error('You must configure a domain for your UserPool if external login providers are enabled.');
            }
            // validate user pool client
            const hasLogoutUrls = userPoolClient.LogoutURLs && userPoolClient.LogoutURLs.length > 0;
            const hasCallbackUrls = userPoolClient.CallbackURLs && userPoolClient.CallbackURLs.length > 0;
            if (!hasLogoutUrls) {
                throw new Error('Your UserPool client must have "Allowed sign-out URLs" configured if external login providers are enabled.');
            }
            if (!hasCallbackUrls) {
                throw new Error('Your UserPool client must have "Allowed callback URLs" configured if external login providers are enabled.');
            }
        }
        // make sure props groups Roles actually exist for the user pool
        const groupEntries = Object.entries(props.groups);
        for (const [groupName, groupRoleARN] of groupEntries) {
            const match = userPoolGroups.find((g) => g.RoleArn === groupRoleARN);
            if (match === undefined) {
                throw new Error(`The group '${groupName}' with role '${groupRoleARN}' does not match any group for the specified user pool.`);
            }
        }
        // verify that the user pool + user pool client pair are configured with the identity pool
        const matchingProvider = identityPool.CognitoIdentityProviders.find((p) => {
            const matchingUserPool = p.ProviderName ===
                `cognito-idp.${props.region}.amazonaws.com/${userPool.Id}`;
            const matchingUserPoolClient = p.ClientId === userPoolClient.ClientId;
            return matchingUserPool && matchingUserPoolClient;
        });
        if (!matchingProvider) {
            throw new Error('The user pool and user pool client pair do not match any cognito identity providers for the specified identity pool.');
        }
        // verify the auth / unauth roles from the props match the identity pool roles that we retrieved
        const authRoleArn = identityPoolRoles['authenticated'];
        const unauthRoleArn = identityPoolRoles['unauthenticated'];
        if (authRoleArn !== props.authRoleArn) {
            throw new Error('The provided authRoleArn does not match the authenticated role for the specified identity pool.');
        }
        if (unauthRoleArn !== props.unauthRoleArn) {
            throw new Error('The provided unauthRoleArn does not match the unauthenticated role for the specified identity pool.');
        }
        // make sure the client is a web client here (web clients shouldn't have client secrets)
        if (userPoolClient?.ClientSecret) {
            throw new Error('The specified user pool client is not configured as a web client.');
        }
    };
    /**
     * Transform the userPool data into outputs.
     * @param userPool user pool
     * @param userPoolPasswordPolicy user pool password policy
     * @param userPoolProviders user pool providers
     * @param userPoolMFA user pool MFA settings
     * @returns formatted outputs
     */
    getUserPoolOutputs = (userPool, userPoolPasswordPolicy, userPoolProviders, userPoolMFA, region) => {
        // password policy requirements
        const requirements = [];
        userPoolPasswordPolicy.RequireNumbers &&
            requirements.push('REQUIRES_NUMBERS');
        userPoolPasswordPolicy.RequireLowercase &&
            requirements.push('REQUIRES_LOWERCASE');
        userPoolPasswordPolicy.RequireUppercase &&
            requirements.push('REQUIRES_UPPERCASE');
        userPoolPasswordPolicy.RequireSymbols &&
            requirements.push('REQUIRES_SYMBOLS');
        // mfa types
        const mfaTypes = [];
        if (userPoolMFA.SmsMfaConfiguration &&
            userPoolMFA.SmsMfaConfiguration.SmsConfiguration) {
            mfaTypes.push('SMS_MFA');
        }
        if (userPoolMFA.SoftwareTokenMfaConfiguration?.Enabled) {
            mfaTypes.push('TOTP');
        }
        // social providers
        const socialProviders = [];
        if (userPoolProviders) {
            for (const provider of userPoolProviders) {
                const providerType = provider.ProviderType;
                const providerName = provider.ProviderName;
                if (providerType === 'Google') {
                    socialProviders.push('GOOGLE');
                }
                if (providerType === 'Facebook') {
                    socialProviders.push('FACEBOOK');
                }
                if (providerType === 'SignInWithApple') {
                    socialProviders.push('SIGN_IN_WITH_APPLE');
                }
                if (providerType === 'LoginWithAmazon') {
                    socialProviders.push('LOGIN_WITH_AMAZON');
                }
                if (providerType === 'OIDC' && providerName) {
                    socialProviders.push(providerName);
                }
                if (providerType === 'SAML' && providerName) {
                    socialProviders.push(providerName);
                }
            }
        }
        // domain
        const oauthDomain = userPool.CustomDomain ?? userPool.Domain ?? '';
        const fullDomainPath = `${oauthDomain}.auth.${region}.amazoncognito.com`;
        const data = {
            signupAttributes: JSON.stringify(userPool.SchemaAttributes?.filter((attribute) => attribute.Required && attribute.Name).map((attribute) => attribute.Name?.toLowerCase()) || []),
            usernameAttributes: JSON.stringify(userPool.UsernameAttributes?.map((attribute) => attribute.toLowerCase()) || []),
            verificationMechanisms: JSON.stringify(userPool.AutoVerifiedAttributes ?? []),
            passwordPolicyMinLength: userPoolPasswordPolicy.MinimumLength === undefined
                ? ''
                : userPoolPasswordPolicy.MinimumLength.toString(),
            passwordPolicyRequirements: JSON.stringify(requirements),
            mfaConfiguration: userPool.MfaConfiguration ?? 'OFF',
            mfaTypes: JSON.stringify(mfaTypes),
            socialProviders: JSON.stringify(socialProviders),
            oauthCognitoDomain: fullDomainPath,
        };
        return data;
    };
    /**
     * Transforms identityPool info into outputs.
     * @param identityPool identity pool data
     * @returns formatted outputs
     */
    getIdentityPoolOutputs = (identityPool) => {
        const data = {
            allowUnauthenticatedIdentities: identityPool.AllowUnauthenticatedIdentities === true ? 'true' : 'false',
        };
        return data;
    };
    /**
     * Transforms userPoolClient info into outputs.
     * @param userPoolClient userPoolClient data
     * @returns formatted outputs
     */
    getUserPoolClientOutputs = (userPoolClient) => {
        const data = {
            oauthScope: JSON.stringify(userPoolClient.AllowedOAuthScopes ?? []),
            oauthRedirectSignIn: userPoolClient.CallbackURLs
                ? userPoolClient.CallbackURLs.join(',')
                : '',
            oauthRedirectSignOut: userPoolClient.LogoutURLs
                ? userPoolClient.LogoutURLs.join(',')
                : '',
            oauthResponseType: userPoolClient.AllowedOAuthFlows
                ? userPoolClient.AllowedOAuthFlows.join(',')
                : '',
            oauthClientId: userPoolClient.ClientId,
        };
        return data;
    };
}
/**
 * Entry point for the lambda-backend custom resource to retrieve auth outputs.
 */
export const handler = async (event) => {
    const initializer = new ReferenceAuthInitializer(new CognitoIdentityClient(), new CognitoIdentityProviderClient(), randomUUID);
    return initializer.handleEvent(event);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlX2F1dGhfaW5pdGlhbGl6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGFtYmRhL3JlZmVyZW5jZV9hdXRoX2luaXRpYWxpemVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE9BQU8sRUFDTCw2QkFBNkIsRUFDN0IsNkJBQTZCLEVBQzdCLHVCQUF1QixFQUN2QiwyQkFBMkIsRUFHM0IsaUJBQWlCLEVBQ2pCLDRCQUE0QixHQUs3QixNQUFNLDJDQUEyQyxDQUFDO0FBQ25ELE9BQU8sRUFDTCxxQkFBcUIsRUFDckIsMkJBQTJCLEVBRTNCLDJCQUEyQixHQUM1QixNQUFNLGtDQUFrQyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFZekM7O0dBRUc7QUFDSCxNQUFNLE9BQU8sd0JBQXdCO0lBT3pCO0lBQ0E7SUFDQTtJQVJWOzs7O09BSUc7SUFDSCxZQUNVLHFCQUE0QyxFQUM1Qyw2QkFBNEQsRUFDNUQsYUFBMkI7UUFGM0IsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUM1QyxrQ0FBNkIsR0FBN0IsNkJBQTZCLENBQStCO1FBQzVELGtCQUFhLEdBQWIsYUFBYSxDQUFjO0lBQ2xDLENBQUM7SUFFSjs7OztPQUlHO0lBQ0ksV0FBVyxHQUFHLEtBQUssRUFBRSxLQUF3QyxFQUFFLEVBQUU7UUFDdEUsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLEtBQUssQ0FBQyxXQUFXLFNBQVMsQ0FBQyxDQUFDO1FBQ3RELDJFQUEyRTtRQUMzRSxNQUFNLFVBQVUsR0FDZCxLQUFLLENBQUMsV0FBVyxLQUFLLFFBQVE7WUFDNUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQztRQUUvQiwwRUFBMEU7UUFDMUUsSUFBSSxLQUFLLENBQUMsV0FBVyxLQUFLLFFBQVEsRUFBRTtZQUNsQyxPQUFPO2dCQUNM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QyxVQUFVLENBQ1gsQ0FBQztJQUNGLE9BQU8sV0FBVyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN4QyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQsXG4gIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VSZXNwb25zZSxcbiAgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVN1Y2Nlc3NSZXNwb25zZSxcbn0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQge1xuICBDb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudCxcbiAgRGVzY3JpYmVVc2VyUG9vbENsaWVudENvbW1hbmQsXG4gIERlc2NyaWJlVXNlclBvb2xDb21tYW5kLFxuICBHZXRVc2VyUG9vbE1mYUNvbmZpZ0NvbW1hbmQsXG4gIEdldFVzZXJQb29sTWZhQ29uZmlnQ29tbWFuZE91dHB1dCxcbiAgR3JvdXBUeXBlLFxuICBMaXN0R3JvdXBzQ29tbWFuZCxcbiAgTGlzdElkZW50aXR5UHJvdmlkZXJzQ29tbWFuZCxcbiAgUGFzc3dvcmRQb2xpY3lUeXBlLFxuICBQcm92aWRlckRlc2NyaXB0aW9uLFxuICBVc2VyUG9vbENsaWVudFR5cGUsXG4gIFVzZXJQb29sVHlwZSxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNvZ25pdG8taWRlbnRpdHktcHJvdmlkZXInO1xuaW1wb3J0IHtcbiAgQ29nbml0b0lkZW50aXR5Q2xpZW50LFxuICBEZXNjcmliZUlkZW50aXR5UG9vbENvbW1hbmQsXG4gIERlc2NyaWJlSWRlbnRpdHlQb29sQ29tbWFuZE91dHB1dCxcbiAgR2V0SWRlbnRpdHlQb29sUm9sZXNDb21tYW5kLFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtY29nbml0by1pZGVudGl0eSc7XG5pbXBvcnQgeyByYW5kb21VVUlEIH0gZnJvbSAnbm9kZTpjcnlwdG8nO1xuaW1wb3J0IHsgQXV0aE91dHB1dCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmV4cG9ydCB0eXBlIFJlZmVyZW5jZUF1dGhJbml0aWFsaXplclByb3BzID0ge1xuICB1c2VyUG9vbElkOiBzdHJpbmc7XG4gIGlkZW50aXR5UG9vbElkOiBzdHJpbmc7XG4gIGF1dGhSb2xlQXJuOiBzdHJpbmc7XG4gIHVuYXV0aFJvbGVBcm46IHN0cmluZztcbiAgdXNlclBvb2xDbGllbnRJZDogc3RyaW5nO1xuICBncm91cHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIHJlZ2lvbjogc3RyaW5nO1xufTtcblxuLyoqXG4gKiBJbml0aWFsaXplciB0aGF0IGZldGNoZXMgYW5kIHByb2Nlc3MgYXV0aCByZXNvdXJjZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXIge1xuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IGluaXRpYWxpemVyXG4gICAqIEBwYXJhbSBjb2duaXRvSWRlbnRpdHlDbGllbnQgaWRlbnRpdHkgY2xpZW50XG4gICAqIEBwYXJhbSBjb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudCBpZGVudGl0eSBwcm92aWRlciBjbGllbnRcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY29nbml0b0lkZW50aXR5Q2xpZW50OiBDb2duaXRvSWRlbnRpdHlDbGllbnQsXG4gICAgcHJpdmF0ZSBjb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudDogQ29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQsXG4gICAgcHJpdmF0ZSB1dWlkR2VuZXJhdG9yOiAoKSA9PiBzdHJpbmdcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBIYW5kbGVzIGN1c3RvbSByZXNvdXJjZSBldmVudHNcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50IHRvIHByb2Nlc3NcbiAgICogQHJldHVybnMgY3VzdG9tIHJlc291cmNlIHJlc3BvbnNlXG4gICAqL1xuICBwdWJsaWMgaGFuZGxlRXZlbnQgPSBhc3luYyAoZXZlbnQ6IENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCkgPT4ge1xuICAgIGNvbnNvbGUuaW5mbyhgUmVjZWl2ZWQgJyR7ZXZlbnQuUmVxdWVzdFR5cGV9JyBldmVudGApO1xuICAgIC8vIHBoeXNpY2FsIGlkIGlzIG9ubHkgZ2VuZXJhdGVkIG9uIGNyZWF0ZSwgb3RoZXJ3aXNlIGl0IG11c3Qgc3RheSB0aGUgc2FtZVxuICAgIGNvbnN0IHBoeXNpY2FsSWQgPVxuICAgICAgZXZlbnQuUmVxdWVzdFR5cGUgPT09ICdDcmVhdGUnXG4gICAgICAgID8gdGhpcy51dWlkR2VuZXJhdG9yKClcbiAgICAgICAgOiBldmVudC5QaHlzaWNhbFJlc291cmNlSWQ7XG5cbiAgICAvLyBvbiBkZWxldGUsIGp1c3QgcmVzcG9uZCB3aXRoIHN1Y2Nlc3Mgc2luY2Ugd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgIGlmIChldmVudC5SZXF1ZXN0VHlwZSA9PT0gJ0RlbGV0ZScpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIFJlcXVlc3RJZDogZXZlbnQuUmVxdWVzdElkLFxuICAgICAgICBMb2dpY2FsUmVzb3VyY2VJZDogZXZlbnQuTG9naWNhbFJlc291cmNlSWQsXG4gICAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogcGh5c2ljYWxJZCxcbiAgICAgICAgU3RhY2tJZDogZXZlbnQuU3RhY2tJZCxcbiAgICAgICAgTm9FY2hvOiB0cnVlLFxuICAgICAgICBTdGF0dXM6ICdTVUNDRVNTJyxcbiAgICAgIH0gYXMgQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVN1Y2Nlc3NSZXNwb25zZTtcbiAgICB9XG4gICAgLy8gZm9yIGNyZWF0ZSBvciB1cGRhdGUgZXZlbnRzLCB3ZSB3aWxsIGZldGNoIGFuZCB2YWxpZGF0ZSByZXNvdXJjZSBwcm9wZXJ0aWVzXG4gICAgY29uc3QgcHJvcHMgPVxuICAgICAgZXZlbnQuUmVzb3VyY2VQcm9wZXJ0aWVzIGFzIHVua25vd24gYXMgUmVmZXJlbmNlQXV0aEluaXRpYWxpemVyUHJvcHM7XG4gICAgY29uc3Qge1xuICAgICAgdXNlclBvb2wsXG4gICAgICB1c2VyUG9vbFBhc3N3b3JkUG9saWN5LFxuICAgICAgdXNlclBvb2xNRkEsXG4gICAgICB1c2VyUG9vbEdyb3VwcyxcbiAgICAgIHVzZXJQb29sUHJvdmlkZXJzLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICBpZGVudGl0eVBvb2wsXG4gICAgICByb2xlcyxcbiAgICB9ID0gYXdhaXQgdGhpcy5nZXRSZXNvdXJjZURldGFpbHMoXG4gICAgICBwcm9wcy51c2VyUG9vbElkLFxuICAgICAgcHJvcHMuaWRlbnRpdHlQb29sSWQsXG4gICAgICBwcm9wcy51c2VyUG9vbENsaWVudElkXG4gICAgKTtcblxuICAgIHRoaXMudmFsaWRhdGVSZXNvdXJjZXMoXG4gICAgICB1c2VyUG9vbCxcbiAgICAgIHVzZXJQb29sUHJvdmlkZXJzLFxuICAgICAgdXNlclBvb2xHcm91cHMsXG4gICAgICB1c2VyUG9vbENsaWVudCxcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIHJvbGVzLFxuICAgICAgcHJvcHNcbiAgICApO1xuXG4gICAgY29uc3QgdXNlclBvb2xPdXRwdXRzID0gYXdhaXQgdGhpcy5nZXRVc2VyUG9vbE91dHB1dHMoXG4gICAgICB1c2VyUG9vbCxcbiAgICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3ksXG4gICAgICB1c2VyUG9vbFByb3ZpZGVycyxcbiAgICAgIHVzZXJQb29sTUZBLFxuICAgICAgcHJvcHMucmVnaW9uXG4gICAgKTtcbiAgICBjb25zdCBpZGVudGl0eVBvb2xPdXRwdXRzID0gYXdhaXQgdGhpcy5nZXRJZGVudGl0eVBvb2xPdXRwdXRzKGlkZW50aXR5UG9vbCk7XG4gICAgY29uc3QgdXNlclBvb2xDbGllbnRPdXRwdXRzID0gYXdhaXQgdGhpcy5nZXRVc2VyUG9vbENsaWVudE91dHB1dHMoXG4gICAgICB1c2VyUG9vbENsaWVudFxuICAgICk7XG4gICAgY29uc3QgZGF0YTogT21pdDxBdXRoT3V0cHV0WydwYXlsb2FkJ10sICdhdXRoUmVnaW9uJz4gPSB7XG4gICAgICB1c2VyUG9vbElkOiBwcm9wcy51c2VyUG9vbElkLFxuICAgICAgd2ViQ2xpZW50SWQ6IHByb3BzLnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICBpZGVudGl0eVBvb2xJZDogcHJvcHMuaWRlbnRpdHlQb29sSWQsXG4gICAgICAuLi51c2VyUG9vbE91dHB1dHMsXG4gICAgICAuLi5pZGVudGl0eVBvb2xPdXRwdXRzLFxuICAgICAgLi4udXNlclBvb2xDbGllbnRPdXRwdXRzLFxuICAgIH07XG4gICAgcmV0dXJuIHtcbiAgICAgIFJlcXVlc3RJZDogZXZlbnQuUmVxdWVzdElkLFxuICAgICAgTG9naWNhbFJlc291cmNlSWQ6IGV2ZW50LkxvZ2ljYWxSZXNvdXJjZUlkLFxuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBwaHlzaWNhbElkLFxuICAgICAgU3RhY2tJZDogZXZlbnQuU3RhY2tJZCxcbiAgICAgIE5vRWNobzogdHJ1ZSxcbiAgICAgIERhdGE6IGRhdGEsXG4gICAgICBTdGF0dXM6ICdTVUNDRVNTJyxcbiAgICB9IGFzIENsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VTdWNjZXNzUmVzcG9uc2U7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbCA9IGFzeW5jICh1c2VyUG9vbElkOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCB1c2VyUG9vbENvbW1hbmQgPSBuZXcgRGVzY3JpYmVVc2VyUG9vbENvbW1hbmQoe1xuICAgICAgVXNlclBvb2xJZDogdXNlclBvb2xJZCxcbiAgICB9KTtcbiAgICBjb25zdCB1c2VyUG9vbFJlc3BvbnNlID0gYXdhaXQgdGhpcy5jb2duaXRvSWRlbnRpdHlQcm92aWRlckNsaWVudC5zZW5kKFxuICAgICAgdXNlclBvb2xDb21tYW5kXG4gICAgKTtcbiAgICBpZiAoIXVzZXJQb29sUmVzcG9uc2UuVXNlclBvb2wpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIHRoZSBzcGVjaWZpZWQgVXNlclBvb2wuJyk7XG4gICAgfVxuICAgIGNvbnN0IHVzZXJQb29sID0gdXNlclBvb2xSZXNwb25zZS5Vc2VyUG9vbDtcbiAgICBjb25zdCBwb2xpY3kgPSB1c2VyUG9vbC5Qb2xpY2llcz8uUGFzc3dvcmRQb2xpY3k7XG4gICAgaWYgKCFwb2xpY3kpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIHBhc3N3b3JkIHBvbGljeS4nKTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXJQb29sOiB1c2VyUG9vbFJlc3BvbnNlLlVzZXJQb29sLFxuICAgICAgdXNlclBvb2xQYXNzd29yZFBvbGljeTogcG9saWN5LFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbE1GQVNldHRpbmdzID0gYXN5bmMgKHVzZXJQb29sSWQ6IHN0cmluZykgPT4ge1xuICAgIC8vIG1mYSB0eXBlc1xuICAgIGNvbnN0IG1mYUNvbW1hbmQgPSBuZXcgR2V0VXNlclBvb2xNZmFDb25maWdDb21tYW5kKHtcbiAgICAgIFVzZXJQb29sSWQ6IHVzZXJQb29sSWQsXG4gICAgfSk7XG4gICAgY29uc3QgbWZhUmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50LnNlbmQoXG4gICAgICBtZmFDb21tYW5kXG4gICAgKTtcbiAgICByZXR1cm4gbWZhUmVzcG9uc2U7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbEdyb3VwcyA9IGFzeW5jICh1c2VyUG9vbElkOiBzdHJpbmcpID0+IHtcbiAgICBsZXQgbmV4dFRva2VuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgY29uc3QgZ3JvdXBzOiBHcm91cFR5cGVbXSA9IFtdO1xuICAgIGRvIHtcbiAgICAgIGNvbnN0IGxpc3RHcm91cHNSZXNwb25zZSA9IGF3YWl0IHRoaXMuY29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQuc2VuZChcbiAgICAgICAgbmV3IExpc3RHcm91cHNDb21tYW5kKHtcbiAgICAgICAgICBVc2VyUG9vbElkOiB1c2VyUG9vbElkLFxuICAgICAgICAgIE5leHRUb2tlbjogbmV4dFRva2VuLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICAgIGlmICghbGlzdEdyb3Vwc1Jlc3BvbnNlLkdyb3Vwcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgdGhlIGdyb3VwcyBmb3IgdGhlIHVzZXIgcG9vbC4nXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBncm91cHMucHVzaCguLi5saXN0R3JvdXBzUmVzcG9uc2UuR3JvdXBzKTtcbiAgICAgIG5leHRUb2tlbiA9IGxpc3RHcm91cHNSZXNwb25zZS5OZXh0VG9rZW47XG4gICAgfSB3aGlsZSAobmV4dFRva2VuKTtcbiAgICByZXR1cm4gZ3JvdXBzO1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0VXNlclBvb2xQcm92aWRlcnMgPSBhc3luYyAodXNlclBvb2xJZDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgcHJvdmlkZXJzOiBQcm92aWRlckRlc2NyaXB0aW9uW10gPSBbXTtcbiAgICBsZXQgbmV4dFRva2VuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgZG8ge1xuICAgICAgY29uc3QgcHJvdmlkZXJzUmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBMaXN0SWRlbnRpdHlQcm92aWRlcnNDb21tYW5kKHtcbiAgICAgICAgICBVc2VyUG9vbElkOiB1c2VyUG9vbElkLFxuICAgICAgICAgIE5leHRUb2tlbjogbmV4dFRva2VuLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICAgIGlmIChwcm92aWRlcnNSZXNwb25zZS5Qcm92aWRlcnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgaWRlbnRpdHkgcHJvdmlkZXJzIGZvciB0aGUgdXNlciBwb29sLidcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHByb3ZpZGVycy5wdXNoKC4uLnByb3ZpZGVyc1Jlc3BvbnNlLlByb3ZpZGVycyk7XG4gICAgICBuZXh0VG9rZW4gPSBwcm92aWRlcnNSZXNwb25zZS5OZXh0VG9rZW47XG4gICAgfSB3aGlsZSAobmV4dFRva2VuKTtcbiAgICByZXR1cm4gcHJvdmlkZXJzO1xuICB9O1xuXG4gIHByaXZhdGUgZ2V0SWRlbnRpdHlQb29sID0gYXN5bmMgKGlkZW50aXR5UG9vbElkOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBpZHBSZXNwb25zZSA9IGF3YWl0IHRoaXMuY29nbml0b0lkZW50aXR5Q2xpZW50LnNlbmQoXG4gICAgICBuZXcgRGVzY3JpYmVJZGVudGl0eVBvb2xDb21tYW5kKHtcbiAgICAgICAgSWRlbnRpdHlQb29sSWQ6IGlkZW50aXR5UG9vbElkLFxuICAgICAgfSlcbiAgICApO1xuICAgIGlmICghaWRwUmVzcG9uc2UuSWRlbnRpdHlQb29sSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgdGhlIGlkZW50aXR5IHBvb2wgZGV0YWlscy4nXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gaWRwUmVzcG9uc2U7XG4gIH07XG5cbiAgcHJpdmF0ZSBnZXRJZGVudGl0eVBvb2xSb2xlcyA9IGFzeW5jIChpZGVudGl0eVBvb2xJZDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3Qgcm9sZXNDb21tYW5kID0gbmV3IEdldElkZW50aXR5UG9vbFJvbGVzQ29tbWFuZCh7XG4gICAgICBJZGVudGl0eVBvb2xJZDogaWRlbnRpdHlQb29sSWQsXG4gICAgfSk7XG4gICAgY29uc3Qgcm9sZXNSZXNwb25zZSA9IGF3YWl0IHRoaXMuY29nbml0b0lkZW50aXR5Q2xpZW50LnNlbmQocm9sZXNDb21tYW5kKTtcbiAgICBpZiAoIXJvbGVzUmVzcG9uc2UuUm9sZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgdGhlIHJvbGVzIGZvciB0aGUgaWRlbnRpdHkgcG9vbC4nXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gcm9sZXNSZXNwb25zZS5Sb2xlcztcbiAgfTtcblxuICBwcml2YXRlIGdldFVzZXJQb29sQ2xpZW50ID0gYXN5bmMgKFxuICAgIHVzZXJQb29sSWQ6IHN0cmluZyxcbiAgICB1c2VyUG9vbENsaWVudElkOiBzdHJpbmdcbiAgKSA9PiB7XG4gICAgY29uc3QgdXNlclBvb2xDbGllbnRDb21tYW5kID0gbmV3IERlc2NyaWJlVXNlclBvb2xDbGllbnRDb21tYW5kKHtcbiAgICAgIFVzZXJQb29sSWQ6IHVzZXJQb29sSWQsXG4gICAgICBDbGllbnRJZDogdXNlclBvb2xDbGllbnRJZCxcbiAgICB9KTtcbiAgICBjb25zdCB1c2VyUG9vbENsaWVudFJlc3BvbnNlID1cbiAgICAgIGF3YWl0IHRoaXMuY29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQuc2VuZCh1c2VyUG9vbENsaWVudENvbW1hbmQpO1xuICAgIGlmICghdXNlclBvb2xDbGllbnRSZXNwb25zZS5Vc2VyUG9vbENsaWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQW4gZXJyb3Igb2NjdXJyZWQgd2hpbGUgcmV0cmlldmluZyB0aGUgdXNlciBwb29sIGNsaWVudCBkZXRhaWxzLidcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB1c2VyUG9vbENsaWVudFJlc3BvbnNlLlVzZXJQb29sQ2xpZW50O1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgYWxsIG9mIHRoZSByZXNvdXJjZSBkYXRhIHRoYXQgaXMgbmVjZXNzYXJ5IGZvciB2YWxpZGF0aW9uIGFuZCBvdXRwdXQgZ2VuZXJhdGlvbi5cbiAgICogQHBhcmFtIHVzZXJQb29sSWQgdXNlclBvb2xJZFxuICAgKiBAcGFyYW0gaWRlbnRpdHlQb29sSWQgaWRlbnRpdHlQb29sSWRcbiAgICogQHBhcmFtIHVzZXJQb29sQ2xpZW50SWQgdXNlclBvb2xDbGllbnRJZFxuICAgKiBAcmV0dXJucyBhbGwgbmVjZXNzYXJ5IHJlc291cmNlIGRhdGFcbiAgICovXG4gIHByaXZhdGUgZ2V0UmVzb3VyY2VEZXRhaWxzID0gYXN5bmMgKFxuICAgIHVzZXJQb29sSWQ6IHN0cmluZyxcbiAgICBpZGVudGl0eVBvb2xJZDogc3RyaW5nLFxuICAgIHVzZXJQb29sQ2xpZW50SWQ6IHN0cmluZ1xuICApID0+IHtcbiAgICBjb25zdCB7IHVzZXJQb29sLCB1c2VyUG9vbFBhc3N3b3JkUG9saWN5IH0gPSBhd2FpdCB0aGlzLmdldFVzZXJQb29sKFxuICAgICAgdXNlclBvb2xJZFxuICAgICk7XG4gICAgY29uc3QgdXNlclBvb2xNRkEgPSBhd2FpdCB0aGlzLmdldFVzZXJQb29sTUZBU2V0dGluZ3ModXNlclBvb2xJZCk7XG4gICAgY29uc3QgdXNlclBvb2xQcm92aWRlcnMgPSBhd2FpdCB0aGlzLmdldFVzZXJQb29sUHJvdmlkZXJzKHVzZXJQb29sSWQpO1xuICAgIGNvbnN0IHVzZXJQb29sR3JvdXBzID0gYXdhaXQgdGhpcy5nZXRVc2VyUG9vbEdyb3Vwcyh1c2VyUG9vbElkKTtcbiAgICBjb25zdCB1c2VyUG9vbENsaWVudCA9IGF3YWl0IHRoaXMuZ2V0VXNlclBvb2xDbGllbnQoXG4gICAgICB1c2VyUG9vbElkLFxuICAgICAgdXNlclBvb2xDbGllbnRJZFxuICAgICk7XG4gICAgY29uc3QgaWRlbnRpdHlQb29sID0gYXdhaXQgdGhpcy5nZXRJZGVudGl0eVBvb2woaWRlbnRpdHlQb29sSWQpO1xuICAgIGNvbnN0IHJvbGVzID0gYXdhaXQgdGhpcy5nZXRJZGVudGl0eVBvb2xSb2xlcyhpZGVudGl0eVBvb2xJZCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXJQb29sLFxuICAgICAgdXNlclBvb2xQYXNzd29yZFBvbGljeSxcbiAgICAgIHVzZXJQb29sTUZBLFxuICAgICAgdXNlclBvb2xQcm92aWRlcnMsXG4gICAgICB1c2VyUG9vbEdyb3VwcyxcbiAgICAgIHVzZXJQb29sQ2xpZW50LFxuICAgICAgaWRlbnRpdHlQb29sLFxuICAgICAgcm9sZXMsXG4gICAgfTtcbiAgfTtcblxuICAvKipcbiAgICogVmFsaWRhdGUgdGhlIHJlc291cmNlIGFzc29jaWF0aW9ucy5cbiAgICogMS4gbWFrZSBzdXJlIHRoZSB1c2VyIHBvb2wgJiB1c2VyIHBvb2wgY2xpZW50IHBhaXIgYXJlIGEgY29nbml0byBwcm92aWRlciBmb3IgdGhlIGlkZW50aXR5IHBvb2xcbiAgICogMi4gbWFrZSBzdXJlIHRoZSBwcm92aWRlZCBhdXRoL3VuYXV0aCByb2xlIEFSTnMgbWF0Y2ggdGhlIHJvbGVzIGZvciB0aGUgaWRlbnRpdHkgcG9vbFxuICAgKiAzLiBtYWtlIHN1cmUgdGhlIHVzZXIgcG9vbCBjbGllbnQgaXMgYSB3ZWIgY2xpZW50XG4gICAqIEBwYXJhbSB1c2VyUG9vbCB1c2VyUG9vbFxuICAgKiBAcGFyYW0gdXNlclBvb2xQcm92aWRlcnMgdGhlIHVzZXIgcG9vbCBwcm92aWRlcnNcbiAgICogQHBhcmFtIHVzZXJQb29sR3JvdXBzIHRoZSBleGlzdGluZyBncm91cHMgZm9yIHRoZSB1c2VyUG9vbFxuICAgKiBAcGFyYW0gdXNlclBvb2xDbGllbnQgdXNlclBvb2xDbGllbnRcbiAgICogQHBhcmFtIGlkZW50aXR5UG9vbCBpZGVudGl0eVBvb2xcbiAgICogQHBhcmFtIGlkZW50aXR5UG9vbFJvbGVzIGlkZW50aXR5UG9vbCByb2xlc1xuICAgKiBAcGFyYW0gcHJvcHMgcHJvcHMgdGhhdCBpbmNsdWRlIHRoZSByb2xlcyB3aGljaCB3ZSBjb21wYXJlIHdpdGggdGhlIGFjdHVhbCByb2xlcyBmb3IgdGhlIGlkZW50aXR5IHBvb2xcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVSZXNvdXJjZXMgPSAoXG4gICAgdXNlclBvb2w6IFVzZXJQb29sVHlwZSxcbiAgICB1c2VyUG9vbFByb3ZpZGVyczogUHJvdmlkZXJEZXNjcmlwdGlvbltdLFxuICAgIHVzZXJQb29sR3JvdXBzOiBHcm91cFR5cGVbXSxcbiAgICB1c2VyUG9vbENsaWVudDogVXNlclBvb2xDbGllbnRUeXBlLFxuICAgIGlkZW50aXR5UG9vbDogRGVzY3JpYmVJZGVudGl0eVBvb2xDb21tYW5kT3V0cHV0LFxuICAgIGlkZW50aXR5UG9vbFJvbGVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICAgIHByb3BzOiBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXJQcm9wc1xuICApID0+IHtcbiAgICAvLyB2ZXJpZnkgdGhlIHVzZXIgcG9vbCBpcyBhIGNvZ25pdG8gcHJvdmlkZXIgZm9yIHRoaXMgaWRlbnRpdHkgcG9vbFxuICAgIGlmIChcbiAgICAgICFpZGVudGl0eVBvb2wuQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIHx8XG4gICAgICBpZGVudGl0eVBvb2wuQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzLmxlbmd0aCA9PT0gMFxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnVGhlIHNwZWNpZmllZCBpZGVudGl0eSBwb29sIGRvZXMgbm90IGhhdmUgYW55IGNvZ25pdG8gaWRlbnRpdHkgcHJvdmlkZXJzLidcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIGNoZWNrIGZvciBhbGlhcyBhdHRyaWJ1dGVzLCBzaW5jZSB3ZSBkb24ndCBzdXBwb3J0IHRoaXMgeWV0XG4gICAgaWYgKHVzZXJQb29sLkFsaWFzQXR0cmlidXRlcyAmJiB1c2VyUG9vbC5BbGlhc0F0dHJpYnV0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnVGhlIHNwZWNpZmllZCB1c2VyIHBvb2wgaXMgY29uZmlndXJlZCB3aXRoIGFsaWFzIGF0dHJpYnV0ZXMgd2hpY2ggYXJlIG5vdCBjdXJyZW50bHkgc3VwcG9ydGVkLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgT0F1dGggc2V0dGluZ3NcbiAgICBpZiAodXNlclBvb2xQcm92aWRlcnMubGVuZ3RoID4gMCkge1xuICAgICAgLy8gdmFsaWRhdGUgdXNlciBwb29sXG4gICAgICBjb25zdCBkb21haW5TcGVjaWZpZWQgPSB1c2VyUG9vbC5Eb21haW4gfHwgdXNlclBvb2wuQ3VzdG9tRG9tYWluO1xuICAgICAgaWYgKCFkb21haW5TcGVjaWZpZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdZb3UgbXVzdCBjb25maWd1cmUgYSBkb21haW4gZm9yIHlvdXIgVXNlclBvb2wgaWYgZXh0ZXJuYWwgbG9naW4gcHJvdmlkZXJzIGFyZSBlbmFibGVkLidcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gdmFsaWRhdGUgdXNlciBwb29sIGNsaWVudFxuICAgICAgY29uc3QgaGFzTG9nb3V0VXJscyA9XG4gICAgICAgIHVzZXJQb29sQ2xpZW50LkxvZ291dFVSTHMgJiYgdXNlclBvb2xDbGllbnQuTG9nb3V0VVJMcy5sZW5ndGggPiAwO1xuICAgICAgY29uc3QgaGFzQ2FsbGJhY2tVcmxzID1cbiAgICAgICAgdXNlclBvb2xDbGllbnQuQ2FsbGJhY2tVUkxzICYmIHVzZXJQb29sQ2xpZW50LkNhbGxiYWNrVVJMcy5sZW5ndGggPiAwO1xuICAgICAgaWYgKCFoYXNMb2dvdXRVcmxzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnWW91ciBVc2VyUG9vbCBjbGllbnQgbXVzdCBoYXZlIFwiQWxsb3dlZCBzaWduLW91dCBVUkxzXCIgY29uZmlndXJlZCBpZiBleHRlcm5hbCBsb2dpbiBwcm92aWRlcnMgYXJlIGVuYWJsZWQuJ1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKCFoYXNDYWxsYmFja1VybHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdZb3VyIFVzZXJQb29sIGNsaWVudCBtdXN0IGhhdmUgXCJBbGxvd2VkIGNhbGxiYWNrIFVSTHNcIiBjb25maWd1cmVkIGlmIGV4dGVybmFsIGxvZ2luIHByb3ZpZGVycyBhcmUgZW5hYmxlZC4nXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gbWFrZSBzdXJlIHByb3BzIGdyb3VwcyBSb2xlcyBhY3R1YWxseSBleGlzdCBmb3IgdGhlIHVzZXIgcG9vbFxuICAgIGNvbnN0IGdyb3VwRW50cmllcyA9IE9iamVjdC5lbnRyaWVzKHByb3BzLmdyb3Vwcyk7XG4gICAgZm9yIChjb25zdCBbZ3JvdXBOYW1lLCBncm91cFJvbGVBUk5dIG9mIGdyb3VwRW50cmllcykge1xuICAgICAgY29uc3QgbWF0Y2ggPSB1c2VyUG9vbEdyb3Vwcy5maW5kKChnKSA9PiBnLlJvbGVBcm4gPT09IGdyb3VwUm9sZUFSTik7XG4gICAgICBpZiAobWF0Y2ggPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFRoZSBncm91cCAnJHtncm91cE5hbWV9JyB3aXRoIHJvbGUgJyR7Z3JvdXBSb2xlQVJOfScgZG9lcyBub3QgbWF0Y2ggYW55IGdyb3VwIGZvciB0aGUgc3BlY2lmaWVkIHVzZXIgcG9vbC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIHZlcmlmeSB0aGF0IHRoZSB1c2VyIHBvb2wgKyB1c2VyIHBvb2wgY2xpZW50IHBhaXIgYXJlIGNvbmZpZ3VyZWQgd2l0aCB0aGUgaWRlbnRpdHkgcG9vbFxuICAgIGNvbnN0IG1hdGNoaW5nUHJvdmlkZXIgPSBpZGVudGl0eVBvb2wuQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzLmZpbmQoKHApID0+IHtcbiAgICAgIGNvbnN0IG1hdGNoaW5nVXNlclBvb2w6IGJvb2xlYW4gPVxuICAgICAgICBwLlByb3ZpZGVyTmFtZSA9PT1cbiAgICAgICAgYGNvZ25pdG8taWRwLiR7cHJvcHMucmVnaW9ufS5hbWF6b25hd3MuY29tLyR7dXNlclBvb2wuSWR9YDtcbiAgICAgIGNvbnN0IG1hdGNoaW5nVXNlclBvb2xDbGllbnQ6IGJvb2xlYW4gPVxuICAgICAgICBwLkNsaWVudElkID09PSB1c2VyUG9vbENsaWVudC5DbGllbnRJZDtcbiAgICAgIHJldHVybiBtYXRjaGluZ1VzZXJQb29sICYmIG1hdGNoaW5nVXNlclBvb2xDbGllbnQ7XG4gICAgfSk7XG4gICAgaWYgKCFtYXRjaGluZ1Byb3ZpZGVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdUaGUgdXNlciBwb29sIGFuZCB1c2VyIHBvb2wgY2xpZW50IHBhaXIgZG8gbm90IG1hdGNoIGFueSBjb2duaXRvIGlkZW50aXR5IHByb3ZpZGVycyBmb3IgdGhlIHNwZWNpZmllZCBpZGVudGl0eSBwb29sLidcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIHZlcmlmeSB0aGUgYXV0aCAvIHVuYXV0aCByb2xlcyBmcm9tIHRoZSBwcm9wcyBtYXRjaCB0aGUgaWRlbnRpdHkgcG9vbCByb2xlcyB0aGF0IHdlIHJldHJpZXZlZFxuICAgIGNvbnN0IGF1dGhSb2xlQXJuID0gaWRlbnRpdHlQb29sUm9sZXNbJ2F1dGhlbnRpY2F0ZWQnXTtcbiAgICBjb25zdCB1bmF1dGhSb2xlQXJuID0gaWRlbnRpdHlQb29sUm9sZXNbJ3VuYXV0aGVudGljYXRlZCddO1xuICAgIGlmIChhdXRoUm9sZUFybiAhPT0gcHJvcHMuYXV0aFJvbGVBcm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1RoZSBwcm92aWRlZCBhdXRoUm9sZUFybiBkb2VzIG5vdCBtYXRjaCB0aGUgYXV0aGVudGljYXRlZCByb2xlIGZvciB0aGUgc3BlY2lmaWVkIGlkZW50aXR5IHBvb2wuJ1xuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHVuYXV0aFJvbGVBcm4gIT09IHByb3BzLnVuYXV0aFJvbGVBcm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1RoZSBwcm92aWRlZCB1bmF1dGhSb2xlQXJuIGRvZXMgbm90IG1hdGNoIHRoZSB1bmF1dGhlbnRpY2F0ZWQgcm9sZSBmb3IgdGhlIHNwZWNpZmllZCBpZGVudGl0eSBwb29sLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gbWFrZSBzdXJlIHRoZSBjbGllbnQgaXMgYSB3ZWIgY2xpZW50IGhlcmUgKHdlYiBjbGllbnRzIHNob3VsZG4ndCBoYXZlIGNsaWVudCBzZWNyZXRzKVxuICAgIGlmICh1c2VyUG9vbENsaWVudD8uQ2xpZW50U2VjcmV0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdUaGUgc3BlY2lmaWVkIHVzZXIgcG9vbCBjbGllbnQgaXMgbm90IGNvbmZpZ3VyZWQgYXMgYSB3ZWIgY2xpZW50LidcbiAgICAgICk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBUcmFuc2Zvcm0gdGhlIHVzZXJQb29sIGRhdGEgaW50byBvdXRwdXRzLlxuICAgKiBAcGFyYW0gdXNlclBvb2wgdXNlciBwb29sXG4gICAqIEBwYXJhbSB1c2VyUG9vbFBhc3N3b3JkUG9saWN5IHVzZXIgcG9vbCBwYXNzd29yZCBwb2xpY3lcbiAgICogQHBhcmFtIHVzZXJQb29sUHJvdmlkZXJzIHVzZXIgcG9vbCBwcm92aWRlcnNcbiAgICogQHBhcmFtIHVzZXJQb29sTUZBIHVzZXIgcG9vbCBNRkEgc2V0dGluZ3NcbiAgICogQHJldHVybnMgZm9ybWF0dGVkIG91dHB1dHNcbiAgICovXG4gIHByaXZhdGUgZ2V0VXNlclBvb2xPdXRwdXRzID0gKFxuICAgIHVzZXJQb29sOiBVc2VyUG9vbFR5cGUsXG4gICAgdXNlclBvb2xQYXNzd29yZFBvbGljeTogUGFzc3dvcmRQb2xpY3lUeXBlLFxuICAgIHVzZXJQb29sUHJvdmlkZXJzOiBQcm92aWRlckRlc2NyaXB0aW9uW10sXG4gICAgdXNlclBvb2xNRkE6IEdldFVzZXJQb29sTWZhQ29uZmlnQ29tbWFuZE91dHB1dCxcbiAgICByZWdpb246IHN0cmluZ1xuICApID0+IHtcbiAgICAvLyBwYXNzd29yZCBwb2xpY3kgcmVxdWlyZW1lbnRzXG4gICAgY29uc3QgcmVxdWlyZW1lbnRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3kuUmVxdWlyZU51bWJlcnMgJiZcbiAgICAgIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19OVU1CRVJTJyk7XG4gICAgdXNlclBvb2xQYXNzd29yZFBvbGljeS5SZXF1aXJlTG93ZXJjYXNlICYmXG4gICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfTE9XRVJDQVNFJyk7XG4gICAgdXNlclBvb2xQYXNzd29yZFBvbGljeS5SZXF1aXJlVXBwZXJjYXNlICYmXG4gICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfVVBQRVJDQVNFJyk7XG4gICAgdXNlclBvb2xQYXNzd29yZFBvbGljeS5SZXF1aXJlU3ltYm9scyAmJlxuICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1NZTUJPTFMnKTtcbiAgICAvLyBtZmEgdHlwZXNcbiAgICBjb25zdCBtZmFUeXBlczogc3RyaW5nW10gPSBbXTtcbiAgICBpZiAoXG4gICAgICB1c2VyUG9vbE1GQS5TbXNNZmFDb25maWd1cmF0aW9uICYmXG4gICAgICB1c2VyUG9vbE1GQS5TbXNNZmFDb25maWd1cmF0aW9uLlNtc0NvbmZpZ3VyYXRpb25cbiAgICApIHtcbiAgICAgIG1mYVR5cGVzLnB1c2goJ1NNU19NRkEnKTtcbiAgICB9XG4gICAgaWYgKHVzZXJQb29sTUZBLlNvZnR3YXJlVG9rZW5NZmFDb25maWd1cmF0aW9uPy5FbmFibGVkKSB7XG4gICAgICBtZmFUeXBlcy5wdXNoKCdUT1RQJyk7XG4gICAgfVxuICAgIC8vIHNvY2lhbCBwcm92aWRlcnNcbiAgICBjb25zdCBzb2NpYWxQcm92aWRlcnM6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHVzZXJQb29sUHJvdmlkZXJzKSB7XG4gICAgICBmb3IgKGNvbnN0IHByb3ZpZGVyIG9mIHVzZXJQb29sUHJvdmlkZXJzKSB7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyVHlwZSA9IHByb3ZpZGVyLlByb3ZpZGVyVHlwZTtcbiAgICAgICAgY29uc3QgcHJvdmlkZXJOYW1lID0gcHJvdmlkZXIuUHJvdmlkZXJOYW1lO1xuICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnR29vZ2xlJykge1xuICAgICAgICAgIHNvY2lhbFByb3ZpZGVycy5wdXNoKCdHT09HTEUnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnRmFjZWJvb2snKSB7XG4gICAgICAgICAgc29jaWFsUHJvdmlkZXJzLnB1c2goJ0ZBQ0VCT09LJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ1NpZ25JbldpdGhBcHBsZScpIHtcbiAgICAgICAgICBzb2NpYWxQcm92aWRlcnMucHVzaCgnU0lHTl9JTl9XSVRIX0FQUExFJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ0xvZ2luV2l0aEFtYXpvbicpIHtcbiAgICAgICAgICBzb2NpYWxQcm92aWRlcnMucHVzaCgnTE9HSU5fV0lUSF9BTUFaT04nKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnT0lEQycgJiYgcHJvdmlkZXJOYW1lKSB7XG4gICAgICAgICAgc29jaWFsUHJvdmlkZXJzLnB1c2gocHJvdmlkZXJOYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnU0FNTCcgJiYgcHJvdmlkZXJOYW1lKSB7XG4gICAgICAgICAgc29jaWFsUHJvdmlkZXJzLnB1c2gocHJvdmlkZXJOYW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGRvbWFpblxuICAgIGNvbnN0IG9hdXRoRG9tYWluID0gdXNlclBvb2wuQ3VzdG9tRG9tYWluID8/IHVzZXJQb29sLkRvbWFpbiA/PyAnJztcbiAgICBjb25zdCBmdWxsRG9tYWluUGF0aCA9IGAke29hdXRoRG9tYWlufS5hdXRoLiR7cmVnaW9ufS5hbWF6b25jb2duaXRvLmNvbWA7XG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIHNpZ251cEF0dHJpYnV0ZXM6IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICB1c2VyUG9vbC5TY2hlbWFBdHRyaWJ1dGVzPy5maWx0ZXIoXG4gICAgICAgICAgKGF0dHJpYnV0ZSkgPT4gYXR0cmlidXRlLlJlcXVpcmVkICYmIGF0dHJpYnV0ZS5OYW1lXG4gICAgICAgICkubWFwKChhdHRyaWJ1dGUpID0+IGF0dHJpYnV0ZS5OYW1lPy50b0xvd2VyQ2FzZSgpKSB8fCBbXVxuICAgICAgKSxcbiAgICAgIHVzZXJuYW1lQXR0cmlidXRlczogSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgIHVzZXJQb29sLlVzZXJuYW1lQXR0cmlidXRlcz8ubWFwKChhdHRyaWJ1dGUpID0+XG4gICAgICAgICAgYXR0cmlidXRlLnRvTG93ZXJDYXNlKClcbiAgICAgICAgKSB8fCBbXVxuICAgICAgKSxcbiAgICAgIHZlcmlmaWNhdGlvbk1lY2hhbmlzbXM6IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICB1c2VyUG9vbC5BdXRvVmVyaWZpZWRBdHRyaWJ1dGVzID8/IFtdXG4gICAgICApLFxuICAgICAgcGFzc3dvcmRQb2xpY3lNaW5MZW5ndGg6XG4gICAgICAgIHVzZXJQb29sUGFzc3dvcmRQb2xpY3kuTWluaW11bUxlbmd0aCA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgPyAnJ1xuICAgICAgICAgIDogdXNlclBvb2xQYXNzd29yZFBvbGljeS5NaW5pbXVtTGVuZ3RoLnRvU3RyaW5nKCksXG4gICAgICBwYXNzd29yZFBvbGljeVJlcXVpcmVtZW50czogSlNPTi5zdHJpbmdpZnkocmVxdWlyZW1lbnRzKSxcbiAgICAgIG1mYUNvbmZpZ3VyYXRpb246IHVzZXJQb29sLk1mYUNvbmZpZ3VyYXRpb24gPz8gJ09GRicsXG4gICAgICBtZmFUeXBlczogSlNPTi5zdHJpbmdpZnkobWZhVHlwZXMpLFxuICAgICAgc29jaWFsUHJvdmlkZXJzOiBKU09OLnN0cmluZ2lmeShzb2NpYWxQcm92aWRlcnMpLFxuICAgICAgb2F1dGhDb2duaXRvRG9tYWluOiBmdWxsRG9tYWluUGF0aCxcbiAgICB9O1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIC8qKlxuICAgKiBUcmFuc2Zvcm1zIGlkZW50aXR5UG9vbCBpbmZvIGludG8gb3V0cHV0cy5cbiAgICogQHBhcmFtIGlkZW50aXR5UG9vbCBpZGVudGl0eSBwb29sIGRhdGFcbiAgICogQHJldHVybnMgZm9ybWF0dGVkIG91dHB1dHNcbiAgICovXG4gIHByaXZhdGUgZ2V0SWRlbnRpdHlQb29sT3V0cHV0cyA9IChcbiAgICBpZGVudGl0eVBvb2w6IERlc2NyaWJlSWRlbnRpdHlQb29sQ29tbWFuZE91dHB1dFxuICApID0+IHtcbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOlxuICAgICAgICBpZGVudGl0eVBvb2wuQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzID09PSB0cnVlID8gJ3RydWUnIDogJ2ZhbHNlJyxcbiAgICB9O1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIC8qKlxuICAgKiBUcmFuc2Zvcm1zIHVzZXJQb29sQ2xpZW50IGluZm8gaW50byBvdXRwdXRzLlxuICAgKiBAcGFyYW0gdXNlclBvb2xDbGllbnQgdXNlclBvb2xDbGllbnQgZGF0YVxuICAgKiBAcmV0dXJucyBmb3JtYXR0ZWQgb3V0cHV0c1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbENsaWVudE91dHB1dHMgPSAodXNlclBvb2xDbGllbnQ6IFVzZXJQb29sQ2xpZW50VHlwZSkgPT4ge1xuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICBvYXV0aFNjb3BlOiBKU09OLnN0cmluZ2lmeSh1c2VyUG9vbENsaWVudC5BbGxvd2VkT0F1dGhTY29wZXMgPz8gW10pLFxuICAgICAgb2F1dGhSZWRpcmVjdFNpZ25JbjogdXNlclBvb2xDbGllbnQuQ2FsbGJhY2tVUkxzXG4gICAgICAgID8gdXNlclBvb2xDbGllbnQuQ2FsbGJhY2tVUkxzLmpvaW4oJywnKVxuICAgICAgICA6ICcnLFxuICAgICAgb2F1dGhSZWRpcmVjdFNpZ25PdXQ6IHVzZXJQb29sQ2xpZW50LkxvZ291dFVSTHNcbiAgICAgICAgPyB1c2VyUG9vbENsaWVudC5Mb2dvdXRVUkxzLmpvaW4oJywnKVxuICAgICAgICA6ICcnLFxuICAgICAgb2F1dGhSZXNwb25zZVR5cGU6IHVzZXJQb29sQ2xpZW50LkFsbG93ZWRPQXV0aEZsb3dzXG4gICAgICAgID8gdXNlclBvb2xDbGllbnQuQWxsb3dlZE9BdXRoRmxvd3Muam9pbignLCcpXG4gICAgICAgIDogJycsXG4gICAgICBvYXV0aENsaWVudElkOiB1c2VyUG9vbENsaWVudC5DbGllbnRJZCxcbiAgICB9O1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xufVxuXG4vKipcbiAqIEVudHJ5IHBvaW50IGZvciB0aGUgbGFtYmRhLWJhY2tlbmQgY3VzdG9tIHJlc291cmNlIHRvIHJldHJpZXZlIGF1dGggb3V0cHV0cy5cbiAqL1xuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBDbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnRcbik6IFByb21pc2U8Q2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVJlc3BvbnNlPiA9PiB7XG4gIGNvbnN0IGluaXRpYWxpemVyID0gbmV3IFJlZmVyZW5jZUF1dGhJbml0aWFsaXplcihcbiAgICBuZXcgQ29nbml0b0lkZW50aXR5Q2xpZW50KCksXG4gICAgbmV3IENvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50KCksXG4gICAgcmFuZG9tVVVJRFxuICApO1xuICByZXR1cm4gaW5pdGlhbGl6ZXIuaGFuZGxlRXZlbnQoZXZlbnQpO1xufTtcbiJdfQ==