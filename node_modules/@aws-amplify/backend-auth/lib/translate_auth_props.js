/**
 * Translate an Auth factory's loginWith to its Auth construct counterpart. Backend secret fields will be resolved
 * to an CFN token and map to the required construct type. Note that not all construct secret fields are of sdk
 * SecretValue type, many are (wrongly) of type string as well.
 */
export const translateToAuthConstructLoginWith = (authFactoryLoginWith, backendSecretResolver) => {
    const result = authFactoryLoginWith;
    if (!authFactoryLoginWith.externalProviders) {
        return result;
    }
    const externalProviders = authFactoryLoginWith.externalProviders;
    result.externalProviders = {
        ...externalProviders,
    };
    const amazonProps = translateAmazonProps(backendSecretResolver, externalProviders.loginWithAmazon);
    if (amazonProps) {
        result.externalProviders.loginWithAmazon = amazonProps;
    }
    const appleProps = translateAppleProps(backendSecretResolver, externalProviders.signInWithApple);
    if (appleProps) {
        result.externalProviders.signInWithApple = appleProps;
    }
    const facebookProps = translateFacebookProps(backendSecretResolver, externalProviders.facebook);
    if (facebookProps) {
        result.externalProviders.facebook = facebookProps;
    }
    const oidcProps = translateOidcProps(backendSecretResolver, externalProviders.oidc);
    if (oidcProps) {
        result.externalProviders.oidc = oidcProps;
    }
    const googleProps = translateGoogleProps(backendSecretResolver, externalProviders.google);
    if (googleProps) {
        result.externalProviders.google = googleProps;
    }
    return result;
};
/**
 * Translates the senders property from AmplifyAuthProps to AuthProps format.
 * @param senders - The senders object from AmplifyAuthProps.
 * @param getInstanceProps - Properties used to get an instance of the sender.
 * @returns The translated senders object in AuthProps format, or undefined if no valid sender is provided.
 * @description
 * This function handles the translation of the 'senders' property, specifically for email and sms senders.
 * If no senders are provided, it returns undefined.
 * If a sender has a 'getInstance' method, it retrieves the Lambda function and returns it.
 * Otherwise, it returns the sender as is.
 */
export const translateToAuthConstructSenders = (senders, getInstanceProps) => {
    if (!senders || !(senders.email || senders.sms)) {
        return undefined;
    }
    const authConstructSenders = {};
    // Handle CustomEmailSender type
    if (senders.email && 'handler' in senders.email) {
        const lambda = 'getInstance' in senders.email.handler
            ? senders.email.handler.getInstance(getInstanceProps).resources.lambda
            : senders.email.handler;
        authConstructSenders.email = {
            handler: lambda,
            kmsKeyArn: senders.email.kmsKeyArn,
        };
    }
    else if (senders.email && 'fromEmail' in senders.email) {
        // Handle SES configuration
        authConstructSenders.email = { ...senders.email };
    }
    // Handle CustomSmsSender type
    if (senders.sms && 'handler' in senders.sms) {
        const lambda = 'getInstance' in senders.sms.handler
            ? senders.sms.handler.getInstance(getInstanceProps).resources.lambda
            : senders.sms.handler;
        authConstructSenders.sms = {
            handler: lambda,
            kmsKeyArn: senders.sms.kmsKeyArn,
        };
    }
    else if (senders.sms) {
        // Handle SNS configuration
        authConstructSenders.sms = { ...senders.sms };
    }
    return authConstructSenders;
};
const translateAmazonProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateAppleProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, teamId, keyId, privateKey, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        teamId: backendSecretResolver.resolveSecret(teamId).unsafeUnwrap(),
        keyId: backendSecretResolver.resolveSecret(keyId).unsafeUnwrap(),
        privateKey: backendSecretResolver.resolveSecret(privateKey).unsafeUnwrap(),
    };
};
const translateFacebookProps = (backendSecretResolver, facebookProviderProps) => {
    if (!facebookProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = facebookProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateOidcProps = (backendSecretResolver, oidcProviderProps) => {
    if (!oidcProviderProps || oidcProviderProps.length === 0) {
        return undefined;
    }
    const result = [];
    for (const provider of oidcProviderProps) {
        const { clientId, clientSecret, ...noSecretProps } = provider;
        result.push({
            ...noSecretProps,
            clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
            clientSecret: backendSecretResolver
                .resolveSecret(clientSecret)
                .unsafeUnwrap(),
        });
    }
    return result;
};
const translateGoogleProps = (backendSecretResolver, googleProviderProps) => {
    if (!googleProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret: clientSecretValue, ...noSecretProps } = googleProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver.resolveSecret(clientSecretValue),
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRlX2F1dGhfcHJvcHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdHJhbnNsYXRlX2F1dGhfcHJvcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBd0JBOzs7O0dBSUc7QUFDSCxNQUFNLENBQUMsTUFBTSxpQ0FBaUMsR0FBRyxDQUMvQyxvQkFBK0MsRUFDL0MscUJBQTRDLEVBQ3BCLEVBQUU7SUFDMUIsTUFBTSxNQUFNLEdBQ1Ysb0JBQThDLENBQUM7SUFDakQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFO1FBQzNDLE9BQU8sTUFBTSxDQUFDO0tBQ2Y7SUFFRCxNQUFNLGlCQUFpQixHQUFHLG9CQUFvQixDQUFDLGlCQUFpQixDQUFDO0lBQ2pFLE1BQU0sQ0FBQyxpQkFBaUIsR0FBRztRQUN6QixHQUFJLGlCQUF5RDtLQUM5RCxDQUFDO0lBRUYsTUFBTSxXQUFXLEdBQUcsb0JBQW9CLENBQ3RDLHFCQUFxQixFQUNyQixpQkFBaUIsQ0FBQyxlQUFlLENBQ2xDLENBQUM7SUFDRixJQUFJLFdBQVcsRUFBRTtRQUNmLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLEdBQUcsV0FBVyxDQUFDO0tBQ3hEO0lBRUQsTUFBTSxVQUFVLEdBQUcsbUJBQW1CLENBQ3BDLHFCQUFxQixFQUNyQixpQkFBaUIsQ0FBQyxlQUFlLENBQ2xDLENBQUM7SUFDRixJQUFJLFVBQVUsRUFBRTtRQUNkLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLEdBQUcsVUFBVSxDQUFDO0tBQ3ZEO0lBRUQsTUFBTSxhQUFhLEdBQUcsc0JBQXNCLENBQzFDLHFCQUFxQixFQUNyQixpQkFBaUIsQ0FBQyxRQUFRLENBQzNCLENBQUM7SUFDRixJQUFJLGFBQWEsRUFBRTtRQUNqQixNQUFNLENBQUMsaUJBQWlCLENBQUMsUUFBUSxHQUFHLGFBQWEsQ0FBQztLQUNuRDtJQUVELE1BQU0sU0FBUyxHQUFHLGtCQUFrQixDQUNsQyxxQkFBcUIsRUFD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QUFpQixDQUFDO0tBQ3JFLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBbWF6b25Qcm92aWRlclByb3BzLFxuICBBcHBsZVByb3ZpZGVyUHJvcHMsXG4gIEF1dGhQcm9wcyxcbiAgRmFjZWJvb2tQcm92aWRlclByb3BzLFxuICBHb29nbGVQcm92aWRlclByb3BzLFxuICBPaWRjUHJvdmlkZXJQcm9wcyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2F1dGgtY29uc3RydWN0JztcbmltcG9ydCB7XG4gIEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQW1hem9uUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4gIEFwcGxlUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4gIEF1dGhMb2dpbldpdGhGYWN0b3J5UHJvcHMsXG4gIEV4dGVybmFsUHJvdmlkZXJHZW5lcmFsRmFjdG9yeVByb3BzLFxuICBGYWNlYm9va1Byb3ZpZGVyRmFjdG9yeVByb3BzLFxuICBHb29nbGVQcm92aWRlckZhY3RvcnlQcm9wcyxcbiAgT2lkY1Byb3ZpZGVyRmFjdG9yeVByb3BzLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IElGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgQW1wbGlmeUF1dGhQcm9wcyB9IGZyb20gJy4vZmFjdG9yeS5qcyc7XG5cbi8qKlxuICogVHJhbnNsYXRlIGFuIEF1dGggZmFjdG9yeSdzIGxvZ2luV2l0aCB0byBpdHMgQXV0aCBjb25zdHJ1Y3QgY291bnRlcnBhcnQuIEJhY2tlbmQgc2VjcmV0IGZpZWxkcyB3aWxsIGJlIHJlc29sdmVkXG4gKiB0byBhbiBDRk4gdG9rZW4gYW5kIG1hcCB0byB0aGUgcmVxdWlyZWQgY29uc3RydWN0IHR5cGUuIE5vdGUgdGhhdCBub3QgYWxsIGNvbnN0cnVjdCBzZWNyZXQgZmllbGRzIGFyZSBvZiBzZGtcbiAqIFNlY3JldFZhbHVlIHR5cGUsIG1hbnkgYXJlICh3cm9uZ2x5KSBvZiB0eXBlIHN0cmluZyBhcyB3ZWxsLlxuICovXG5leHBvcnQgY29uc3QgdHJhbnNsYXRlVG9BdXRoQ29uc3RydWN0TG9naW5XaXRoID0gKFxuICBhdXRoRmFjdG9yeUxvZ2luV2l0aDogQXV0aExvZ2luV2l0aEZhY3RvcnlQcm9wcyxcbiAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXJcbik6IEF1dGhQcm9wc1snbG9naW5XaXRoJ10gPT4ge1xuICBjb25zdCByZXN1bHQ6IEF1dGhQcm9wc1snbG9naW5XaXRoJ10gPVxuICAgIGF1dGhGYWN0b3J5TG9naW5XaXRoIGFzIEF1dGhQcm9wc1snbG9naW5XaXRoJ107XG4gIGlmICghYXV0aEZhY3RvcnlMb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnMpIHtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgY29uc3QgZXh0ZXJuYWxQcm92aWRlcnMgPSBhdXRoRmFjdG9yeUxvZ2luV2l0aC5leHRlcm5hbFByb3ZpZGVycztcbiAgcmVzdWx0LmV4dGVybmFsUHJvdmlkZXJzID0ge1xuICAgIC4uLihleHRlcm5hbFByb3ZpZGVycyBhcyBFeHRlcm5hbFByb3ZpZGVyR2VuZXJhbEZhY3RvcnlQcm9wcyksXG4gIH07XG5cbiAgY29uc3QgYW1hem9uUHJvcHMgPSB0cmFuc2xhdGVBbWF6b25Qcm9wcyhcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgZXh0ZXJuYWxQcm92aWRlcnMubG9naW5XaXRoQW1hem9uXG4gICk7XG4gIGlmIChhbWF6b25Qcm9wcykge1xuICAgIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycy5sb2dpbldpdGhBbWF6b24gPSBhbWF6b25Qcm9wcztcbiAgfVxuXG4gIGNvbnN0IGFwcGxlUHJvcHMgPSB0cmFuc2xhdGVBcHBsZVByb3BzKFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBleHRlcm5hbFByb3ZpZGVycy5zaWduSW5XaXRoQXBwbGVcbiAgKTtcbiAgaWYgKGFwcGxlUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMuc2lnbkluV2l0aEFwcGxlID0gYXBwbGVQcm9wcztcbiAgfVxuXG4gIGNvbnN0IGZhY2Vib29rUHJvcHMgPSB0cmFuc2xhdGVGYWNlYm9va1Byb3BzKFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBleHRlcm5hbFByb3ZpZGVycy5mYWNlYm9va1xuICApO1xuICBpZiAoZmFjZWJvb2tQcm9wcykge1xuICAgIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycy5mYWNlYm9vayA9IGZhY2Vib29rUHJvcHM7XG4gIH1cblxuICBjb25zdCBvaWRjUHJvcHMgPSB0cmFuc2xhdGVPaWRjUHJvcHMoXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIGV4dGVybmFsUHJvdmlkZXJzLm9pZGNcbiAgKTtcbiAgaWYgKG9pZGNQcm9wcykge1xuICAgIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycy5vaWRjID0gb2lkY1Byb3BzO1xuICB9XG5cbiAgY29uc3QgZ29vZ2xlUHJvcHMgPSB0cmFuc2xhdGVHb29nbGVQcm9wcyhcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgZXh0ZXJuYWxQcm92aWRlcnMuZ29vZ2xlXG4gICk7XG4gIGlmIChnb29nbGVQcm9wcykge1xuICAgIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycy5nb29nbGUgPSBnb29nbGVQcm9wcztcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuLyoqXG4gKiBUcmFuc2xhdGVzIHRoZSBzZW5kZXJzIHByb3BlcnR5IGZyb20gQW1wbGlmeUF1dGhQcm9wcyB0byBBdXRoUHJvcHMgZm9ybWF0LlxuICogQHBhcmFtIHNlbmRlcnMgLSBUaGUgc2VuZGVycyBvYmplY3QgZnJvbSBBbXBsaWZ5QXV0aFByb3BzLlxuICogQHBhcmFtIGdldEluc3RhbmNlUHJvcHMgLSBQcm9wZXJ0aWVzIHVzZWQgdG8gZ2V0IGFuIGluc3RhbmNlIG9mIHRoZSBzZW5kZXIuXG4gKiBAcmV0dXJucyBUaGUgdHJhbnNsYXRlZCBzZW5kZXJzIG9iamVjdCBpbiBBdXRoUHJvcHMgZm9ybWF0LCBvciB1bmRlZmluZWQgaWYgbm8gdmFsaWQgc2VuZGVyIGlzIHByb3ZpZGVkLlxuICogQGRlc2NyaXB0aW9uXG4gKiBUaGlzIGZ1bmN0aW9uIGhhbmRsZXMgdGhlIHRyYW5zbGF0aW9uIG9mIHRoZSAnc2VuZGVycycgcHJvcGVydHksIHNwZWNpZmljYWxseSBmb3IgZW1haWwgYW5kIHNtcyBzZW5kZXJzLlxuICogSWYgbm8gc2VuZGVycyBhcmUgcHJvdmlkZWQsIGl0IHJldHVybnMgdW5kZWZpbmVkLlxuICogSWYgYSBzZW5kZXIgaGFzIGEgJ2dldEluc3RhbmNlJyBtZXRob2QsIGl0IHJldHJpZXZlcyB0aGUgTGFtYmRhIGZ1bmN0aW9uIGFuZCByZXR1cm5zIGl0LlxuICogT3RoZXJ3aXNlLCBpdCByZXR1cm5zIHRoZSBzZW5kZXIgYXMgaXMuXG4gKi9cbmV4cG9ydCBjb25zdCB0cmFuc2xhdGVUb0F1dGhDb25zdHJ1Y3RTZW5kZXJzID0gKFxuICBzZW5kZXJzOiBBbXBsaWZ5QXV0aFByb3BzWydzZW5kZXJzJ10gfCB1bmRlZmluZWQsXG4gIGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzXG4pOiBBdXRoUHJvcHNbJ3NlbmRlcnMnXSB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmICghc2VuZGVycyB8fCAhKHNlbmRlcnMuZW1haWwgfHwgc2VuZGVycy5zbXMpKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IGF1dGhDb25zdHJ1Y3RTZW5kZXJzOiBBdXRoUHJvcHNbJ3NlbmRlcnMnXSA9IHt9O1xuXG4gIC8vIEhhbmRsZSBDdXN0b21FbWFpbFNlbmRlciB0eXBlXG4gIGlmIChzZW5kZXJzLmVtYWlsICYmICdoYW5kbGVyJyBpbiBzZW5kZXJzLmVtYWlsKSB7XG4gICAgY29uc3QgbGFtYmRhOiBJRnVuY3Rpb24gPVxuICAgICAgJ2dldEluc3RhbmNlJyBpbiBzZW5kZXJzLmVtYWlsLmhhbmRsZXJcbiAgICAgICAgPyBzZW5kZXJzLmVtYWlsLmhhbmRsZXIuZ2V0SW5zdGFuY2UoZ2V0SW5zdGFuY2VQcm9wcykucmVzb3VyY2VzLmxhbWJkYVxuICAgICAgICA6IHNlbmRlcnMuZW1haWwuaGFuZGxlcjtcblxuICAgIGF1dGhDb25zdHJ1Y3RTZW5kZXJzLmVtYWlsID0ge1xuICAgICAgaGFuZGxlcjogbGFtYmRhLFxuICAgICAga21zS2V5QXJuOiBzZW5kZXJzLmVtYWlsLmttc0tleUFybixcbiAgICB9O1xuICB9IGVsc2UgaWYgKHNlbmRlcnMuZW1haWwgJiYgJ2Zyb21FbWFpbCcgaW4gc2VuZGVycy5lbWFpbCkge1xuICAgIC8vIEhhbmRsZSBTRVMgY29uZmlndXJhdGlvblxuICAgIGF1dGhDb25zdHJ1Y3RTZW5kZXJzLmVtYWlsID0geyAuLi5zZW5kZXJzLmVtYWlsIH07XG4gIH1cblxuICAvLyBIYW5kbGUgQ3VzdG9tU21zU2VuZGVyIHR5cGVcbiAgaWYgKHNlbmRlcnMuc21zICYmICdoYW5kbGVyJyBpbiBzZW5kZXJzLnNtcykge1xuICAgIGNvbnN0IGxhbWJkYTogSUZ1bmN0aW9uID1cbiAgICAgICdnZXRJbnN0YW5jZScgaW4gc2VuZGVycy5zbXMuaGFuZGxlclxuICAgICAgICA/IHNlbmRlcnMuc21zLmhhbmRsZXIuZ2V0SW5zdGFuY2UoZ2V0SW5zdGFuY2VQcm9wcykucmVzb3VyY2VzLmxhbWJkYVxuICAgICAgICA6IHNlbmRlcnMuc21zLmhhbmRsZXI7XG5cbiAgICBhdXRoQ29uc3RydWN0U2VuZGVycy5zbXMgPSB7XG4gICAgICBoYW5kbGVyOiBsYW1iZGEsXG4gICAgICBrbXNLZXlBcm46IHNlbmRlcnMuc21zLmttc0tleUFybixcbiAgICB9O1xuICB9IGVsc2UgaWYgKHNlbmRlcnMuc21zKSB7XG4gICAgLy8gSGFuZGxlIFNOUyBjb25maWd1cmF0aW9uXG4gICAgYXV0aENvbnN0cnVjdFNlbmRlcnMuc21zID0geyAuLi5zZW5kZXJzLnNtcyB9O1xuICB9XG4gIHJldHVybiBhdXRoQ29uc3RydWN0U2VuZGVycztcbn07XG5cbmNvbnN0IHRyYW5zbGF0ZUFtYXpvblByb3BzID0gKFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgYW1hem9uUHJvdmlkZXJQcm9wcz86IEFtYXpvblByb3ZpZGVyRmFjdG9yeVByb3BzXG4pOiBBbWF6b25Qcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFhbWF6b25Qcm92aWRlclByb3BzKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHsgY2xpZW50SWQsIGNsaWVudFNlY3JldCwgLi4ubm9TZWNyZXRQcm9wcyB9ID0gYW1hem9uUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXJcbiAgICAgIC5yZXNvbHZlU2VjcmV0KGNsaWVudFNlY3JldClcbiAgICAgIC51bnNhZmVVbndyYXAoKSxcbiAgfTtcbn07XG5cbmNvbnN0IHRyYW5zbGF0ZUFwcGxlUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBhbWF6b25Qcm92aWRlclByb3BzPzogQXBwbGVQcm92aWRlckZhY3RvcnlQcm9wc1xuKTogQXBwbGVQcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFhbWF6b25Qcm92aWRlclByb3BzKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHsgY2xpZW50SWQsIHRlYW1JZCwga2V5SWQsIHByaXZhdGVLZXksIC4uLm5vU2VjcmV0UHJvcHMgfSA9XG4gICAgYW1hem9uUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgdGVhbUlkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldCh0ZWFtSWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIGtleUlkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChrZXlJZCkudW5zYWZlVW53cmFwKCksXG4gICAgcHJpdmF0ZUtleTogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQocHJpdmF0ZUtleSkudW5zYWZlVW53cmFwKCksXG4gIH07XG59O1xuXG5jb25zdCB0cmFuc2xhdGVGYWNlYm9va1Byb3BzID0gKFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgZmFjZWJvb2tQcm92aWRlclByb3BzPzogRmFjZWJvb2tQcm92aWRlckZhY3RvcnlQcm9wc1xuKTogRmFjZWJvb2tQcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFmYWNlYm9va1Byb3ZpZGVyUHJvcHMpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgeyBjbGllbnRJZCwgY2xpZW50U2VjcmV0LCAuLi5ub1NlY3JldFByb3BzIH0gPSBmYWNlYm9va1Byb3ZpZGVyUHJvcHM7XG4gIHJldHVybiB7XG4gICAgLi4ubm9TZWNyZXRQcm9wcyxcbiAgICBjbGllbnRJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIGNsaWVudFNlY3JldDogYmFja2VuZFNlY3JldFJlc29sdmVyXG4gICAgICAucmVzb2x2ZVNlY3JldChjbGllbnRTZWNyZXQpXG4gICAgICAudW5zYWZlVW53cmFwKCksXG4gIH07XG59O1xuXG5jb25zdCB0cmFuc2xhdGVPaWRjUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBvaWRjUHJvdmlkZXJQcm9wcz86IE9pZGNQcm92aWRlckZhY3RvcnlQcm9wc1tdXG4pOiBPaWRjUHJvdmlkZXJQcm9wc1tdIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFvaWRjUHJvdmlkZXJQcm9wcyB8fCBvaWRjUHJvdmlkZXJQcm9wcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIGZvciAoY29uc3QgcHJvdmlkZXIgb2Ygb2lkY1Byb3ZpZGVyUHJvcHMpIHtcbiAgICBjb25zdCB7IGNsaWVudElkLCBjbGllbnRTZWNyZXQsIC4uLm5vU2VjcmV0UHJvcHMgfSA9IHByb3ZpZGVyO1xuICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgIC4uLm5vU2VjcmV0UHJvcHMsXG4gICAgICBjbGllbnRJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXJcbiAgICAgICAgLnJlc29sdmVTZWNyZXQoY2xpZW50U2VjcmV0KVxuICAgICAgICAudW5zYWZlVW53cmFwKCksXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgdHJhbnNsYXRlR29vZ2xlUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBnb29nbGVQcm92aWRlclByb3BzPzogR29vZ2xlUHJvdmlkZXJGYWN0b3J5UHJvcHNcbik6IEdvb2dsZVByb3ZpZGVyUHJvcHMgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIWdvb2dsZVByb3ZpZGVyUHJvcHMpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIGNsaWVudElkLFxuICAgIGNsaWVudFNlY3JldDogY2xpZW50U2VjcmV0VmFsdWUsXG4gICAgLi4ubm9TZWNyZXRQcm9wc1xuICB9ID0gZ29vZ2xlUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRTZWNyZXRWYWx1ZSksXG4gIH07XG59O1xuIl19