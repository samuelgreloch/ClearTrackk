import { authAccessBuilder as _authAccessBuilder } from './access_builder.js';
import path from 'path';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { AuthAccessPolicyArbiterFactory } from './auth_access_policy_arbiter.js';
import { Stack, Tags } from 'aws-cdk-lib';
import { UserPoolAccessPolicyFactory } from './userpool_access_policy_factory.js';
import { AmplifyAuthFactory } from './factory.js';
import { AmplifyReferenceAuth } from './reference_construct.js';
/**
 * Singleton factory for AmplifyReferenceAuth that can be used in Amplify project files.
 *
 * Exported for testing purpose only & should NOT be exported out of the package.
 */
export class AmplifyReferenceAuthFactory {
    props;
    importStack;
    provides = 'AuthResources';
    generator;
    /**
     * Set the properties that will be used to initialize AmplifyReferenceAuth
     */
    constructor(props, 
    // eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
    importStack = new Error().stack) {
        this.props = props;
        this.importStack = importStack;
        if (AmplifyAuthFactory.factoryCount > 0) {
            throw new AmplifyUserError('MultipleSingletonResourcesError', {
                message: 'Multiple `defineAuth` or `referenceAuth` calls are not allowed within an Amplify backend',
                resolution: 'Remove all but one `defineAuth` or `referenceAuth` call',
            });
        }
        AmplifyAuthFactory.factoryCount++;
    }
    /**
     * Get a singleton instance of AmplifyReferenceAuth
     */
    getInstance = (getInstanceProps) => {
        const { constructContainer, importPathVerifier } = getInstanceProps;
        importPathVerifier?.verify(this.importStack, path.join('amplify', 'auth', 'resource'), 'Amplify Auth must be defined in amplify/auth/resource.ts');
        if (!this.generator) {
            this.generator = new AmplifyReferenceAuthGenerator(this.props, getInstanceProps);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class AmplifyReferenceAuthGenerator {
    props;
    getInstanceProps;
    authAccessBuilder;
    authAccessPolicyArbiterFactory;
    resourceGroupName = 'auth';
    name;
    constructor(props, getInstanceProps, authAccessBuilder = _authAccessBuilder, authAccessPolicyArbiterFactory = new AuthAccessPolicyArbiterFactory()) {
        this.props = props;
        this.getInstanceProps = getInstanceProps;
        this.authAccessBuilder = authAccessBuilder;
        this.authAccessPolicyArbiterFactory = authAccessPolicyArbiterFactory;
        this.name = 'amplifyAuth';
    }
    generateContainerEntry = ({ scope, ssmEnvironmentEntriesGenerator, }) => {
        const authProps = {
            ...this.props,
            outputStorageStrategy: this.getInstanceProps.outputStorageStrategy,
        };
        let authConstruct;
        try {
            authConstruct = new AmplifyReferenceAuth(scope, this.name, authProps);
        }
        catch (error) {
            throw new AmplifyUserError('AmplifyReferenceAuthConstructInitializationError', {
                message: 'Failed to instantiate reference auth construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(authConstruct).add(TagName.FRIENDLY_NAME, this.name);
        const authConstructMixin = {
            ...authConstruct,
            /**
             * Returns a resourceAccessAcceptor for the given role
             * @param roleIdentifier Either the auth or unauth role name or the name of a UserPool group
             */
            getResourceAccessAcceptor: (roleIdentifier) => ({
                identifier: `${roleIdentifier}ResourceAccessAcceptor`,
                acceptResourceAccess: (policy) => {
                    const role = roleNameIsAuthRoleName(roleIdentifier)
                        ? authConstruct.resources[roleIdentifier]
                        : authConstruct.resources.groups?.[roleIdentifier]?.role;
                    if (!role) {
                        throw new AmplifyUserError('InvalidResourceAccessConfigError', {
                            message: `No auth IAM role found for "${roleIdentifier}".`,
                            resolution: `If you are trying to configure UserPool group access, ensure that the group name is specified correctly.`,
                        });
                    }
                    policy.attachToRole(role);
                },
            }),
            stack: Stack.of(authConstruct),
        };
        if (!this.props.access) {
            return authConstructMixin;
        }
        // props.access is the access callback defined by the customer
        // here we inject the authAccessBuilder into the callback and run it
        // this produces the access definition that will be used to create the auth access policies
        const accessDefinition = this.props.access(this.authAccessBuilder);
        const ssmEnvironmentEntries = ssmEnvironmentEntriesGenerator.generateSsmEnvironmentEntries({
            [`${this.name}_USERPOOL_ID`]: authConstructMixin.resources.userPool.userPoolId,
        });
        const authPolicyArbiter = this.authAccessPolicyArbiterFactory.getInstance(accessDefinition, this.getInstanceProps, ssmEnvironmentEntries, new UserPoolAccessPolicyFactory(authConstruct.resources.userPool));
        authPolicyArbiter.arbitratePolicies();
        return authConstructMixin;
    };
}
const roleNameIsAuthRoleName = (roleName) => {
    return (roleName === 'authenticatedUserIamRole' ||
        roleName === 'unauthenticatedUserIamRole');
};
/**
 * Provide references to existing auth resources.
 */
export const referenceAuth = (props) => {
    return new AmplifyReferenceAuthFactory(props, 
    // eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
    new Error().stack);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlX2ZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVmZXJlbmNlX2ZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBZUEsT0FBTyxFQUFFLGlCQUFpQixJQUFJLGtCQUFrQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUUsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNqRixPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUUxQyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNsRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDbEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFzRGhFOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sMkJBQTJCO0lBV25CO0lBRUE7SUFWVixRQUFRLEdBQUcsZUFBZSxDQUFDO0lBRTVCLFNBQVMsQ0FBbUM7SUFFcEQ7O09BRUc7SUFDSCxZQUNtQixLQUFnQztJQUNqRCx1RUFBdUU7SUFDdEQsY0FBYyxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUs7UUFGL0IsVUFBSyxHQUFMLEtBQUssQ0FBMkI7UUFFaEMsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBRWhELElBQUksa0JBQWtCLENBQUMsWUFBWSxHQUFHLENBQUMsRUFBRTtZQUN2QyxNQUFNLElBQUksZ0JBQWdCLENBQUMsaUNBQWlDLEVBQUU7Z0JBQzVELE9BQU8sRUFDTCwwRkFBMEY7Z0JBQzVGLFVBQVUsRUFBRSx5REFBeUQ7YUFDdEUsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxrQkFBa0IsQ0FBQyxZQUFZLEVBQUUsQ0FB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QUs7SUFDTCx1RUFBdUU7SUFDdkUsSUFBSSxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQ2xCLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWUsXG4gIEF1dGhSb2xlTmFtZSxcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3IsXG4gIENvbnN0cnVjdEZhY3RvcnksXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIFJlZmVyZW5jZUF1dGhSZXNvdXJjZXMsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3IsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5LFxuICBSZXNvdXJjZVByb3ZpZGVyLFxuICBTdGFja1Byb3ZpZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IEF1dGhBY2Nlc3NHZW5lcmF0b3IsIEV4cGFuZCB9IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgYXV0aEFjY2Vzc0J1aWxkZXIgYXMgX2F1dGhBY2Nlc3NCdWlsZGVyIH0gZnJvbSAnLi9hY2Nlc3NfYnVpbGRlci5qcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IsIFRhZ05hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBBdXRoQWNjZXNzUG9saWN5QXJiaXRlckZhY3RvcnkgfSBmcm9tICcuL2F1dGhfYWNjZXNzX3BvbGljeV9hcmJpdGVyLmpzJztcbmltcG9ydCB7IFN0YWNrLCBUYWdzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgUG9saWN5IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBVc2VyUG9vbEFjY2Vzc1BvbGljeUZhY3RvcnkgfSBmcm9tICcuL3VzZXJwb29sX2FjY2Vzc19wb2xpY3lfZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBBbXBsaWZ5QXV0aEZhY3RvcnkgfSBmcm9tICcuL2ZhY3RvcnkuanMnO1xuaW1wb3J0IHsgQW1wbGlmeVJlZmVyZW5jZUF1dGggfSBmcm9tICcuL3JlZmVyZW5jZV9jb25zdHJ1Y3QuanMnO1xuaW1wb3J0IHsgQXV0aE91dHB1dCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcblxuZXhwb3J0IHR5cGUgUmVmZXJlbmNlQXV0aFByb3BzID0ge1xuICAvKipcbiAgICogQGludGVybmFsXG4gICAqL1xuICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k/OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEF1dGhPdXRwdXQ+O1xuICAvKipcbiAgICogRXhpc3RpbmcgVXNlclBvb2wgSWRcbiAgICovXG4gIHVzZXJQb29sSWQ6IHN0cmluZztcbiAgLyoqXG4gICAqIEV4aXN0aW5nIElkZW50aXR5UG9vbCBJZFxuICAgKi9cbiAgaWRlbnRpdHlQb29sSWQ6IHN0cmluZztcbiAgLyoqXG4gICAqIEV4aXN0aW5nIFVzZXJQb29sQ2xpZW50IElkXG4gICAqL1xuICB1c2VyUG9vbENsaWVudElkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBFeGlzdGluZyBBdXRoUm9sZSBBUk5cbiAgICovXG4gIGF1dGhSb2xlQXJuOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBFeGlzdGluZyBVbmF1dGhSb2xlIEFSTlxuICAgKi9cbiAgdW5hdXRoUm9sZUFybjogc3RyaW5nO1xuICAvKipcbiAgICogQSBtYXBwaW5nIG9mIGV4aXN0aW5nIGdyb3VwIG5hbWVzIGFuZCB0aGVpciBhc3NvY2lhdGVkIHJvbGUgQVJOc1xuICAgKiB3aGljaCBjYW4gYmUgdXNlZCBmb3IgZ3JvdXAgcGVybWlzc2lvbnMuXG4gICAqL1xuICBncm91cHM/OiB7XG4gICAgW2dyb3VwTmFtZTogc3RyaW5nXTogc3RyaW5nO1xuICB9O1xufTtcblxuZXhwb3J0IHR5cGUgQmFja2VuZFJlZmVyZW5jZUF1dGggPSBSZXNvdXJjZVByb3ZpZGVyPFJlZmVyZW5jZUF1dGhSZXNvdXJjZXM+ICZcbiAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3Rvcnk8QXV0aFJvbGVOYW1lIHwgc3RyaW5nPiAmXG4gIFN0YWNrUHJvdmlkZXI7XG5cbmV4cG9ydCB0eXBlIEFtcGxpZnlSZWZlcmVuY2VBdXRoUHJvcHMgPSBFeHBhbmQ8XG4gIE9taXQ8UmVmZXJlbmNlQXV0aFByb3BzLCAnb3V0cHV0U3RvcmFnZVN0cmF0ZWd5Jz4gJiB7XG4gICAgLyoqXG4gICAgICogQ29uZmlndXJlIGFjY2VzcyB0byBhdXRoIGZvciBvdGhlciBBbXBsaWZ5IHJlc291cmNlc1xuICAgICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmFtcGxpZnkuYXdzL3JlYWN0L2J1aWxkLWEtYmFja2VuZC9hdXRoL2dyYW50LWFjY2Vzcy10by1hdXRoLXJlc291cmNlcy9cbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGFjY2VzczogKGFsbG93KSA9PiBbYWxsb3cucmVzb3VyY2UocG9zdENvbmZpcm1hdGlvbikudG8oW1wiYWRkVXNlclRvR3JvdXBcIl0pXVxuICAgICAqIEBleGFtcGxlXG4gICAgICogYWNjZXNzOiAoYWxsb3cpID0+IFthbGxvdy5yZXNvdXJjZShncm91cE1hbmFnZXIpLnRvKFtcIm1hbmFnZUdyb3Vwc1wiXSldXG4gICAgICovXG4gICAgYWNjZXNzPzogQXV0aEFjY2Vzc0dlbmVyYXRvcjtcbiAgfVxuPjtcbi8qKlxuICogU2luZ2xldG9uIGZhY3RvcnkgZm9yIEFtcGxpZnlSZWZlcmVuY2VBdXRoIHRoYXQgY2FuIGJlIHVzZWQgaW4gQW1wbGlmeSBwcm9qZWN0IGZpbGVzLlxuICpcbiAqIEV4cG9ydGVkIGZvciB0ZXN0aW5nIHB1cnBvc2Ugb25seSAmIHNob3VsZCBOT1QgYmUgZXhwb3J0ZWQgb3V0IG9mIHRoZSBwYWNrYWdlLlxuICovXG5leHBvcnQgY2xhc3MgQW1wbGlmeVJlZmVyZW5jZUF1dGhGYWN0b3J5XG4gIGltcGxlbWVudHMgQ29uc3RydWN0RmFjdG9yeTxCYWNrZW5kUmVmZXJlbmNlQXV0aD5cbntcbiAgcmVhZG9ubHkgcHJvdmlkZXMgPSAnQXV0aFJlc291cmNlcyc7XG5cbiAgcHJpdmF0ZSBnZW5lcmF0b3I6IENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yO1xuXG4gIC8qKlxuICAgKiBTZXQgdGhlIHByb3BlcnRpZXMgdGhhdCB3aWxsIGJlIHVzZWQgdG8gaW5pdGlhbGl6ZSBBbXBsaWZ5UmVmZXJlbmNlQXV0aFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogQW1wbGlmeVJlZmVyZW5jZUF1dGhQcm9wcyxcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgYW1wbGlmeS1iYWNrZW5kLXJ1bGVzL3ByZWZlci1hbXBsaWZ5LWVycm9yc1xuICAgIHByaXZhdGUgcmVhZG9ubHkgaW1wb3J0U3RhY2sgPSBuZXcgRXJyb3IoKS5zdGFja1xuICApIHtcbiAgICBpZiAoQW1wbGlmeUF1dGhGYWN0b3J5LmZhY3RvcnlDb3VudCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdNdWx0aXBsZVNpbmdsZXRvblJlc291cmNlc0Vycm9yJywge1xuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICdNdWx0aXBsZSBgZGVmaW5lQXV0aGAgb3IgYHJlZmVyZW5jZUF1dGhgIGNhbGxzIGFyZSBub3QgYWxsb3dlZCB3aXRoaW4gYW4gQW1wbGlmeSBiYWNrZW5kJyxcbiAgICAgICAgcmVzb2x1dGlvbjogJ1JlbW92ZSBhbGwgYnV0IG9uZSBgZGVmaW5lQXV0aGAgb3IgYHJlZmVyZW5jZUF1dGhgIGNhbGwnLFxuICAgICAgfSk7XG4gICAgfVxuICAgIEFtcGxpZnlBdXRoRmFjdG9yeS5mYWN0b3J5Q291bnQrKztcbiAgfVxuICAvKipcbiAgICogR2V0IGEgc2luZ2xldG9uIGluc3RhbmNlIG9mIEFtcGxpZnlSZWZlcmVuY2VBdXRoXG4gICAqL1xuICBnZXRJbnN0YW5jZSA9IChcbiAgICBnZXRJbnN0YW5jZVByb3BzOiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wc1xuICApOiBCYWNrZW5kUmVmZXJlbmNlQXV0aCA9PiB7XG4gICAgY29uc3QgeyBjb25zdHJ1Y3RDb250YWluZXIsIGltcG9ydFBhdGhWZXJpZmllciB9ID0gZ2V0SW5zdGFuY2VQcm9wcztcbiAgICBpbXBvcnRQYXRoVmVyaWZpZXI/LnZlcmlmeShcbiAgICAgIHRoaXMuaW1wb3J0U3RhY2ssXG4gICAgICBwYXRoLmpvaW4oJ2FtcGxpZnknLCAnYXV0aCcsICdyZXNvdXJjZScpLFxuICAgICAgJ0FtcGxpZnkgQXV0aCBtdXN0IGJlIGRlZmluZWQgaW4gYW1wbGlmeS9hdXRoL3Jlc291cmNlLnRzJ1xuICAgICk7XG4gICAgaWYgKCF0aGlzLmdlbmVyYXRvcikge1xuICAgICAgdGhpcy5nZW5lcmF0b3IgPSBuZXcgQW1wbGlmeVJlZmVyZW5jZUF1dGhHZW5lcmF0b3IoXG4gICAgICAgIHRoaXMucHJvcHMsXG4gICAgICAgIGdldEluc3RhbmNlUHJvcHNcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBjb25zdHJ1Y3RDb250YWluZXIuZ2V0T3JDb21wdXRlKFxuICAgICAgdGhpcy5nZW5lcmF0b3JcbiAgICApIGFzIEJhY2tlbmRSZWZlcmVuY2VBdXRoO1xuICB9O1xufVxuY2xhc3MgQW1wbGlmeVJlZmVyZW5jZUF1dGhHZW5lcmF0b3JcbiAgaW1wbGVtZW50cyBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvclxue1xuICByZWFkb25seSByZXNvdXJjZUdyb3VwTmFtZTogQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lID0gJ2F1dGgnO1xuICBwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBBbXBsaWZ5UmVmZXJlbmNlQXV0aFByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZ2V0SW5zdGFuY2VQcm9wczogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdXRoQWNjZXNzQnVpbGRlciA9IF9hdXRoQWNjZXNzQnVpbGRlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1dGhBY2Nlc3NQb2xpY3lBcmJpdGVyRmFjdG9yeSA9IG5ldyBBdXRoQWNjZXNzUG9saWN5QXJiaXRlckZhY3RvcnkoKVxuICApIHtcbiAgICB0aGlzLm5hbWUgPSAnYW1wbGlmeUF1dGgnO1xuICB9XG5cbiAgZ2VuZXJhdGVDb250YWluZXJFbnRyeSA9ICh7XG4gICAgc2NvcGUsXG4gICAgc3NtRW52aXJvbm1lbnRFbnRyaWVzR2VuZXJhdG9yLFxuICB9OiBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMpID0+IHtcbiAgICBjb25zdCBhdXRoUHJvcHM6IFJlZmVyZW5jZUF1dGhQcm9wcyA9IHtcbiAgICAgIC4uLnRoaXMucHJvcHMsXG4gICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IHRoaXMuZ2V0SW5zdGFuY2VQcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gICAgfTtcblxuICAgIGxldCBhdXRoQ29uc3RydWN0OiBBbXBsaWZ5UmVmZXJlbmNlQXV0aDtcbiAgICB0cnkge1xuICAgICAgYXV0aENvbnN0cnVjdCA9IG5ldyBBbXBsaWZ5UmVmZXJlbmNlQXV0aChzY29wZSwgdGhpcy5uYW1lLCBhdXRoUHJvcHMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0FtcGxpZnlSZWZlcmVuY2VBdXRoQ29uc3RydWN0SW5pdGlhbGl6YXRpb25FcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGluc3RhbnRpYXRlIHJlZmVyZW5jZSBhdXRoIGNvbnN0cnVjdCcsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3JcbiAgICAgICk7XG4gICAgfVxuXG4gICAgVGFncy5vZihhdXRoQ29uc3RydWN0KS5hZGQoVGFnTmFtZS5GUklFTkRMWV9OQU1FLCB0aGlzLm5hbWUpO1xuXG4gICAgY29uc3QgYXV0aENvbnN0cnVjdE1peGluOiBCYWNrZW5kUmVmZXJlbmNlQXV0aCA9IHtcbiAgICAgIC4uLmF1dGhDb25zdHJ1Y3QsXG4gICAgICAvKipcbiAgICAgICAqIFJldHVybnMgYSByZXNvdXJjZUFjY2Vzc0FjY2VwdG9yIGZvciB0aGUgZ2l2ZW4gcm9sZVxuICAgICAgICogQHBhcmFtIHJvbGVJZGVudGlmaWVyIEVpdGhlciB0aGUgYXV0aCBvciB1bmF1dGggcm9sZSBuYW1lIG9yIHRoZSBuYW1lIG9mIGEgVXNlclBvb2wgZ3JvdXBcbiAgICAgICAqL1xuICAgICAgZ2V0UmVzb3VyY2VBY2Nlc3NBY2NlcHRvcjogKFxuICAgICAgICByb2xlSWRlbnRpZmllcjogQXV0aFJvbGVOYW1lIHwgc3RyaW5nXG4gICAgICApOiBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yID0+ICh7XG4gICAgICAgIGlkZW50aWZpZXI6IGAke3JvbGVJZGVudGlmaWVyfVJlc291cmNlQWNjZXNzQWNjZXB0b3JgLFxuICAgICAgICBhY2NlcHRSZXNvdXJjZUFjY2VzczogKHBvbGljeTogUG9saWN5KSA9PiB7XG4gICAgICAgICAgY29uc3Qgcm9sZSA9IHJvbGVOYW1lSXNBdXRoUm9sZU5hbWUocm9sZUlkZW50aWZpZXIpXG4gICAgICAgICAgICA/IGF1dGhDb25zdHJ1Y3QucmVzb3VyY2VzW3JvbGVJZGVudGlmaWVyXVxuICAgICAgICAgICAgOiBhdXRoQ29uc3RydWN0LnJlc291cmNlcy5ncm91cHM/Lltyb2xlSWRlbnRpZmllcl0/LnJvbGU7XG4gICAgICAgICAgaWYgKCFyb2xlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZFJlc291cmNlQWNjZXNzQ29uZmlnRXJyb3InLCB7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBObyBhdXRoIElBTSByb2xlIGZvdW5kIGZvciBcIiR7cm9sZUlkZW50aWZpZXJ9XCIuYCxcbiAgICAgICAgICAgICAgcmVzb2x1dGlvbjogYElmIHlvdSBhcmUgdHJ5aW5nIHRvIGNvbmZpZ3VyZSBVc2VyUG9vbCBncm91cCBhY2Nlc3MsIGVuc3VyZSB0aGF0IHRoZSBncm91cCBuYW1lIGlzIHNwZWNpZmllZCBjb3JyZWN0bHkuYCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBwb2xpY3kuYXR0YWNoVG9Sb2xlKHJvbGUpO1xuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICBzdGFjazogU3RhY2sub2YoYXV0aENvbnN0cnVjdCksXG4gICAgfTtcbiAgICBpZiAoIXRoaXMucHJvcHMuYWNjZXNzKSB7XG4gICAgICByZXR1cm4gYXV0aENvbnN0cnVjdE1peGluO1xuICAgIH1cbiAgICAvLyBwcm9wcy5hY2Nlc3MgaXMgdGhlIGFjY2VzcyBjYWxsYmFjayBkZWZpbmVkIGJ5IHRoZSBjdXN0b21lclxuICAgIC8vIGhlcmUgd2UgaW5qZWN0IHRoZSBhdXRoQWNjZXNzQnVpbGRlciBpbnRvIHRoZSBjYWxsYmFjayBhbmQgcnVuIGl0XG4gICAgLy8gdGhpcyBwcm9kdWNlcyB0aGUgYWNjZXNzIGRlZmluaXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgdG8gY3JlYXRlIHRoZSBhdXRoIGFjY2VzcyBwb2xpY2llc1xuICAgIGNvbnN0IGFjY2Vzc0RlZmluaXRpb24gPSB0aGlzLnByb3BzLmFjY2Vzcyh0aGlzLmF1dGhBY2Nlc3NCdWlsZGVyKTtcblxuICAgIGNvbnN0IHNzbUVudmlyb25tZW50RW50cmllcyA9XG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXNHZW5lcmF0b3IuZ2VuZXJhdGVTc21FbnZpcm9ubWVudEVudHJpZXMoe1xuICAgICAgICBbYCR7dGhpcy5uYW1lfV9VU0VSUE9PTF9JRGBdOlxuICAgICAgICAgIGF1dGhDb25zdHJ1Y3RNaXhpbi5yZXNvdXJjZXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgIH0pO1xuXG4gICAgY29uc3QgYXV0aFBvbGljeUFyYml0ZXIgPSB0aGlzLmF1dGhBY2Nlc3NQb2xpY3lBcmJpdGVyRmFjdG9yeS5nZXRJbnN0YW5jZShcbiAgICAgIGFjY2Vzc0RlZmluaXRpb24sXG4gICAgICB0aGlzLmdldEluc3RhbmNlUHJvcHMsXG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXMsXG4gICAgICBuZXcgVXNlclBvb2xBY2Nlc3NQb2xpY3lGYWN0b3J5KGF1dGhDb25zdHJ1Y3QucmVzb3VyY2VzLnVzZXJQb29sKVxuICAgICk7XG5cbiAgICBhdXRoUG9saWN5QXJiaXRlci5hcmJpdHJhdGVQb2xpY2llcygpO1xuXG4gICAgcmV0dXJuIGF1dGhDb25zdHJ1Y3RNaXhpbjtcbiAgfTtcbn1cblxuY29uc3Qgcm9sZU5hbWVJc0F1dGhSb2xlTmFtZSA9IChyb2xlTmFtZTogc3RyaW5nKTogcm9sZU5hbWUgaXMgQXV0aFJvbGVOYW1lID0+IHtcbiAgcmV0dXJuIChcbiAgICByb2xlTmFtZSA9PT0gJ2F1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZScgfHxcbiAgICByb2xlTmFtZSA9PT0gJ3VuYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlJ1xuICApO1xufTtcblxuLyoqXG4gKiBQcm92aWRlIHJlZmVyZW5jZXMgdG8gZXhpc3RpbmcgYXV0aCByZXNvdXJjZXMuXG4gKi9cbmV4cG9ydCBjb25zdCByZWZlcmVuY2VBdXRoID0gKFxuICBwcm9wczogQW1wbGlmeVJlZmVyZW5jZUF1dGhQcm9wc1xuKTogQ29uc3RydWN0RmFjdG9yeTxCYWNrZW5kUmVmZXJlbmNlQXV0aD4gPT4ge1xuICByZXR1cm4gbmV3IEFtcGxpZnlSZWZlcmVuY2VBdXRoRmFjdG9yeShcbiAgICBwcm9wcyxcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgYW1wbGlmeS1iYWNrZW5kLXJ1bGVzL3ByZWZlci1hbXBsaWZ5LWVycm9yc1xuICAgIG5ldyBFcnJvcigpLnN0YWNrXG4gICk7XG59O1xuIl19