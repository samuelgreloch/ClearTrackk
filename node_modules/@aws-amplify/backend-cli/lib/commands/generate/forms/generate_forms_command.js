import path from 'path';
import { BackendOutputClientError, BackendOutputClientErrorType, } from '@aws-amplify/deployed-backend-client';
import { graphqlOutputKey } from '@aws-amplify/backend-output-schemas';
import { DEFAULT_UI_PATH } from '../../../form-generation/default_form_generation_output_paths.js';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Command that generates UI forms.
 */
export class GenerateFormsCommand {
    backendIdentifierResolver;
    backendOutputClientBuilder;
    formGenerationHandler;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    /**
     * Creates UI forms generation command.
     */
    constructor(backendIdentifierResolver, backendOutputClientBuilder, formGenerationHandler) {
        this.backendIdentifierResolver = backendIdentifierResolver;
        this.backendOutputClientBuilder = backendOutputClientBuilder;
        this.formGenerationHandler = formGenerationHandler;
        this.command = 'forms';
        this.describe = 'Generates UI forms';
    }
    getBackendIdentifier = async (args) => {
        return await this.backendIdentifierResolver.resolveDeployedBackendIdentifier(args);
    };
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const backendIdentifier = await this.backendIdentifierResolver.resolveDeployedBackendIdentifier(args);
        if (!backendIdentifier) {
            throw new AmplifyUserError('BackendIdentifierResolverError', {
                message: 'Could not resolve the backend identifier.',
                resolution: 'Ensure stack name or Amplify App ID and branch specified are correct and exists, then re-run this command.',
            });
        }
        const backendOutputClient = this.backendOutputClientBuilder();
        let output;
        try {
            output = await backendOutputClient.getOutput(backendIdentifier);
        }
        catch (error) {
            if (BackendOutputClientError.isBackendOutputClientError(error)) {
                switch (error.code) {
                    case BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS:
                        throw new AmplifyUserError('DeploymentInProgressError', {
                            message: 'Deployment is currently in progress.',
                            resolution: 'Re-run this command once the deployment completes.',
                        }, error);
                    case BackendOutputClientErrorType.NO_STACK_FOUND:
                        throw new AmplifyUserError('StackDoesNotExistError', {
                            message: 'Stack does not exist.',
                            resolution: 'Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists, then re-run this command.',
                        }, error);
                    case BackendOutputClientErrorType.NO_OUTPUTS_FOUND:
                        throw new AmplifyUserError('AmplifyOutputsNotFoundError', {
                            message: 'Amplify outputs not found in stack metadata',
                            resolution: `Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists.
        If this is a new sandbox or branch deployment, wait for the deployment to be successfully finished and try again.`,
                        }, error);
                    case BackendOutputClientErrorType.CREDENTIALS_ERROR:
                        throw new AmplifyUserError('CredentialsError', {
                            message: 'Unable to get backend outputs due to invalid credentials.',
                            resolution: 'Ensure your AWS credentials are correctly set and refreshed.',
                        }, error);
                    case BackendOutputClientErrorType.ACCESS_DENIED:
                        throw new AmplifyUserError('AccessDeniedError', {
                            message: 'Unable to get backend outputs due to insufficient permissions.',
                            resolution: 'Ensure you have permissions to call cloudformation:GetTemplateSummary.',
                        }, error);
                    default:
                        throw error;
                }
            }
            throw error;
        }
        if (!(graphqlOutputKey in output) || !output[graphqlOutputKey]) {
            throw new Error('No GraphQL API configured for this backend.');
        }
        const apiUrl = output[graphqlOutputKey].payload.amplifyApiModelSchemaS3Uri;
        if (!args.outDir) {
            throw new Error('out-dir must be defined');
        }
        const outDir = args.outDir;
        await this.formGenerationHandler.generate({
            modelsOutDir: path.join(outDir, 'graphql'),
            backendIdentifier,
            uiOutDir: outDir,
            apiUrl,
            modelsFilter: args.models,
        });
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return yargs
            .option('stack', {
            conflicts: ['app-id', 'branch'],
            describe: 'A stack name that contains an Amplify backend',
            type: 'string',
            array: false,
            group: 'Stack identifier',
        })
            .option('app-id', {
            conflicts: ['stack'],
            describe: 'The Amplify App ID of the project',
            type: 'string',
            array: false,
            implies: 'branch',
            group: 'Project identifier',
        })
            .option('branch', {
            conflicts: ['stack'],
            describe: 'A git branch of the Amplify project',
            type: 'string',
            array: false,
            group: 'Project identifier',
            implies: 'appId',
        })
            .option('out-dir', {
            describe: 'A path to directory where generated forms are written.',
            default: DEFAULT_UI_PATH,
            type: 'string',
            array: false,
            group: 'Form Generation',
        })
            .option('models', {
            describe: 'Model name to generate',
            type: 'string',
            array: true,
            group: 'Form Generation',
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfZm9ybXNfY29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21tYW5kcy9nZW5lcmF0ZS9mb3Jtcy9nZW5lcmF0ZV9mb3Jtc19jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUV4QixPQUFPLEVBRUwsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLHNDQUFzQyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBRXZFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxrRUFBa0UsQ0FBQztBQUduRyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQWE5RDs7R0FFRztBQUNILE1BQU0sT0FBTyxvQkFBb0I7SUFpQlo7SUFDQTtJQUNBO0lBaEJuQjs7T0FFRztJQUNNLE9BQU8sQ0FBUztJQUV6Qjs7T0FFRztJQUNNLFFBQVEsQ0FBUztJQUUxQjs7T0FFRztJQUNILFlBQ21CLHlCQUFvRCxFQUNwRCwwQkFBcUQsRUFDckQscUJBQTRDO1FBRjVDLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFDcEQsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUEyQjtRQUNyRCwwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBRTdELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxRQUFRLEdBQUcsb0JBQW9CLENBQUM7SUFDdkMsQ0FBQztJQUVELG9CQUFvQixHQUFHLEtBQUssRUFBRSxJQUFpQyxFQUFFLEVBQUU7UUFDakUsT0FBTyxNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxnQ0FBZ0MsQ0FDMUUsSUFBSSxDQUNMLENBQUM7SUFDSixDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILE9BQU8sR0FBRyxLQUFLLEVBQ2IsSUFBcUQsRUFD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aW1wb3J0IHsgQXJndW1lbnRzQ2FtZWxDYXNlLCBBcmd2LCBDb21tYW5kTW9kdWxlIH0gZnJvbSAneWFyZ3MnO1xuaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dENsaWVudCxcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yLFxuICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvZGVwbG95ZWQtYmFja2VuZC1jbGllbnQnO1xuaW1wb3J0IHsgZ3JhcGhxbE91dHB1dEtleSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7IEJhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXIgfSBmcm9tICcuLi8uLi8uLi9iYWNrZW5kLWlkZW50aWZpZXIvYmFja2VuZF9pZGVudGlmaWVyX3Jlc29sdmVyLmpzJztcbmltcG9ydCB7IERFRkFVTFRfVUlfUEFUSCB9IGZyb20gJy4uLy4uLy4uL2Zvcm0tZ2VuZXJhdGlvbi9kZWZhdWx0X2Zvcm1fZ2VuZXJhdGlvbl9vdXRwdXRfcGF0aHMuanMnO1xuaW1wb3J0IHsgRm9ybUdlbmVyYXRpb25IYW5kbGVyIH0gZnJvbSAnLi4vLi4vLi4vZm9ybS1nZW5lcmF0aW9uL2Zvcm1fZ2VuZXJhdGlvbl9oYW5kbGVyLmpzJztcbmltcG9ydCB7IEFyZ3VtZW50c0tlYmFiQ2FzZSB9IGZyb20gJy4uLy4uLy4uL2tlYmFiX2Nhc2UuanMnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuZXhwb3J0IHR5cGUgR2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zID1cbiAgQXJndW1lbnRzS2ViYWJDYXNlPEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9uc0NhbWVsQ2FzZT47XG5cbnR5cGUgR2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zQ2FtZWxDYXNlID0ge1xuICBzdGFjazogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBhcHBJZDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBicmFuY2g6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgb3V0RGlyOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIG1vZGVsczogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG59O1xuXG4vKipcbiAqIENvbW1hbmQgdGhhdCBnZW5lcmF0ZXMgVUkgZm9ybXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBHZW5lcmF0ZUZvcm1zQ29tbWFuZFxuICBpbXBsZW1lbnRzIENvbW1hbmRNb2R1bGU8b2JqZWN0LCBHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnM+XG57XG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgcmVhZG9ubHkgY29tbWFuZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgcmVhZG9ubHkgZGVzY3JpYmU6IHN0cmluZztcblxuICAvKipcbiAgICogQ3JlYXRlcyBVSSBmb3JtcyBnZW5lcmF0aW9uIGNvbW1hbmQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXI6IEJhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kT3V0cHV0Q2xpZW50QnVpbGRlcjogKCkgPT4gQmFja2VuZE91dHB1dENsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZvcm1HZW5lcmF0aW9uSGFuZGxlcjogRm9ybUdlbmVyYXRpb25IYW5kbGVyXG4gICkge1xuICAgIHRoaXMuY29tbWFuZCA9ICdmb3Jtcyc7XG4gICAgdGhpcy5kZXNjcmliZSA9ICdHZW5lcmF0ZXMgVUkgZm9ybXMnO1xuICB9XG5cbiAgZ2V0QmFja2VuZElkZW50aWZpZXIgPSBhc3luYyAoYXJnczogR2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYmFja2VuZElkZW50aWZpZXJSZXNvbHZlci5yZXNvbHZlRGVwbG95ZWRCYWNrZW5kSWRlbnRpZmllcihcbiAgICAgIGFyZ3NcbiAgICApO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgaGFuZGxlciA9IGFzeW5jIChcbiAgICBhcmdzOiBBcmd1bWVudHNDYW1lbENhc2U8R2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zPlxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCBiYWNrZW5kSWRlbnRpZmllciA9XG4gICAgICBhd2FpdCB0aGlzLmJhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXIucmVzb2x2ZURlcGxveWVkQmFja2VuZElkZW50aWZpZXIoXG4gICAgICAgIGFyZ3NcbiAgICAgICk7XG5cbiAgICBpZiAoIWJhY2tlbmRJZGVudGlmaWVyKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignQmFja2VuZElkZW50aWZpZXJSZXNvbHZlckVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiAnQ291bGQgbm90IHJlc29sdmUgdGhlIGJhY2tlbmQgaWRlbnRpZmllci4nLFxuICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICdFbnN1cmUgc3RhY2sgbmFtZSBvciBBbXBsaWZ5IEFwcCBJRCBhbmQgYnJhbmNoIHNwZWNpZmllZCBhcmUgY29ycmVjdCBhbmQgZXhpc3RzLCB0aGVuIHJlLXJ1biB0aGlzIGNvbW1hbmQuJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGJhY2tlbmRPdXRwdXRDbGllbnQgPSB0aGlzLmJhY2tlbmRPdXRwdXRDbGllbnRCdWlsZGVyKCk7XG5cbiAgICBsZXQgb3V0cHV0O1xuICAgIHRyeSB7XG4gICAgICBvdXRwdXQgPSBhd2FpdCBiYWNrZW5kT3V0cHV0Q2xpZW50LmdldE91dHB1dChiYWNrZW5kSWRlbnRpZmllcik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IuaXNCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoZXJyb3IpKSB7XG4gICAgICAgIHN3aXRjaCAoZXJyb3IuY29kZSkge1xuICAgICAgICAgIGNhc2UgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5ERVBMT1lNRU5UX0lOX1BST0dSRVNTOlxuICAgICAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgICAgICdEZXBsb3ltZW50SW5Qcm9ncmVzc0Vycm9yJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdEZXBsb3ltZW50IGlzIGN1cnJlbnRseSBpbiBwcm9ncmVzcy4nLFxuICAgICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgICAnUmUtcnVuIHRoaXMgY29tbWFuZCBvbmNlIHRoZSBkZXBsb3ltZW50IGNvbXBsZXRlcy4nLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBlcnJvclxuICAgICAgICAgICAgKTtcbiAgICAgICAgICBjYXNlIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTk9fU1RBQ0tfRk9VTkQ6XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICAgJ1N0YWNrRG9lc05vdEV4aXN0RXJyb3InLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogJ1N0YWNrIGRvZXMgbm90IGV4aXN0LicsXG4gICAgICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgICAgICdFbnN1cmUgdGhlIENsb3VkRm9ybWF0aW9uIHN0YWNrIElEIG9yIEFtcGxpZnkgQXBwIElEIGFuZCBicmFuY2ggc3BlY2lmaWVkIGFyZSBjb3JyZWN0IGFuZCBleGlzdHMsIHRoZW4gcmUtcnVuIHRoaXMgY29tbWFuZC4nLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBlcnJvclxuICAgICAgICAgICAgKTtcbiAgICAgICAgICBjYXNlIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTk9fT1VUUFVUU19GT1VORDpcbiAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICAgICAnQW1wbGlmeU91dHB1dHNOb3RGb3VuZEVycm9yJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdBbXBsaWZ5IG91dHB1dHMgbm90IGZvdW5kIGluIHN0YWNrIG1ldGFkYXRhJyxcbiAgICAgICAgICAgICAgICByZXNvbHV0aW9uOiBgRW5zdXJlIHRoZSBDbG91ZEZvcm1hdGlvbiBzdGFjayBJRCBvciBBbXBsaWZ5IEFwcCBJRCBhbmQgYnJhbmNoIHNwZWNpZmllZCBhcmUgY29ycmVjdCBhbmQgZXhpc3RzLlxuICAgICAgICBJZiB0aGlzIGlzIGEgbmV3IHNhbmRib3ggb3IgYnJhbmNoIGRlcGxveW1lbnQsIHdhaXQgZm9yIHRoZSBkZXBsb3ltZW50IHRvIGJlIHN1Y2Nlc3NmdWxseSBmaW5pc2hlZCBhbmQgdHJ5IGFnYWluLmAsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIGVycm9yXG4gICAgICAgICAgICApO1xuICAgICAgICAgIGNhc2UgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5DUkVERU5USUFMU19FUlJPUjpcbiAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICAgICAnQ3JlZGVudGlhbHNFcnJvcicsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgICAgICAgJ1VuYWJsZSB0byBnZXQgYmFja2VuZCBvdXRwdXRzIGR1ZSB0byBpbnZhbGlkIGNyZWRlbnRpYWxzLicsXG4gICAgICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgICAgICdFbnN1cmUgeW91ciBBV1MgY3JlZGVudGlhbHMgYXJlIGNvcnJlY3RseSBzZXQgYW5kIHJlZnJlc2hlZC4nLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBlcnJvclxuICAgICAgICAgICAgKTtcbiAgICAgICAgICBjYXNlIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuQUNDRVNTX0RFTklFRDpcbiAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICAgICAnQWNjZXNzRGVuaWVkRXJyb3InLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgICAgICAgICdVbmFibGUgdG8gZ2V0IGJhY2tlbmQgb3V0cHV0cyBkdWUgdG8gaW5zdWZmaWNpZW50IHBlcm1pc3Npb25zLicsXG4gICAgICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgICAgICdFbnN1cmUgeW91IGhhdmUgcGVybWlzc2lvbnMgdG8gY2FsbCBjbG91ZGZvcm1hdGlvbjpHZXRUZW1wbGF0ZVN1bW1hcnkuJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZXJyb3JcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG5cbiAgICBpZiAoIShncmFwaHFsT3V0cHV0S2V5IGluIG91dHB1dCkgfHwgIW91dHB1dFtncmFwaHFsT3V0cHV0S2V5XSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBHcmFwaFFMIEFQSSBjb25maWd1cmVkIGZvciB0aGlzIGJhY2tlbmQuJyk7XG4gICAgfVxuXG4gICAgY29uc3QgYXBpVXJsID0gb3V0cHV0W2dyYXBocWxPdXRwdXRLZXldLnBheWxvYWQuYW1wbGlmeUFwaU1vZGVsU2NoZW1hUzNVcmk7XG5cbiAgICBpZiAoIWFyZ3Mub3V0RGlyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ291dC1kaXIgbXVzdCBiZSBkZWZpbmVkJyk7XG4gICAgfVxuXG4gICAgY29uc3Qgb3V0RGlyID0gYXJncy5vdXREaXI7XG5cbiAgICBhd2FpdCB0aGlzLmZvcm1HZW5lcmF0aW9uSGFuZGxlci5nZW5lcmF0ZSh7XG4gICAgICBtb2RlbHNPdXREaXI6IHBhdGguam9pbihvdXREaXIsICdncmFwaHFsJyksXG4gICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgIHVpT3V0RGlyOiBvdXREaXIsXG4gICAgICBhcGlVcmwsXG4gICAgICBtb2RlbHNGaWx0ZXI6IGFyZ3MubW9kZWxzLFxuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8R2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zPiA9PiB7XG4gICAgcmV0dXJuIHlhcmdzXG4gICAgICAub3B0aW9uKCdzdGFjaycsIHtcbiAgICAgICAgY29uZmxpY3RzOiBbJ2FwcC1pZCcsICdicmFuY2gnXSxcbiAgICAgICAgZGVzY3JpYmU6ICdBIHN0YWNrIG5hbWUgdGhhdCBjb250YWlucyBhbiBBbXBsaWZ5IGJhY2tlbmQnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBncm91cDogJ1N0YWNrIGlkZW50aWZpZXInLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ2FwcC1pZCcsIHtcbiAgICAgICAgY29uZmxpY3RzOiBbJ3N0YWNrJ10sXG4gICAgICAgIGRlc2NyaWJlOiAnVGhlIEFtcGxpZnkgQXBwIElEIG9mIHRoZSBwcm9qZWN0JyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgaW1wbGllczogJ2JyYW5jaCcsXG4gICAgICAgIGdyb3VwOiAnUHJvamVjdCBpZGVudGlmaWVyJyxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdicmFuY2gnLCB7XG4gICAgICAgIGNvbmZsaWN0czogWydzdGFjayddLFxuICAgICAgICBkZXNjcmliZTogJ0EgZ2l0IGJyYW5jaCBvZiB0aGUgQW1wbGlmeSBwcm9qZWN0JyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgZ3JvdXA6ICdQcm9qZWN0IGlkZW50aWZpZXInLFxuICAgICAgICBpbXBsaWVzOiAnYXBwSWQnLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ291dC1kaXInLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnQSBwYXRoIHRvIGRpcmVjdG9yeSB3aGVyZSBnZW5lcmF0ZWQgZm9ybXMgYXJlIHdyaXR0ZW4uJyxcbiAgICAgICAgZGVmYXVsdDogREVGQVVMVF9VSV9QQVRILFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBncm91cDogJ0Zvcm0gR2VuZXJhdGlvbicsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignbW9kZWxzJywge1xuICAgICAgICBkZXNjcmliZTogJ01vZGVsIG5hbWUgdG8gZ2VuZXJhdGUnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IHRydWUsXG4gICAgICAgIGdyb3VwOiAnRm9ybSBHZW5lcmF0aW9uJyxcbiAgICAgIH0pO1xuICB9O1xufVxuIl19