import _isCI from 'is-ci';
import { ClientConfigFormat, ClientConfigVersionOption, DEFAULT_CLIENT_CONFIG_VERSION, } from '@aws-amplify/client-config';
import { AmplifyUserError } from '@aws-amplify/platform-core';
import { format } from '@aws-amplify/cli-core';
/**
 * An entry point for deploy command.
 */
export class PipelineDeployCommand {
    clientConfigGenerator;
    backendDeployer;
    isCiEnvironment;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    /**
     * Creates top level entry point for deploy command.
     */
    constructor(clientConfigGenerator, backendDeployer, isCiEnvironment = _isCI) {
        this.clientConfigGenerator = clientConfigGenerator;
        this.backendDeployer = backendDeployer;
        this.isCiEnvironment = isCiEnvironment;
        this.command = 'pipeline-deploy';
        this.describe =
            'Command to deploy backends in a custom CI/CD pipeline. This command is not intended to be used locally.';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        if (!this.isCiEnvironment) {
            throw new AmplifyUserError('RunningPipelineDeployNotInCiError', {
                message: 'It looks like this command is being run outside of a CI/CD workflow.',
                resolution: `To deploy locally use ${format.normalizeAmpxCommand('sandbox')} instead.`,
            });
        }
        const backendId = {
            namespace: args.appId,
            name: args.branch,
            type: 'branch',
        };
        await this.backendDeployer.deploy(backendId, {
            validateAppSources: true,
        });
        await this.clientConfigGenerator.generateClientConfigToFile(backendId, args.outputsVersion, args.outputsOutDir, args.outputsFormat);
    };
    builder = (yargs) => {
        return yargs
            .version(false)
            .option('branch', {
            describe: 'Name of the git branch being deployed',
            demandOption: true,
            type: 'string',
            array: false,
        })
            .option('app-id', {
            describe: 'The app id of the target Amplify app',
            demandOption: true,
            type: 'string',
            array: false,
        })
            .option('outputs-out-dir', {
            describe: 'A path to directory where amplify_outputs is written. If not provided defaults to current process working directory.',
            type: 'string',
            array: false,
        })
            .option('outputs-version', {
            describe: 'Version of the configuration. Version 0 represents classic amplify-cli config file amplify-configuration and 1 represents newer config file amplify_outputs',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigVersionOption),
            default: DEFAULT_CLIENT_CONFIG_VERSION,
        })
            .option('outputs-format', {
            describe: 'amplify_outputs file format',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigFormat),
        })
            .check(async (argv) => {
            if (argv['branch'].length === 0 || argv['app-id'].length === 0) {
                throw new AmplifyUserError('InvalidCommandInputError', {
                    message: 'Invalid --branch or --app-id',
                    resolution: '--branch and --app-id must be at least 1 character',
                });
            }
            return true;
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmVfZGVwbG95X2NvbW1hbmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tbWFuZHMvcGlwZWxpbmUtZGVwbG95L3BpcGVsaW5lX2RlcGxveV9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQU0xQixPQUFPLEVBQ0wsa0JBQWtCLEVBRWxCLHlCQUF5QixFQUN6Qiw2QkFBNkIsR0FDOUIsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFhL0M7O0dBRUc7QUFDSCxNQUFNLE9BQU8scUJBQXFCO0lBaUJiO0lBQ0E7SUFDQTtJQWhCbkI7O09BRUc7SUFDTSxPQUFPLENBQVM7SUFFekI7O09BRUc7SUFDTSxRQUFRLENBQVM7SUFFMUI7O09BRUc7SUFDSCxZQUNtQixxQkFBbUQsRUFDbkQsZUFBZ0MsRUFDaEMsa0JBQWdDLEtBQUs7UUFGckMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUE4QjtRQUNuRCxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsb0JBQWUsR0FBZixlQUFlLENBQXNCO1FBRXRELElBQUksQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUM7UUFDakMsSUFBSSxDQUFDLFFBQVE7WUFDWCx5R0FBeUcsQ0FBQztJQUM5RyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQUFPLEdBQUcsS0FBSyxFQUNiLElBQXNELEVBQ3ZDLEVBQUU7UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDekIsTUFBTSxJQUFJLGdCQUFnQixDQUFDLG1DQUFtQyxFQUFFO2dCQUM5RCxPQUFPLEVBQ0wsc0VBQXNFO2dCQUN4RSxVQUFVLEVBQUUseUJBQXlCLE1BQU0sQ0FBQyxvQkFBb0IsQ0FDOUQsU0FBUyxDQUNWLFdBQVc7YUFDYixDQUFDLENBQUM7U0FDSjtRQUVELE1BQU0sU0FBUyxHQUFzQjtZQUNuQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDckIsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNO1lBQ2pCLElBQUksRUFBRSxRQUFRO1NBQ2YsQ0FBQztRQUNGLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFO1lBQzNDLGtCQUFrQixFQUFFLElBQUk7U0FDekIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsMEJBQTBCLENBQ3pELFNBQVMsRUFDVCxJQUFJLENBQUMsY0FBcUMsRUFDMUMsSUFBSSxDQUFDLGFBQWEsRUFDbEIsSUFBSSxDQUFDLGFBQWEsQ0FDbkIsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGLE9BQU8sR0FBRyxDQUFDLEtBQVcsRUFBc0MsRUFBRTtRQUM1RCxPQUFPLEtBQUs7YUFDVCxPQUFPLENBQUMsS0FBSyxDQUFDO2FBQ2QsTUFBTSxDQUFDLFFBQVEsRUFBRTtZQUNoQixRQUFRLEVBQUUsdUNBQXVDO1lBQ2pELFlBQVksRUFBRSxJQUFJO1lBQ2xCLElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7U0FDYixDQUFDO2FBQ0QsTUFBTSxDQUFDLFFBQVEsRUFBRTtZQUNoQixRQUFRLEVBQUUsc0NBQXNDO1lBQ2hELFlBQVksRUFBRSxJQUFJO1lBQ2xCLElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7U0FDYixDQUFDO2FBQ0QsTUFBTSxDQUFDLGlCQUFpQixFQUFFO1lBQ3pCLFFBQVEsRUFDTixzSEFBc0g7WUFDeEgsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztTQUNiLENBQUM7YUFDRCxNQUFNLENBQUMsaUJBQWlCLEVBQUU7WUFDekIsUUFBUSxFQUNOLDZKQUE2SjtZQUMvSixJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1lBQ1osT0FBTyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMseUJBQXlCLENBQUM7WUFDakQsT0FBTyxFQUFFLDZCQUE2QjtTQUN2QyxDQUFDO2FBQ0QsTUFBTSxDQUFDLGdCQUFnQixFQUFFO1lBQ3hCLFFBQVEsRUFBRSw2QkFBNkI7WUFDdkMsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLE9BQU8sRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDO1NBQzNDLENBQUM7YUFDRCxLQUFLLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3BCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQzlELE1BQU0sSUFBSSxnQkFBZ0IsQ0FBQywwQkFBMEIsRUFBRTtvQkFDckQsT0FBTyxFQUFFLDhCQUE4QjtvQkFDdkMsVUFBVSxFQUFFLG9EQUFvRDtpQkFDakUsQ0FBQyxDQUFDO2FBQ0o7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgX2lzQ0kgZnJvbSAnaXMtY2knO1xuaW1wb3J0IHsgQXJndW1lbnRzQ2FtZWxDYXNlLCBBcmd2LCBDb21tYW5kTW9kdWxlIH0gZnJvbSAneWFyZ3MnO1xuaW1wb3J0IHsgQmFja2VuZERlcGxveWVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtZGVwbG95ZXInO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlciB9IGZyb20gJy4uLy4uL2NsaWVudC1jb25maWcvY2xpZW50X2NvbmZpZ19nZW5lcmF0b3JfYWRhcHRlci5qcyc7XG5pbXBvcnQgeyBBcmd1bWVudHNLZWJhYkNhc2UgfSBmcm9tICcuLi8uLi9rZWJhYl9jYXNlLmpzJztcbmltcG9ydCB7IEJhY2tlbmRJZGVudGlmaWVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBDbGllbnRDb25maWdGb3JtYXQsXG4gIENsaWVudENvbmZpZ1ZlcnNpb24sXG4gIENsaWVudENvbmZpZ1ZlcnNpb25PcHRpb24sXG4gIERFRkFVTFRfQ0xJRU5UX0NPTkZJR19WRVJTSU9OLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvY2xpZW50LWNvbmZpZyc7XG5pbXBvcnQgeyBBbXBsaWZ5VXNlckVycm9yIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NsaS1jb3JlJztcblxuZXhwb3J0IHR5cGUgUGlwZWxpbmVEZXBsb3lDb21tYW5kT3B0aW9ucyA9XG4gIEFyZ3VtZW50c0tlYmFiQ2FzZTxQaXBlbGluZURlcGxveUNvbW1hbmRPcHRpb25zQ2FtZWxDYXNlPjtcblxudHlwZSBQaXBlbGluZURlcGxveUNvbW1hbmRPcHRpb25zQ2FtZWxDYXNlID0ge1xuICBicmFuY2g6IHN0cmluZztcbiAgYXBwSWQ6IHN0cmluZztcbiAgb3V0cHV0c0Zvcm1hdDogQ2xpZW50Q29uZmlnRm9ybWF0IHwgdW5kZWZpbmVkO1xuICBvdXRwdXRzVmVyc2lvbjogc3RyaW5nO1xuICBvdXRwdXRzT3V0RGlyPzogc3RyaW5nO1xufTtcblxuLyoqXG4gKiBBbiBlbnRyeSBwb2ludCBmb3IgZGVwbG95IGNvbW1hbmQuXG4gKi9cbmV4cG9ydCBjbGFzcyBQaXBlbGluZURlcGxveUNvbW1hbmRcbiAgaW1wbGVtZW50cyBDb21tYW5kTW9kdWxlPG9iamVjdCwgUGlwZWxpbmVEZXBsb3lDb21tYW5kT3B0aW9ucz5cbntcbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBjb21tYW5kOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBkZXNjcmliZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIHRvcCBsZXZlbCBlbnRyeSBwb2ludCBmb3IgZGVwbG95IGNvbW1hbmQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNsaWVudENvbmZpZ0dlbmVyYXRvcjogQ2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJhY2tlbmREZXBsb3llcjogQmFja2VuZERlcGxveWVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgaXNDaUVudmlyb25tZW50OiB0eXBlb2YgX2lzQ0kgPSBfaXNDSVxuICApIHtcbiAgICB0aGlzLmNvbW1hbmQgPSAncGlwZWxpbmUtZGVwbG95JztcbiAgICB0aGlzLmRlc2NyaWJlID1cbiAgICAgICdDb21tYW5kIHRvIGRlcGxveSBiYWNrZW5kcyBpbiBhIGN1c3RvbSBDSS9DRCBwaXBlbGluZS4gVGhpcyBjb21tYW5kIGlzIG5vdCBpbnRlbmRlZCB0byBiZSB1c2VkIGxvY2FsbHkuJztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgaGFuZGxlciA9IGFzeW5jIChcbiAgICBhcmdzOiBBcmd1bWVudHNDYW1lbENhc2U8UGlwZWxpbmVEZXBsb3lDb21tYW5kT3B0aW9ucz5cbiAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgaWYgKCF0aGlzLmlzQ2lFbnZpcm9ubWVudCkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ1J1bm5pbmdQaXBlbGluZURlcGxveU5vdEluQ2lFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAnSXQgbG9va3MgbGlrZSB0aGlzIGNvbW1hbmQgaXMgYmVpbmcgcnVuIG91dHNpZGUgb2YgYSBDSS9DRCB3b3JrZmxvdy4nLFxuICAgICAgICByZXNvbHV0aW9uOiBgVG8gZGVwbG95IGxvY2FsbHkgdXNlICR7Zm9ybWF0Lm5vcm1hbGl6ZUFtcHhDb21tYW5kKFxuICAgICAgICAgICdzYW5kYm94J1xuICAgICAgICApfSBpbnN0ZWFkLmAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBiYWNrZW5kSWQ6IEJhY2tlbmRJZGVudGlmaWVyID0ge1xuICAgICAgbmFtZXNwYWNlOiBhcmdzLmFwcElkLFxuICAgICAgbmFtZTogYXJncy5icmFuY2gsXG4gICAgICB0eXBlOiAnYnJhbmNoJyxcbiAgICB9O1xuICAgIGF3YWl0IHRoaXMuYmFja2VuZERlcGxveWVyLmRlcGxveShiYWNrZW5kSWQsIHtcbiAgICAgIHZhbGlkYXRlQXBwU291cmNlczogdHJ1ZSxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLmNsaWVudENvbmZpZ0dlbmVyYXRvci5nZW5lcmF0ZUNsaWVudENvbmZpZ1RvRmlsZShcbiAgICAgIGJhY2tlbmRJZCxcbiAgICAgIGFyZ3Mub3V0cHV0c1ZlcnNpb24gYXMgQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgICAgIGFyZ3Mub3V0cHV0c091dERpcixcbiAgICAgIGFyZ3Mub3V0cHV0c0Zvcm1hdFxuICAgICk7XG4gIH07XG5cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8UGlwZWxpbmVEZXBsb3lDb21tYW5kT3B0aW9ucz4gPT4ge1xuICAgIHJldHVybiB5YXJnc1xuICAgICAgLnZlcnNpb24oZmFsc2UpXG4gICAgICAub3B0aW9uKCdicmFuY2gnLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnTmFtZSBvZiB0aGUgZ2l0IGJyYW5jaCBiZWluZyBkZXBsb3llZCcsXG4gICAgICAgIGRlbWFuZE9wdGlvbjogdHJ1ZSxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdhcHAtaWQnLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnVGhlIGFwcCBpZCBvZiB0aGUgdGFyZ2V0IEFtcGxpZnkgYXBwJyxcbiAgICAgICAgZGVtYW5kT3B0aW9uOiB0cnVlLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ291dHB1dHMtb3V0LWRpcicsIHtcbiAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgJ0EgcGF0aCB0byBkaXJlY3Rvcnkgd2hlcmUgYW1wbGlmeV9vdXRwdXRzIGlzIHdyaXR0ZW4uIElmIG5vdCBwcm92aWRlZCBkZWZhdWx0cyB0byBjdXJyZW50IHByb2Nlc3Mgd29ya2luZyBkaXJlY3RvcnkuJyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdvdXRwdXRzLXZlcnNpb24nLCB7XG4gICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICdWZXJzaW9uIG9mIHRoZSBjb25maWd1cmF0aW9uLiBWZXJzaW9uIDAgcmVwcmVzZW50cyBjbGFzc2ljIGFtcGxpZnktY2xpIGNvbmZpZyBmaWxlIGFtcGxpZnktY29uZmlndXJhdGlvbiBhbmQgMSByZXByZXNlbnRzIG5ld2VyIGNvbmZpZyBmaWxlIGFtcGxpZnlfb3V0cHV0cycsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGNob2ljZXM6IE9iamVjdC52YWx1ZXMoQ2xpZW50Q29uZmlnVmVyc2lvbk9wdGlvbiksXG4gICAgICAgIGRlZmF1bHQ6IERFRkFVTFRfQ0xJRU5UX0NPTkZJR19WRVJTSU9OLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ291dHB1dHMtZm9ybWF0Jywge1xuICAgICAgICBkZXNjcmliZTogJ2FtcGxpZnlfb3V0cHV0cyBmaWxlIGZvcm1hdCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGNob2ljZXM6IE9iamVjdC52YWx1ZXMoQ2xpZW50Q29uZmlnRm9ybWF0KSxcbiAgICAgIH0pXG4gICAgICAuY2hlY2soYXN5bmMgKGFyZ3YpID0+IHtcbiAgICAgICAgaWYgKGFyZ3ZbJ2JyYW5jaCddLmxlbmd0aCA9PT0gMCB8fCBhcmd2WydhcHAtaWQnXS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZENvbW1hbmRJbnB1dEVycm9yJywge1xuICAgICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgLS1icmFuY2ggb3IgLS1hcHAtaWQnLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjogJy0tYnJhbmNoIGFuZCAtLWFwcC1pZCBtdXN0IGJlIGF0IGxlYXN0IDEgY2hhcmFjdGVyJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pO1xuICB9O1xufVxuIl19